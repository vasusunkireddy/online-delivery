<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex, nofollow">
  <title>Delicute - User Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #a855f7, #ec4899);
      --secondary-gradient: linear-gradient(135deg, #6b7280, #9ca3af);
      --text-dark: #1e293b;
      --text-light: #f1f5f9;
      --card-bg: rgba(255, 255, 255, 0.95);
      --card-bg-dark: rgba(17, 24, 39, 0.95);
      --modal-bg: rgba(255, 255, 255, 0.98);
      --modal-bg-dark: rgba(17, 24, 39, 0.95);
    }

    body {
      background: linear-gradient(135deg, #f3e8ff, #bfdbfe);
      font-family: 'Poppins', sans-serif;
      color: var(--text-dark);
      margin: 0;
      overflow-x: hidden;
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
    }

    .dashboard-bg {
      position: relative;
      background: url('https://images.unsplash.com/photo-1515003197210-e0cd71810b5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') no-repeat center center/cover;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .dashboard-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.3));
      z-index: 1;
    }

    .dashboard-content {
      position: relative;
      z-index: 2;
      max-width: 1280px;
      margin: 2rem auto;
      padding: 1.5rem;
    }

    .header {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 1.25rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 50;
      margin: 1rem;
    }

    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      font-weight: 700;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: transform 0.3s ease;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    .nav-links {
      display: flex;
      gap: 1.5rem;
    }

    .nav-link {
      font-family: 'Poppins', sans-serif;
      font-size: 1.25rem;
      color: #ffffff;
      padding: 0.75rem 1.5rem;
      transition: color 0.3s ease;
      cursor: pointer;
    }

    .nav-link:hover {
      color: #ec4899;
    }

    .hamburger {
      display: none;
      flex-direction: column;
      gap: 0.25rem;
      cursor: pointer;
    }

    .hamburger span {
      width: 1.5rem;
      height: 3px;
      background: #ffffff;
      transition: all 0.3s ease;
    }

    .hamburger.active span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }

    .hamburger.active span:nth-child(2) {
      opacity: 0;
    }

    .hamburger.active span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    .profile-dropdown {
      position: relative;
    }

    .profile-img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .profile-img:hover {
      transform: scale(1.1);
    }

    .dropdown-menu {
      position: absolute;
      top: 60px;
      right: 0;
      background: var(--modal-bg);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 0.75rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      min-width: 200px;
      z-index: 100;
      display: none;
      animation: dropdownFade 0.3s ease;
    }

    .dropdown-menu.show {
      display: block;
    }

    @keyframes dropdownFade {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dropdown-item {
      padding: 1rem 1.5rem;
      color: var(--text-dark);
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .dropdown-item:hover {
      background: var(--primary-gradient);
      color: #ffffff;
    }

    .hero-section {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 1.5rem;
      padding: 3rem 2rem;
      text-align: center;
      margin-bottom: 2rem;
      animation: float 5s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 1.25rem;
      padding: 2rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
      margin-bottom: 1.5rem;
    }

    .card:hover {
      transform: translateY(-4px);
    }

    .btn-primary {
      background: var(--primary-gradient);
      color: #ffffff;
      padding: 0.75rem 2rem;
      border-radius: 9999px;
      font-size: 1rem;
      font-weight: 500;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      touch-action: manipulation;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-primary:disabled {
      background: var(--secondary-gradient);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: var(--secondary-gradient);
      color: #ffffff;
      padding: 0.5rem 1.5rem;
      border-radius: 9999px;
      font-size: 0.9rem;
      font-weight: 500;
      transition: transform 0.3s ease;
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
    }

    .btn-quantity {
      background: rgba(255, 255, 255, 0.4);
      color: #a855f7;
      padding: 0.5rem;
      border-radius: 0.5rem;
      font-size: 1.25rem;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    .btn-quantity:hover:not(:disabled) {
      background: rgba(168, 85, 247, 0.3);
      transform: scale(1.05);
    }

    .btn-quantity:disabled {
      background: rgba(255, 255, 255, 0.2);
      color: #9ca3af;
      cursor: not-allowed;
    }

    .input-field {
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 0.5rem;
      padding: 1rem;
      width: 100%;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .input-field:focus {
      border-color: #a855f7;
      outline: none;
    }

    .input-field.valid {
      border-color: #10b981;
    }

    .input-field.invalid {
      border-color: #ef4444;
    }

    .search-bar {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 9999px;
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .search-bar input {
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-dark);
      font-size: 1rem;
      width: 100%;
    }

    .search-bar input::placeholder {
      color: #6b7280;
    }

    .category-filter {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 9999px;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      width: 100%;
      max-width: 12rem;
    }

    .toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 0.75rem 1.25rem;
      border-radius: 0.5rem;
      color: #ffffff;
      font-size: 0.9rem;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      animation: toastSlide 3.5s ease-in-out forwards;
    }

    .toast-success {
      background: linear-gradient(135deg, #10b981, #34d399);
    }

    .toast-error {
      background: linear-gradient(135deg, #ef4444, #f87171);
    }

    .toast::before {
      content: '';
      width: 1rem;
      height: 1rem;
      background-size: cover;
    }

    .toast-success::before {
      background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white"%3E%3Cpath stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /%3E%3C/svg%3E');
    }

    .toast-error::before {
      background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white"%3E%3Cpath stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /%3E%3C/svg%3E');
    }

    @keyframes toastSlide {
      0% { opacity: 0; transform: translateY(-20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: var(--modal-bg);
      padding: 2rem;
      border-radius: 1.25rem;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      animation: modalPop 0.3s ease forwards;
      position: relative;
    }

    .profile-modal-content {
      padding: 3rem;
      max-width: 500px;
      border-radius: 1.5rem;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(240, 240, 245, 0.98));
    }

    .profile-modal-content img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 1rem;
      display: block;
      border: 3px solid #a855f7;
    }

    @keyframes modalPop {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .close-btn {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
      transition: color 0.3s ease;
    }

    .close-btn:hover {
      color: #a855f7;
    }

    .order-card, .menu-card, .favorite-card, .coupon-card {
      background: var(--card-bg);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .order-card:hover, .menu-card:hover, .favorite-card:hover, .coupon-card:hover {
      transform: translateY(-3px);
    }

    .order-card.loading, .cart-items.loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .error-message {
      color: #ef4444;
      font-size: 0.8rem;
      margin-top: 0.25rem;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .dark-mode {
      background: linear-gradient(135deg, #1e293b, #374151);
      color: var(--text-light);
    }

    .dark-mode .dashboard-bg::before {
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.5));
    }

    .dark-mode .card, .dark-mode .modal-content, .dark-mode .dropdown-menu, .dark-mode .order-card, .dark-mode .menu-card, .dark-mode .favorite-card, .dark-mode .coupon-card {
      background: var(--card-bg-dark);
      color: var(--text-light);
    }

    .dark-mode .profile-modal-content {
      background: linear-gradient(145deg, rgba(17, 24, 39, 0.95), rgba(30, 41, 59, 0.95));
    }

    .dark-mode .input-field {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-light);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .dark-mode .input-field.valid {
      border-color: #34d399;
    }

    .dark-mode .input-field.invalid {
      border-color: #f87171;
    }

    .dark-mode .search-bar, .dark-mode .category-filter {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
      color: var(--text-light);
    }

    .dark-mode .search-bar input {
      border: none;
      outline: none;
      color: var(--text-light);
      font-size: 1rem;
      width: 100%;
    }

    .dark-mode .search-bar input::placeholder {
      color: #9ca3af;
    }

    .dark-mode .btn-quantity {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-light);
    }

    .dark-mode .btn-quantity:disabled {
      background: rgba(255, 255, 255, 0.05);
      color: #6b7280;
    }

    .dark-mode .btn-quantity:hover:not(:disabled) {
      background: rgba(168, 85, 247, 0.2);
    }

    .dark-mode .error-message {
      color: #f87171;
    }

    .tracking-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .tracking-step {
      flex: 1;
      text-align: center;
      padding: 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.8rem;
      transition: background 0.3s ease;
    }

    .tracking-step.active {
      background: var(--primary-gradient);
      color: #ffffff;
    }

    .tracking-step.inactive {
      background: rgba(255, 255, 255, 0.4);
      color: #6b7280;
    }

    .dark-mode .tracking-step.inactive {
      background: rgba(255, 255, 255, 0.1);
      color: #9ca3af;
    }

    @media (max-width: 640px) {
      .dashboard-content {
        margin: 1rem auto;
        padding: 0.75rem;
      }

      .header {
        margin: 0.5rem;
        padding: 0.5rem;
        border-radius: 0.75rem;
      }

      .nav-links {
        display: none;
        flex-direction: column;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 0 0 0.75rem 0.75rem;
        padding: 0.75rem;
        z-index: 49;
      }

      .nav-links.active {
        display: flex;
      }

      .hamburger {
        display: flex;
      }

      .logo {
        font-size: 1.25rem;
      }

      .nav-link {
        font-size: 0.9rem;
        padding: 0.5rem;
      }

      .profile-img {
        width: 32px;
        height: 32px;
      }

      .dropdown-menu {
        min-width: 140px;
        top: 40px;
      }

      .dropdown-item {
        font-size: 0.85rem;
        padding: 0.75rem 1rem;
      }

      .hero-section {
        padding: 1.5rem 1rem;
        margin-bottom: 1rem;
      }

      .hero-section h2 {
        font-size: 1.5rem;
      }

      .hero-section p {
        font-size: 0.9rem;
      }

      .card {
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.75rem;
      }

      .card h2 {
        font-size: 1.25rem;
      }

      .menu-card img {
        height: 140px;
      }

      .menu-card h3, .coupon-card h3, .favorite-card h3, .order-card h3 {
        font-size: 1rem;
      }

      .btn-primary {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
      }

      .btn-secondary {
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
      }

      .btn-quantity {
        width: 2rem;
        height: 2rem;
        font-size: 1rem;
      }

      .modal-content {
        padding: 1rem;
        max-width: 90%;
        border-radius: 0.75rem;
      }

      .profile-modal-content {
        padding: 1.5rem;
      }

      .profile-modal-content img {
        width: 80px;
        height: 80px;
      }

      .modal-content h2 {
        font-size: 1.25rem;
      }

      .input-field {
        padding: 0.75rem;
        font-size: 0.85rem;
      }

      .search-bar {
        padding: 0.5rem 1rem;
      }

      .search-bar input {
        font-size: 0.85rem;
      }

      .category-filter {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
      }

      .tracking-bar {
        flex-direction: column;
        gap: 0.25rem;
      }

      .tracking-step {
        font-size: 0.7rem;
        padding: 0.25rem;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-bg">
    <div class="dashboard-content" id="dashboard-content">
      <div class="header">
        <div class="logo">
          <img src="https://i.postimg.cc/zv19J0xv/Zbhz-Fq-T-Imgur.jpg" alt="Delicute Logo" class="w-10 h-10 rounded-full border-2 border-white">
          <span>Delicute</span>
        </div>
        <div class="flex items-center gap-4">
          <div class="nav-links" id="navLinks">
            <div class="nav-link" onclick="utils.scrollToSection('dashboard-content')">Home</div>
            <div class="nav-link" onclick="utils.scrollToSection('myOrders')">My Orders</div>
            <div class="nav-link" onclick="utils.scrollToSection('orders')">Order History</div>
            <div class="nav-link" onclick="utils.scrollToSection('menuSection')">Menu</div>
          </div>
          <div class="profile-dropdown">
            <img src="https://res.cloudinary.com/do9cbfu5l/image/upload/v1750187399/delicute/profile/default.jpg" alt="Profile Image" class="profile-img" id="profileImg" onclick="ui.toggleDropdown()">
            <div class="dropdown-menu" id="profileDropdown">
              <div class="dropdown-item" onclick="utils.scrollToSection('dashboard-content')">Home</div>
              <div class="dropdown-item" onclick="utils.scrollToSection('myOrders')">My Orders</div>
              <div class="dropdown-item" onclick="utils.scrollToSection('orders')">Order History</div>
              <div class="dropdown-item" onclick="ui.openModal('profileModal')">Edit Profile</div>
              <div class="dropdown-item" onclick="ui.openModal('addressModal')">Manage Addresses</div>
              <div class="dropdown-item" onclick="ui.openModal('favoritesModal')">Favorites</div>
              <div class="dropdown-item" onclick="ui.openModal('cartModal')">Cart</div>
              <div class="dropdown-item" onclick="ui.toggleDarkMode()">Toggle Dark Mode</div>
              <div class="dropdown-item" onclick="data.logout()">Logout</div>
            </div>
          </div>
          <div class="hamburger" id="hamburger" onclick="ui.toggleNav()">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>

      <div class="hero-section">
        <h2 class="text-2xl md:text-3xl font-semibold mb-2 text-black" style="font-family: 'Playfair Display', serif;">Welcome, <span id="userName">User</span>!</h2>
        <p class="text-base md:text-lg text-black mb-2">Total Orders: <span id="totalOrders">0</span></p>
        <p class="text-base md:text-lg text-black mb-3">"EVERY BITE TELLS A STORY!"</p>
        <button class="btn-primary" onclick="utils.scrollToSection('menuSection')">Explore Menu</button>
      </div>

      <div class="card" id="myOrders">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-xl md:text-2xl font-semibold text-gray-800" style="font-family: 'Playfair Display', serif;">My Orders</h2>
          <button class="btn-secondary text-sm py-1 px-3" onclick="data.refreshOrders()">Refresh</button>
        </div>
        <div id="activeOrders"></div>
      </div>

      <div class="card" id="menuSection">
        <h2 class="text-xl md:text-2xl font-semibold mb-3 text-gray-800" style="font-family: 'Playfair Display', serif;">Our Menu</h2>
        <div class="flex flex-col sm:flex-row justify-between items-center mb-3 gap-2">
          <div class="search-bar w-full sm:w-1/2 max-w-sm">
            <svg class="w-5 h-5 text-gray-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input type="text" id="menuSearch" placeholder="Search menu..." onkeyup="debounceSearch()">
          </div>
          <select id="categoryFilter" class="category-filter" onchange="data.filterCategory()">
            <option value="">All Categories</option>
            <option value="starter">Starters</option>
            <option value="main">Main Dishes</option>
            <option value="dessert">Desserts</option>
            <option value="beverage">Beverages</option>
          </select>
        </div>
        <div id="menuItems" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
      </div>

      <div class="card" id="couponsSection">
        <h2 class="text-xl md:text-2xl font-semibold mb-3 text-gray-800" style="font-family: 'Playfair Display', serif;">Exclusive Offers</h2>
        <div id="couponsList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
      </div>

      <div class="card" id="favoritesSection">
        <h2 class="text-xl md:text-2xl font-semibold mb-3 text-gray-800" style="font-family: 'Playfair Display', serif;">Your Favorites</h2>
        <div id="favoritesList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
      </div>

      <div class="card" id="orders">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-xl md:text-2xl font-semibold text-gray-800" style="font-family: 'Playfair Display', serif;">Order History</h2>
          <button class="btn-secondary text-sm py-1 px-3" onclick="data.clearCart()">Clear Cart</button>
        </div>
        <div id="orderHistory"></div>
      </div>
    </div>

    <div id="profileModal" class="modal">
      <div class="modal-content profile-modal-content">
        <span class="close-btn" onclick="ui.closeModal('profileModal')">×</span>
        <img src="https://res.cloudinary.com/do9cbfu5l/image/upload/v1750187399/delicute/profile/default.jpg" alt="Profile Image" id="profileModalImg">
        <h2 class="text-xl md:text-2xl font-semibold mb-3 text-center" style="font-family: 'Playfair Display', serif;">Edit Profile</h2>
        <div class="mb-3">
          <label class="block text-gray-700 mb-1 text-sm" for="profileName">Name *</label>
          <input type="text" id="profileName" class="input-field" placeholder="Enter your name" required>
        </div>
        <div class="mb-3">
          <label class="block text-gray-700 mb-1 text-sm" for="profileEmail">Email *</label>
          <input type="email" id="profileEmail" class="input-field" placeholder="Enter your email" required>
        </div>
        <div class="mb-3">
          <label class="block text-gray-700 mb-1 text-sm" for="profileMobile">Mobile Number *</label>
          <input type="tel" id="profileMobile" class="input-field bg-gray-100" readonly>
        </div>
        <div class="mb-3">
          <label class="block text-gray-700 mb-1 text-sm" for="profileImage">Profile Image (JPEG/PNG, max 2MB)</label>
          <input type="file" id="profileImage" accept="image/jpeg,image/png" class="input-field">
          <p class="error-message" id="profileImageError"></p>
        </div>
        <button class="btn-primary w-full" onclick="data.updateProfile()">Save Changes</button>
      </div>
    </div>

    <div id="addressModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="ui.closeModal('addressModal')">×</span>
        <h2 class="text-xl md:text-2xl font-semibold mb-3 text-center" style="font-family: 'Playfair Display', serif;">Manage Addresses</h2>
        <div id="addressList" class="mb-3"></div>
        <h3 class="text-lg font-semibold mb-2 text-gray-800" id="addressFormTitle">Add New Address</h3>
        <form id="addressForm">
          <input type="hidden" id="addressId">
          <div class="mb-3">
            <label class="block text-gray-700 mb-1 text-sm" for="addressFullName">Full Name *</label>
            <input type="text" id="addressFullName" class="input-field" placeholder="Enter full name" required>
          </div>
          <div class="mb-3">
            <label class="block text-gray-700 mb-1 text-sm" for="addressMobile">Mobile Number *</label>
            <input type="tel" id="addressMobile" class="input-field" placeholder="Enter mobile number" required>
          </div>
          <div class="mb-3">
            <label class="block text-gray-700 mb-1 text-sm" for="addressHouseNo">House/Flat No. *</label>
            <input type="text" id="addressHouseNo" class="input-field" placeholder="Enter house/flat no." required>
          </div>
          <div class="mb-3">
            <label class="block text-gray-700 mb-1 text-sm" for="addressLocation">Location/Street *</label>
            <input type="text" id="addressLocation" class="input-field" placeholder="Enter location/street" required>
          </div>
          <div class="mb-3">
            <label class="block text-gray-700 mb-1 text-sm" for="addressLandmark">Landmark (Optional)</label>
            <input type="text" id="addressLandmark" class="input-field" placeholder="Enter landmark">
          </div>
          <button type="submit" class="btn-primary w-full" id="addressSubmitBtn">Add Address</button>
        </form>
      </div>
    </div>

    <div id="favoritesModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="ui.closeModal('favoritesModal')">×</span>
        <h2 class="text-xl md:text-2xl font-semibold mb-3 text-center" style="font-family: 'Playfair Display', serif;">Your Favorites</h2>
        <div id="favoritesModalList" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
      </div>
    </div>

    <div id="cartModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="ui.closeModal('cartModal')">×</span>
        <h2 class="text-xl md:text-2xl font-semibold mb-3 text-center" style="font-family: 'Playfair Display', serif;">Your Cart</h2>
        <div id="cartItems" class="mb-3 cart-items"></div>
        <div class="flex justify-between items-center mb-3">
          <button class="btn-secondary text-sm py-1 px-3" onclick="data.clearCart()">Clear Cart</button>
        </div>
        <div class="mb-3">
          <label class="block text-gray-700 mb-1 text-sm" for="cartAddressSelect">Select Address *</label>
          <select id="cartAddressSelect" class="input-field" required>
            <option value="">Select Address</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="block text-gray-700 mb-1 text-sm" for="couponCode">Apply Coupon</label>
          <div class="flex gap-2">
            <input type="text" id="couponCode" class="input-field" placeholder="Enter coupon code" oninput="data.validateCouponInput()">
            <button class="btn-primary px-4" onclick="data.applyCoupon()">Apply</button>
          </div>
          <p class="error-message" id="couponError"></p>
        </div>
        <div class="mb-3">
          <p class="text-gray-600 mb-1 text-sm">Subtotal: ₹<span id="cartOriginalTotal">0</span></p>
          <p class="text-green-600 mb-1 text-sm">Discount: ₹<span id="cartDiscount">0</span></p>
          <p class="text-green-600 mb-1 text-sm">Delivery: ₹<span id="cartDelivery">0</span> (Free Delivery)</p>
          <p class="text-lg font-bold text-gray-800 mb-3">Final Total: ₹<span id="cartFinalTotal">0</span></p>
        </div>
        <p class="text-red-600 mb-3 text-sm text-center">Note: All UPI payments will be available soon. Thank you.</p>
        <button class="btn-primary w-full" id="placeOrderBtn" onclick="data.placeOrder('cod')">Place Order (COD)</button>
      </div>
    </div>

    <div id="cancelOrderModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="ui.closeModal('cancelOrderModal')">×</span>
        <h2 class="text-xl md:text-2xl font-semibold mb-3 text-center" style="font-family: 'Playfair Display', serif;">Cancel Order</h2>
        <p class="text-gray-600 mb-3">Please provide a reason for cancellation:</p>
        <form id="cancelOrderForm">
          <input type="hidden" id="cancelOrderId">
          <div class="mb-3">
            <label class="block text-gray-700 mb-1 text-sm" for="cancelReason">Reason *</label>
            <textarea id="cancelReason" class="input-field" rows="4" placeholder="Enter reason for cancellation" required></textarea>
          </div>
          <button type="submit" class="btn-primary w-full">Submit Cancellation</button>
        </form>
      </div>
    </div>

    <div id="trackOrderModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="ui.closeModal('trackOrderModal')">×</span>
        <h2 class="text-xl md:text-2xl font-semibold mb-3 text-center" style="font-family: 'Playfair Display', serif;">Track Order #<span id="trackOrderId"></span></h2>
        <div id="trackOrderDetails"></div>
      </div>
    </div>
  </div>

  <footer class="bg-gradient-to-r from-gray-900 to-gray-800 text-white py-4 text-center">
    <p class="text-sm">© 2025 Delicute. All rights reserved.</p>
  </footer>

  <script>
  const state = {
    cart: [],
    addresses: [],
    favorites: [],
    menuItems: [],
    coupons: [],
    orders: [],
    user: null,
    appliedCoupon: null,
    cartUpdating: false,
    API_BASE_URL: window.location.hostname.includes('localhost') ? 'http://localhost:3000' : 'https://delicute.onrender.com',
  };

  const placeholderImage = 'https://res.cloudinary.com/do9cbfu5l/image/upload/v1750187399/delicute/profile/default.jpg';
  const defaultProfileImage = 'https://res.cloudinary.com/do9cbfu5l/image/upload/v1750187399/delicute/profile/default.jpg';

  const sanitizeImageUrl = (url) => {
    if (!url || url === 'null' || !url.startsWith('https://res.cloudinary.com/')) {
      return url && url.includes('delicute/profile/') ? url : defaultProfileImage;
    }
    return url;
  };

  const utils = {
    debounce: (func, delay) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), delay);
      };
    },

    showToast: (message, type = 'success') => {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `<span>${message}</span>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    },

    scrollToSection: (sectionId) => {
      const section = document.getElementById(sectionId);
      section?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      if (window.innerWidth <= 640) {
        ui.toggleNav(); // Close mobile nav after selection
      }
    },

    fetchWithAuth: async (url, options = {}) => {
      try {
        let token = localStorage.getItem('token');
        if (!token) {
          throw new Error('No token found');
        }

        const headers = {
          ...options.headers,
          'Authorization': `Bearer ${token}`,
          'Content-Type': options.body instanceof FormData ? undefined : 'application/json',
        };

        let response = await fetch(`${state.API_BASE_URL}${url}`, {
          ...options,
          headers,
        });

        if (response.status === 403) {
          const refreshResponse = await fetch(`${state.API_BASE_URL}/api/user/refresh-token`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
          });
          if (refreshResponse.ok) {
            const { token: newToken } = await refreshResponse.json();
            localStorage.setItem('token', newToken);
            headers['Authorization'] = `Bearer ${newToken}`;
            response = await fetch(`${state.API_BASE_URL}${url}`, {
              ...options,
              headers,
            });
          } else {
            throw new Error('Session expired');
          }
        }

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }

        return await response.json().catch(() => ({}));
      } catch (error) {
        if (error.message.includes('Session expired') || error.message === 'No token found') {
          utils.showToast('Your session has expired. Please log in again.', 'error');
          localStorage.removeItem('token');
          setTimeout(() => window.location.href = '/index.html', 2000);
        } else {
          utils.showToast(error.message, 'error');
        }
        throw error;
      }
    },

    validateMobile: (mobile) => {
      return /^\d{10}$/.test(mobile);
    },

    validateEmail: (email) => {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    },

    validateImage: (file) => {
      if (!file) return true;
      const validTypes = ['image/jpeg', 'image/png'];
      const maxSize = 2 * 1024 * 1024; // 2MB
      if (!validTypes.includes(file.type)) {
        document.getElementById('profileImageError').textContent = 'Only JPEG or PNG images are allowed';
        document.getElementById('profileImageError').classList.add('show');
        return false;
      }
      if (file.size > maxSize) {
        document.getElementById('profileImageError').textContent = 'Image size must be under 2MB';
        document.getElementById('profileImageError').classList.add('show');
        return false;
      }
      document.getElementById('profileImageError').classList.remove('show');
      return true;
    },

    uploadImage: async (file) => {
      if (!file) return state.user?.image || defaultProfileImage;
      if (!utils.validateImage(file)) {
        throw new Error('Invalid image');
      }
      const formData = new FormData();
      formData.append('image', file);
      try {
        const response = await utils.fetchWithAuth('/api/user/upload', {
          method: 'POST',
          body: formData,
        });
        if (!response.url || !response.url.startsWith('https://res.cloudinary.com/')) {
          throw new Error('Invalid image URL returned');
        }
        return response.url;
      } catch (error) {
        utils.showToast(error.message || 'Image upload failed', 'error');
        return state.user?.image || defaultProfileImage;
      }
    },

    formatDateForMySQL: (date) => {
      const d = new Date(date);
      const pad = (n) => n.toString().padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    },
  };

  const ui = {
    toggleNav: () => {
      const navLinks = document.getElementById('navLinks');
      const hamburger = document.getElementById('hamburger');
      navLinks.classList.toggle('active');
      hamburger.classList.toggle('active');
      document.getElementById('profileDropdown').classList.remove('show'); // Close dropdown when toggling nav
    },

    toggleDropdown: () => {
      const dropdown = document.getElementById('profileDropdown');
      const isOpen = dropdown.classList.contains('show');
      dropdown.classList.toggle('show');
      if (window.innerWidth <= 640 && !isOpen) {
        ui.toggleNav(); // Close mobile nav when opening dropdown
      }
    },

    openModal: (modalId) => {
      document.getElementById(modalId).style.display = 'flex';
      if (modalId === 'favoritesModal') data.loadFavorites();
      else if (modalId === 'cartModal') {
        data.loadCart();
        data.loadAddresses();
      } else if (modalId === 'profileModal') {
        ui.loadProfileImage();
        document.getElementById('profileImageError').classList.remove('show');
      } else if (modalId === 'addressModal') {
        data.loadAddresses();
      }
      document.getElementById('profileDropdown').classList.remove('show');
      if (window.innerWidth <= 640) {
        ui.toggleNav();
      }
    },

    closeModal: (modalId) => {
      document.getElementById(modalId).style.display = 'none';
      if (modalId === 'cartModal') {
        document.getElementById('couponCode').classList.remove('valid', 'invalid');
        document.getElementById('couponError').classList.remove('show');
      }
    },

    toggleDarkMode: () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
      utils.showToast(`Switched to ${document.body.classList.contains('dark-mode') ? 'Dark' : 'Light'} Mode`, 'success');
      document.getElementById('profileDropdown').classList.remove('show');
    },

    loadDarkMode: () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    },

    populateAddressForm: (address = {}) => {
      document.getElementById('addressId').value = address.id || '';
      document.getElementById('addressFullName').value = address.fullName || '';
      document.getElementById('addressMobile').value = address.mobile || '';
      document.getElementById('addressHouseNo').value = address.houseNo || '';
      document.getElementById('addressLocation').value = address.location || '';
      document.getElementById('addressLandmark').value = address.landmark || '';
      document.getElementById('addressFormTitle').textContent = address.id ? 'Edit Address' : 'Add New Address';
      document.getElementById('addressSubmitBtn').textContent = address.id ? 'Update Address' : 'Add Address';
    },

    loadProfileImage: () => {
      const imageUrl = state.user?.image ? sanitizeImageUrl(state.user.image) : defaultProfileImage;
      document.getElementById('profileModalImg').src = imageUrl;
      document.getElementById('profileImg').src = imageUrl;
    },

    toggleCartLoading: (isLoading) => {
      state.cartUpdating = isLoading;
      const cartItems = document.getElementById('cartItems');
      const placeOrderBtn = document.getElementById('placeOrderBtn');
      if (isLoading) {
        cartItems.classList.add('loading');
        placeOrderBtn.disabled = true;
      } else {
        cartItems.classList.remove('loading');
        placeOrderBtn.disabled = state.cart.length === 0;
      }
    },
  };

  const data = {
    checkAuth: () => {
      return !!localStorage.getItem('token');
    },

    loadProfile: async () => {
      try {
        state.user = await utils.fetchWithAuth('/api/user/profile');
        document.getElementById('userName').textContent = state.user.name || 'User';
        document.getElementById('profileName').value = state.user.name || '';
        document.getElementById('profileEmail').value = state.user.email || '';
        document.getElementById('profileMobile').value = state.user.mobile || '';
        ui.loadProfileImage();
      } catch (error) {
        console.error('Profile load error:', error);
      }
    },

    updateProfile: async () => {
      const name = document.getElementById('profileName').value.trim();
      const email = document.getElementById('profileEmail').value.trim();
      const imageInput = document.getElementById('profileImage').files[0];
      if (!name || !email) {
        return utils.showToast('Name and Email are required', 'error');
      }
      if (!utils.validateEmail(email)) {
        return utils.showToast('Invalid email format', 'error');
      }
      try {
        const body = { name, email };
        if (imageInput) {
          const imageUrl = await utils.uploadImage(imageInput);
          body.image = imageUrl;
        }
        state.user = await utils.fetchWithAuth('/api/user/profile', {
          method: 'PUT',
          body: JSON.stringify(body),
        });
        document.getElementById('userName').textContent = state.user.name;
        ui.loadProfileImage();
        document.getElementById('profileImage').value = '';
        utils.showToast('Profile updated successfully!', 'success');
        ui.closeModal('profileModal');
      } catch (error) {
        utils.showToast(error.message || 'Failed to update profile', 'error');
      }
    },

    loadAddresses: async () => {
      try {
        state.addresses = await utils.fetchWithAuth('/api/user/addresses');
        const addressSelect = document.getElementById('cartAddressSelect');
        const addressList = document.getElementById('addressList');
        addressSelect.innerHTML = '<option value="">Select Address</option>';
        addressList.innerHTML = '';
        state.addresses.forEach(addr => {
          const addressString = `${addr.fullName}, ${addr.houseNo}, ${addr.location}${addr.landmark ? `, ${addr.landmark}` : ''}, Mobile: ${addr.mobile}`;
          addressSelect.innerHTML += `<option value="${addr.id}">${addressString}</option>`;
          addressList.innerHTML += `
            <div class="order-card flex justify-between items-center">
              <p class="text-gray-600 text-sm">${addressString}</p>
              <div class="flex gap-2">
                <button class="btn-primary text-sm py-1 px-3" onclick="data.editAddress(${addr.id})">Edit</button>
                <button class="btn-secondary text-sm py-1 px-3" onclick="data.deleteAddress(${addr.id})">Delete</button>
              </div>
            </div>
          `;
        });
      } catch (error) {
        utils.showToast(error.message || 'Failed to load addresses', 'error');
      }
    },

    addOrUpdateAddress: async (e) => {
      e.preventDefault();
      const id = document.getElementById('addressId').value;
      const fullName = document.getElementById('addressFullName').value.trim();
      const mobile = document.getElementById('addressMobile').value.trim();
      const houseNo = document.getElementById('addressHouseNo').value.trim();
      const location = document.getElementById('addressLocation').value.trim();
      const landmark = document.getElementById('addressLandmark').value.trim();
      if (!fullName || !mobile || !houseNo || !location) {
        return utils.showToast('Please fill all required fields', 'error');
      }
      if (!utils.validateMobile(mobile)) {
        return utils.showToast('Valid mobile number is required', 'error');
      }
      try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/user/addresses/${id}` : '/api/user/addresses';
        await utils.fetchWithAuth(url, {
          method,
          body: JSON.stringify({ fullName, mobile, houseNo, location, landmark }),
        });
        utils.showToast(id ? 'Address updated!' : 'Address added!', 'success');
        document.getElementById('addressForm').reset();
        ui.populateAddressForm();
        data.loadAddresses();
      } catch (error) {
        utils.showToast(error.message || `Failed to ${id ? 'update' : 'add'} address`, 'error');
      }
    },

    editAddress: async (id) => {
      try {
        const address = state.addresses.find(addr => addr.id === parseInt(id));
        if (!address) {
          throw new Error('Address not found');
        }
        ui.populateAddressForm(address);
      } catch (error) {
        utils.showToast(error.message || 'Failed to load address', 'error');
      }
    },

    deleteAddress: async (id) => {
      if (!confirm('Are you sure you want to delete this address?')) return;
      try {
        await utils.fetchWithAuth(`/api/user/addresses/${id}`, { method: 'DELETE' });
        utils.showToast('Address deleted!', 'success');
        data.loadAddresses();
      } catch (error) {
        utils.showToast(error.message || 'Failed to delete address', 'error');
      }
    },

    loadMenu: async () => {
      try {
        state.menuItems = await utils.fetchWithAuth('/api/user/menu');
        data.renderMenu();
      } catch (error) {
        utils.showToast(error.message || 'Failed to load menu', 'error');
      }
    },

    renderMenu: (items = state.menuItems) => {
      const menuContainer = document.getElementById('menuItems');
      menuContainer.innerHTML = '';
      if (items.length === 0) {
        menuContainer.innerHTML = '<p class="text-center text-gray-600 text-sm">No items found.</p>';
        return;
      }
      items.forEach(item => {
        const isFavorite = state.favorites.some(fav => fav.itemId === item.id);
        menuContainer.innerHTML += `
          <div class="menu-card">
            <img src="${sanitizeImageUrl(item.image)}" alt="${item.name}" class="w-full h-48 object-cover rounded-lg mb-2" onerror="this.src='${placeholderImage}'">
            <h3 class="text-base font-semibold text-gray-800" style="font-family: 'Playfair Display', serif;">${item.name}</h3>
            <p class="text-gray-600 text-sm mb-2">${item.description || 'No description'}</p>
            <p class="text-purple-600 font-bold text-base mb-2">₹${parseFloat(item.price).toFixed(2)}</p>
            <div class="flex justify-between items-center gap-2">
              <button class="btn-primary text-sm py-1 px-3" onclick="data.addToCart(${item.id}, '${item.name}', ${item.price}, '${sanitizeImageUrl(item.image)}')">Add to Cart</button>
              <button class="btn-secondary text-sm py-1 px-3" onclick="${isFavorite ? `data.removeFromFavorites(${item.id})` : `data.addToFavorites(${item.id}, '${item.name}', '${sanitizeImageUrl(item.image)}', ${item.price})`}">${isFavorite ? 'Remove' : 'Favorite'}</button>
            </div>
          </div>
        `;
      });
    },

    searchMenu: () => {
      const query = document.getElementById('menuSearch').value.toLowerCase();
      const filteredItems = state.menuItems.filter(item => item.name.toLowerCase().includes(query));
      data.renderMenu(filteredItems);
    },

    filterCategory: () => {
      const category = document.getElementById('categoryFilter').value;
      const filteredItems = category ? state.menuItems.filter(item => item.category === category) : state.menuItems;
      data.renderMenu(filteredItems);
    },

    loadCoupons: async () => {
      try {
        state.coupons = await utils.fetchWithAuth('/api/user/coupons');
        const couponsList = document.getElementById('couponsList');
        couponsList.innerHTML = '';
        if (state.coupons.length === 0) {
          couponsList.innerHTML = '<p class="text-center text-gray-600 text-sm">No coupons available.</p>';
          return;
        }
        state.coupons.forEach(coupon => {
          couponsList.innerHTML += `
            <div class="coupon-card">
              <img src="${sanitizeImageUrl(coupon.image)}" alt="${coupon.code}" class="w-full h-24 object-cover rounded-lg mb-2" onerror="this.src='${placeholderImage}'">
              <h3 class="text-base font-semibold text-gray-800">${coupon.code}</h3>
              <p class="text-gray-600 text-sm mb-2">${coupon.discount}% OFF</p>
              <button class="btn-primary w-full text-sm py-1 px-3" onclick="data.applyCouponFromList('${coupon.code}', ${coupon.discount})">Apply Coupon</button>
            </div>
          `;
        });
      } catch (error) {
        utils.showToast(error.message || 'Failed to load coupons', 'error');
      }
    },

    loadFavorites: async () => {
      try {
        state.favorites = await utils.fetchWithAuth('/api/user/favorites');
        data.renderFavorites();
        data.renderMenu();
      } catch (error) {
        utils.showToast(error.message || 'Failed to load favorites', 'error');
      }
    },

    renderFavorites: () => {
      const favoritesList = document.getElementById('favoritesList');
      const favoritesModalList = document.getElementById('favoritesModalList');
      favoritesList.innerHTML = '';
      favoritesModalList.innerHTML = '';
      if (state.favorites.length === 0) {
        favoritesList.innerHTML = '<p class="text-center text-gray-600 text-sm">No favorites yet.</p>';
        favoritesModalList.innerHTML = '<p class="text-center text-gray-600 text-sm">No favorites yet.</p>';
        return;
      }
      state.favorites.forEach(item => {
        const cardHTML = `
          <div class="favorite-card flex items-center gap-2">
            <img src="${sanitizeImageUrl(item.image)}" alt="${item.name}" class="w-16 h-16 object-cover rounded-lg" onerror="this.src='${placeholderImage}'">
            <div class="flex-1">
              <h3 class="text-base font-semibold text-gray-800">${item.name}</h3>
              <p class="text-gray-600 text-sm">₹${parseFloat(item.price).toFixed(2)}</p>
            </div>
            <div class="flex gap-2">
              <button class="btn-primary text-sm py-1 px-3" onclick="data.addToCart(${item.itemId}, '${item.name}', ${item.price}, '${sanitizeImageUrl(item.image)}')">Add to Cart</button>
              <button class="btn-secondary text-sm py-1 px-3" onclick="data.removeFromFavorites(${item.itemId})">Remove</button>
            </div>
          </div>
        `;
        favoritesList.innerHTML += cardHTML;
        favoritesModalList.innerHTML += cardHTML;
      });
    },

    addToFavorites: async (id, name, image, price) => {
      try {
        await utils.fetchWithAuth('/api/user/favorites', {
          method: 'POST',
          body: JSON.stringify({ itemId: id, name, image, price }),
        });
        utils.showToast(`${name} added to favorites!`, 'success');
        data.loadFavorites();
      } catch (error) {
        utils.showToast(error.message || 'Failed to add favorite', 'error');
      }
    },

    removeFromFavorites: async (id) => {
      try {
        await utils.fetchWithAuth(`/api/user/favorites/${id}`, { method: 'DELETE' });
        utils.showToast('Removed from favorites!', 'success');
        data.loadFavorites();
      } catch (error) {
        utils.showToast(error.message || 'Failed to remove favorite', 'error');
      }
    },

    loadCart: async () => {
      try {
        ui.toggleCartLoading(true);
        const response = await utils.fetchWithAuth('/api/user/cart');
        state.cart = response.items || [];
        data.renderCart();
      } catch (error) {
        utils.showToast(error.message || 'Failed to load cart', 'error');
      } finally {
        ui.toggleCartLoading(false);
      }
    },

    renderCart: () => {
      const cartItems = document.getElementById('cartItems');
      cartItems.innerHTML = '';
      let originalTotal = 0;
      state.cart.forEach(item => {
        originalTotal += item.price * item.quantity;
        cartItems.innerHTML += `
          <div class="order-card flex items-center gap-2 mb-2">
            <img src="${sanitizeImageUrl(item.image)}" alt="${item.name}" class="w-16 h-16 object-cover rounded-lg" onerror="this.src='${placeholderImage}'">
            <div class="flex-1">
              <h3 class="text-base font-semibold text-gray-800">${item.name}</h3>
              <p class="text-gray-600 text-sm mb-2">${item.description || 'No description'}</p>
              <p class="text-purple-600 font-bold text-base">₹${parseFloat(item.price * item.quantity).toFixed(2)} (₹${parseFloat(item.price).toFixed(2)} x ${item.quantity})</p>
              <div class="flex items-center gap-2 mt-2">
                <button class="btn-quantity" onclick="data.updateQuantity(${item.id}, ${item.quantity - 1})">-</button>
                <span class="text-sm font-medium">${item.quantity}</span>
                <button class="btn-quantity" onclick="data.updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
              </div>
            </div>
            <button class="btn-secondary text-sm py-1 px-3" onclick="data.removeFromCart(${item.id})">Remove</button>
          </div>
        `;
      });
      const discount = state.appliedCoupon ? (originalTotal * state.appliedCoupon.discount) / 100 : 0;
      const finalTotal = originalTotal - discount;
      document.getElementById('cartOriginalTotal').textContent = originalTotal.toFixed(2);
      document.getElementById('cartDiscount').textContent = discount.toFixed(2);
      document.getElementById('cartDelivery').textContent = '0.00';
      document.getElementById('cartFinalTotal').textContent = finalTotal.toFixed(2);
      if (state.cart.length === 0) {
        cartItems.innerHTML = '<p class="text-center text-gray-600 text-sm">Your cart is empty.</p>';
      }
      document.getElementById('placeOrderBtn').disabled = state.cart.length === 0;
    },

    addToCart: async (id, name, price, image) => {
      if (state.cartUpdating) return;
      try {
        ui.toggleCartLoading(true);
        const existingItem = state.cart.find(item => item.itemId === id);
        if (existingItem) {
          await data.updateQuantity(existingItem.id, existingItem.quantity + 1);
        } else {
          const response = await utils.fetchWithAuth('/api/user/cart', {
            method: 'POST',
            body: JSON.stringify({
              itemId: id,
              name,
              price: parseFloat(price),
              image: sanitizeImageUrl(image),
              quantity: 1,
            }),
          });
          state.cart.push(response);
          utils.showToast(`${name} added to cart!`, 'success');
        }
        await data.loadCart();
      } catch (error) {
        utils.showToast(error.message || 'Failed to add to cart', 'error');
      } finally {
        ui.toggleCartLoading(false);
      }
    },

    updateQuantity: async (id, newQuantity) => {
      if (state.cartUpdating) return;
      try {
        ui.toggleCartLoading(true);
        if (newQuantity < 1) {
          await data.removeFromCart(id);
          return;
        }
        const response = await utils.fetchWithAuth(`/api/user/cart/${id}`, {
          method: 'PUT',
          body: JSON.stringify({ quantity: newQuantity }),
        });
        state.cart = state.cart.map(item => item.id === id ? { ...item, quantity: newQuantity } : item);
        utils.showToast('Quantity updated!', 'success');
        data.renderCart();
      } catch (error) {
        utils.showToast(error.message || 'Failed to update quantity', 'error');
      } finally {
        ui.toggleCartLoading(false);
      }
    },

    removeFromCart: async (id) => {
      if (state.cartUpdating) return;
      try {
        ui.toggleCartLoading(true);
        await utils.fetchWithAuth(`/api/user/cart/${id}`, { method: 'DELETE' });
        state.cart = state.cart.filter(item => item.id !== id);
        utils.showToast('Item removed from cart!', 'success');
        data.renderCart();
      } catch (error) {
        utils.showToast(error.message || 'Failed to remove item', 'error');
      } finally {
        ui.toggleCartLoading(false);
      }
    },

    clearCart: async () => {
      if (state.cartUpdating || state.cart.length === 0) return;
      if (!confirm('Are you sure you want to clear your cart?')) return;
      try {
        ui.toggleCartLoading(true);
        await utils.fetchWithAuth('/api/user/cart', { method: 'DELETE' });
        state.cart = [];
        state.appliedCoupon = null;
        utils.showToast('Cart cleared!', 'success');
        data.renderCart();
      } catch (error) {
        utils.showToast(error.message || 'Failed to clear cart', 'error');
      } finally {
        ui.toggleCartLoading(false);
      }
    },

    validateCouponInput: () => {
      const couponInput = document.getElementById('couponCode');
      const couponError = document.getElementById('couponError');
      const code = couponInput.value.trim().toUpperCase();
      if (!code) {
        couponInput.classList.remove('valid', 'invalid');
        couponError.classList.remove('show');
        return;
      }
      const validCoupon = state.coupons.find(c => c.code === code);
      if (validCoupon) {
        couponInput.classList.add('valid');
        couponInput.classList.remove('invalid');
        couponError.classList.remove('show');
      } else {
        couponInput.classList.add('invalid');
        couponInput.classList.remove('valid');
        couponError.textContent = 'Invalid coupon code';
        couponError.classList.add('show');
      }
    },

    applyCoupon: async () => {
      const code = document.getElementById('couponCode').value.trim().toUpperCase();
      if (!code) {
        return utils.showToast('Please enter a coupon code', 'error');
      }
      try {
        const response = await utils.fetchWithAuth(`/api/user/coupons/apply?code=${encodeURIComponent(code)}`);
        state.appliedCoupon = { code, discount: response.discount };
        utils.showToast(`Coupon ${code} applied! ${response.discount}% off`, 'success');
        data.renderCart();
      } catch (error) {
        utils.showToast(error.message || 'Failed to apply coupon', 'error');
        document.getElementById('couponError').textContent = error.message || 'Invalid coupon code';
        document.getElementById('couponError').classList.add('show');
      }
    },

    applyCouponFromList: async (code, discount) => {
      try {
        state.appliedCoupon = { code, discount };
        utils.showToast(`Coupon ${code} applied! ${discount}% off`, 'success');
        data.renderCart();
        ui.closeModal('cartModal');
        ui.openModal('cartModal');
        document.getElementById('couponCode').value = code;
        document.getElementById('couponCode').classList.add('valid');
      } catch (error) {
        utils.showToast(error.message || 'Failed to apply coupon', 'error');
      }
    },

    placeOrder: async (paymentMethod) => {
      if (state.cartUpdating || state.cart.length === 0) return;
      const addressId = document.getElementById('cartAddressSelect').value;
      if (!addressId) {
        return utils.showToast('Please select a delivery address', 'error');
      }
      try {
        ui.toggleCartLoading(true);
        const orderData = {
          items: state.cart.map(item => ({
            itemId: item.itemId,
            quantity: item.quantity,
            price: item.price,
            name: item.name,
          })),
          addressId: parseInt(addressId),
          couponCode: state.appliedCoupon?.code || null,
          paymentMethod,
          orderDate: utils.formatDateForMySQL(new Date()),
        };
        for (const item of orderData.items) {
          if (!item.itemId || !item.price || !item.quantity || !item.name) {
            throw new Error('Invalid item data');
          }
        }
        await utils.fetchWithAuth('/api/user/orders', {
          method: 'POST',
          body: JSON.stringify(orderData),
        });
        state.cart = [];
        state.appliedCoupon = null;
        utils.showToast('Order placed successfully!', 'success');
        ui.closeModal('cartModal');
        data.loadOrders();
        data.renderCart();
      } catch (error) {
        utils.showToast(error.message || 'Failed to place order', 'error');
      } finally {
        ui.toggleCartLoading(false);
      }
    },

    loadOrders: async () => {
      try {
        state.orders = await utils.fetchWithAuth('/api/user/orders');
        document.getElementById('totalOrders').textContent = state.orders.length;
        data.renderOrders();
        data.renderActiveOrders();
      } catch (error) {
        utils.showToast(error.message || 'Failed to load orders', 'error');
      }
    },

    renderOrders: () => {
      const orderHistory = document.getElementById('orderHistory');
      orderHistory.innerHTML = '';
      if (state.orders.length === 0) {
        orderHistory.innerHTML = '<p class="text-center text-gray-600 text-sm">No orders yet.</p>';
        return;
      }
      state.orders.forEach(order => {
        const itemsList = order.items.map(item => `
          <div class="flex justify-between items-center mb-1">
            <span class="text-sm text-gray-600">${item.name} x${item.quantity}</span>
            <span class="text-sm text-purple-600">₹${(item.price * item.quantity).toFixed(2)}</span>
          </div>
        `).join('');
        const subtotal = order.subtotal || 0;
        const discount = order.discount || 0;
        const deliveryFee = order.deliveryFee || 0;
        const total = order.total || subtotal - discount + deliveryFee;
        orderHistory.innerHTML += `
          <div class="order-card">
            <h3 class="text-base font-semibold text-gray-800">Order #${order.id}</h3>
            <p class="text-gray-600 text-sm mb-1">Date: ${new Date(order.orderDate).toLocaleString()}</p>
            <p class="text-gray-600 text-sm mb-1">Status: <span class="${order.status === 'Delivered' ? 'text-green-600' : order.status === 'Cancelled' ? 'text-red-600' : 'text-yellow-600'}">${order.status}</span></p>
            <p class="text-gray-600 text-sm mb-1">Address: ${order.address.fullName}, ${order.address.houseNo}, ${order.address.location}${order.address.landmark ? `, ${order.address.landmark}` : ''}</p>
            ${itemsList}
            <p class="text-gray-600 text-sm mb-1">Subtotal: ₹${parseFloat(subtotal).toFixed(2)}</p>
            <p class="text-green-600 text-sm mb-1">Discount: ₹${parseFloat(discount).toFixed(2)}</p>
            <p class="text-gray-600 text-sm mb-1">Delivery: ₹${parseFloat(deliveryFee).toFixed(2)}</p>
            <p class="text-lg font-bold text-gray-800 mb-2">Total: ₹${parseFloat(total).toFixed(2)}</p>
          </div>
        `;
      });
    },

    renderActiveOrders: () => {
      const activeOrders = document.getElementById('activeOrders');
      activeOrders.innerHTML = '';
      const active = state.orders.filter(order => ['Pending', 'Confirmed', 'In Transit'].includes(order.status));
      if (active.length === 0) {
        activeOrders.innerHTML = '<p class="text-center text-gray-600 text-sm">No active orders.</p>';
        return;
      }
      active.forEach(order => {
        const itemsList = order.items.map(item => `
          <div class="flex justify-between items-center mb-1">
            <span class="text-sm text-gray-600">${item.name} x${item.quantity}</span>
            <span class="text-sm text-purple-600">₹${(item.price * item.quantity).toFixed(2)}</span>
          </div>
        `).join('');
        const subtotal = order.subtotal || 0;
        const discount = order.discount || 0;
        const deliveryFee = order.deliveryFee || 0;
        const total = order.total || subtotal - discount + deliveryFee;
        const canCancel = ['Pending', 'Confirmed'].includes(order.status);
        const trackingSteps = [
          { name: 'Order Placed', active: ['Pending', 'Confirmed', 'In Transit', 'Delivered'].includes(order.status) },
          { name: 'Confirmed', active: ['Confirmed', 'In Transit', 'Delivered'].includes(order.status) },
          { name: 'In Transit', active: ['In Transit', 'Delivered'].includes(order.status) },
          { name: 'Delivered', active: order.status === 'Delivered' },
        ];
        const trackingBar = `
          <div class="tracking-bar">
            ${trackingSteps.map(step => `
              <div class="tracking-step ${step.active ? 'active' : 'inactive'}">${step.name}</div>
            `).join('')}
          </div>
        `;
        activeOrders.innerHTML += `
          <div class="order-card">
            <h3 class="text-base font-semibold text-gray-800">Order #${order.id}</h3>
            <p class="text-gray-600 text-sm mb-1">Date: ${new Date(order.orderDate).toLocaleString()}</p>
            <p class="text-gray-600 text-sm mb-1">Status: <span class="${order.status === 'Delivered' ? 'text-green-600' : order.status === 'Cancelled' ? 'text-red-600' : 'text-yellow-600'}">${order.status}</span></p>
            <p class="text-gray-600 text-sm mb-1">Address: ${order.address.fullName}, ${order.address.houseNo}, ${order.address.location}${order.address.landmark ? `, ${order.address.landmark}` : ''}</p>
            ${itemsList}
            <p class="text-gray-600 text-sm mb-1">Subtotal: ₹${parseFloat(subtotal).toFixed(2)}</p>
            <p class="text-green-600 text-sm mb-1">Discount: ₹${parseFloat(discount).toFixed(2)}</p>
            <p class="text-gray-600 text-sm mb-1">Delivery: ₹${parseFloat(deliveryFee).toFixed(2)}</p>
            <p class="text-lg font-bold text-gray-800 mb-2">Total: ₹${parseFloat(total).toFixed(2)}</p>
            ${trackingBar}
            <div class="flex gap-2 mt-2">
              <button class="btn-primary text-sm py-1 px-3" onclick="data.trackOrder(${order.id})">Track Order</button>
              ${canCancel ? `<button class="btn-secondary text-sm py-1 px-3" onclick="data.openCancelOrderModal(${order.id})">Cancel Order</button>` : ''}
            </div>
          </div>
        `;
      });
    },

    openCancelOrderModal: (orderId) => {
      document.getElementById('cancelOrderId').value = orderId;
      document.getElementById('cancelReason').value = '';
      ui.openModal('cancelOrderModal');
    },

    cancelOrder: async (e) => {
      e.preventDefault();
      const orderId = document.getElementById('cancelOrderId').value;
      const reason = document.getElementById('cancelReason').value.trim();
      if (!reason) {
        return utils.showToast('Please provide a cancellation reason', 'error');
      }
      try {
        await utils.fetchWithAuth(`/api/user/orders/${orderId}/cancel`, {
          method: 'PUT',
          body: JSON.stringify({ reason }),
        });
        utils.showToast('Order cancelled successfully!', 'success');
        ui.closeModal('cancelOrderModal');
        data.loadOrders();
      } catch (error) {
        utils.showToast(error.message || 'Failed to cancel order', 'error');
      }
    },

    trackOrder: async (orderId) => {
      try {
        const order = state.orders.find(o => o.id === parseInt(orderId));
        if (!order) {
          throw new Error('Order not found');
        }
        document.getElementById('trackOrderId').textContent = orderId;
        const trackingSteps = [
          { name: 'Order Placed', active: ['Pending', 'Confirmed', 'In Transit', 'Delivered'].includes(order.status) },
          { name: 'Confirmed', active: ['Confirmed', 'In Transit', 'Delivered'].includes(order.status) },
          { name: 'In Transit', active: ['In Transit', 'Delivered'].includes(order.status) },
          { name: 'Delivered', active: order.status === 'Delivered' },
        ];
        document.getElementById('trackOrderDetails').innerHTML = `
          <p class="text-gray-600 text-sm mb-1">Status: <span class="${order.status === 'Delivered' ? 'text-green-600' : order.status === 'Cancelled' ? 'text-red-600' : 'text-yellow-600'}">${order.status}</span></p>
          <p class="text-gray-600 text-sm mb-1">Date: ${new Date(order.orderDate).toLocaleString()}</p>
          <p class="text-gray-600 text-sm mb-1">Address: ${order.address.fullName}, ${order.address.houseNo}, ${order.address.location}${order.address.landmark ? `, ${order.address.landmark}` : ''}</p>
          <div class="tracking-bar">
            ${trackingSteps.map(step => `
              <div class="tracking-step ${step.active ? 'active' : 'inactive'}">${step.name}</div>
            `).join('')}
          </div>
        `;
        ui.openModal('trackOrderModal');
      } catch (error) {
        utils.showToast(error.message || 'Failed to load tracking details', 'error');
      }
    },

    refreshOrders: async () => {
      try {
        await data.loadOrders();
        utils.showToast('Orders refreshed!', 'success');
      } catch (error) {
        utils.showToast(error.message || 'Failed to refresh orders', 'error');
      }
    },

    logout: () => {
      localStorage.removeItem('token');
      utils.showToast('Logged out successfully!', 'success');
      setTimeout(() => window.location.href = '/index.html', 1500);
    },
  };

  const init = async () => {
    if (!data.checkAuth()) {
      window.location.href = '/index.html';
      return;
    }
    ui.loadDarkMode();
    await Promise.all([
      data.loadProfile(),
      data.loadMenu(),
      data.loadCoupons(),
      data.loadFavorites(),
      data.loadOrders(),
    ]);
    document.getElementById('addressForm').addEventListener('submit', data.addOrUpdateAddress);
    document.getElementById('cancelOrderForm').addEventListener('submit', data.cancelOrder);
  };

  const debounceSearch = utils.debounce(data.searchMenu, 300);
  init();
  </script>
  </body>
  </html>