<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex, nofollow">
  <title>Delicute - User Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #a855f7, #ec4899);
      --secondary-gradient: linear-gradient(135deg, #6b7280, #9ca3af);
      --text-dark: #1e293b;
      --text-light: #f1f5f9;
      --card-bg: rgba(255, 255, 255, 0.95);
      --card-bg-dark: rgba(17, 24, 39, 0.95);
      --modal-bg: rgba(255, 255, 255, 0.98);
      --modal-bg-dark: rgba(17, 24, 39, 0.95);
    }

    body {
      background: linear-gradient(135deg, #f3e8ff, #bfdbfe);
      font-family: 'Poppins', sans-serif;
      color: var(--text-dark);
      margin: 0;
      overflow-x: hidden;
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
    }

    .dashboard-bg {
      position: relative;
      background: url('https://images.unsplash.com/photo-1515003197210-e0cd71810b5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') no-repeat center center/cover;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .dashboard-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.3));
      z-index: 1;
    }

    .dashboard-content {
      position: relative;
      z-index: 2;
      max-width: 1280px;
      margin: 2rem auto;
      padding: 1rem;
    }

    .header {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 50;
      margin: 0.5rem;
    }

    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 1.75rem;
      font-weight: 700;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: transform 0.3s ease;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    .nav-links {
      display: flex;
      gap: 1rem;
    }

    .nav-link {
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      color: #ffffff;
      padding: 0.5rem 1rem;
      transition: color 0.3s ease;
      cursor: pointer;
    }

    .nav-link:hover {
      color: #ec4899;
    }

    .profile-dropdown {
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .cart-icon {
      position: relative;
      cursor: pointer;
      color: #ffffff;
      font-size: 1.25rem;
    }

    .cart-count {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #ec4899;
      color: #ffffff;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
    }

    .profile-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .profile-img:hover {
      transform: scale(1.1);
    }

    .dropdown-menu {
      position: absolute;
      top: 50px;
      right: 0;
      background: var(--modal-bg);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 0.75rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      min-width: 180px;
      z-index: 100;
      display: none;
      animation: dropdownFade 0.3s ease;
    }

    .dropdown-menu.show {
      display: block;
    }

    @keyframes dropdownFade {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dropdown-item {
      padding: 0.75rem 1rem;
      color: var(--text-dark);
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .dropdown-item:hover {
      background: var(--primary-gradient);
      color: #ffffff;
    }

    .hero-section {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 1.25rem;
      padding: 2rem 1.5rem;
      text-align: center;
      margin-bottom: 1.5rem;
      animation: float 5s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
      margin-bottom: 1rem;
    }

    .card:hover {
      transform: translateY(-3px);
    }

    .btn-primary {
      background: var(--primary-gradient);
      color: #ffffff;
      padding: 0.6rem 1.5rem;
      border-radius: 9999px;
      font-size: 0.9rem;
      font-weight: 500;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      touch-action: manipulation;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-primary:disabled {
      background: var(--secondary-gradient);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: var(--secondary-gradient);
      color: #ffffff;
      padding: 0.4rem 1rem;
      border-radius: 9999px;
      font-size: 0.8rem;
      font-weight: 500;
      transition: transform 0.3s ease;
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
    }

    .btn-quantity {
      background: rgba(255, 255, 255, 0.4);
      color: #a855f7;
      padding: 0.4rem;
      border-radius: 0.4rem;
      font-size: 1rem;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    .btn-quantity:hover:not(:disabled) {
      background: rgba(168, 85, 247, 0.3);
      transform: scale(1.05);
    }

    .btn-quantity:disabled {
      background: rgba(255, 255, 255, 0.2);
      color: #9ca3af;
      cursor: not-allowed;
    }

    .input-field {
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 0.4rem;
      padding: 0.75rem;
      width: 100%;
      font-size: 0.9rem;
      transition: border-color 0.3s ease;
    }

    .input-field:focus {
      border-color: #a855f7;
      outline: none;
    }

    .input-field.valid {
      border-color: #10b981;
    }

    .input-field.invalid {
      border-color: #ef4444;
    }

    .search-bar {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 9999px;
      padding: 0.6rem 1rem;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .search-bar input {
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-dark);
      font-size: 0.9rem;
      width: 100%;
    }

    .search-bar input::placeholder {
      color: #6b7280;
    }

    .category-filter {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 9999px;
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
      width: 100%;
      max-width: 10rem;
    }

    .toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 0.6rem 1rem;
      border-radius: 0.4rem;
      color: #ffffff;
      font-size: 0.85rem;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      animation: toastSlide 3.5s ease-in-out forwards;
    }

    .toast-success {
      background: linear-gradient(135deg, #10b981, #34d399);
    }

    .toast-error {
      background: linear-gradient(135deg, #ef4444, #f87171);
    }

    .toast::before {
      content: '';
      width: 0.9rem;
      height: 0.9rem;
      background-size: cover;
    }

    .toast-success::before {
      background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white"%3E%3Cpath stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /%3E%3C/svg%3E');
    }

    .toast-error::before {
      background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white"%3E%3Cpath stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /%3E%3C/svg%3E');
    }

    @keyframes toastSlide {
      0% { opacity: 0; transform: translateY(-20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: var(--modal-bg);
      padding: 1.5rem;
      border-radius: 1rem;
      width: 90%;
      max-width: 550px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      animation: modalPop 0.3s ease forwards;
      position: relative;
    }

    .profile-modal-content {
      padding: 2rem;
      max-width: 450px;
      border-radius: 1.25rem;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(240, 240, 245, 0.98));
    }

    .profile-modal-content img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 1rem;
      display: block;
      border: 3px solid #a855f7;
    }

    @keyframes modalPop {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .close-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      font-size: 1.25rem;
      cursor: pointer;
      color: #6b7280;
      transition: color 0.3s ease;
    }

    .close-btn:hover {
      color: #a855f7;
    }

    .order-card, .menu-card, .favorite-card, .coupon-card {
      background: var(--card-bg);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .order-card:hover, .menu-card:hover, .favorite-card:hover, .coupon-card:hover {
      transform: translateY(-3px);
    }

    .order-card.loading, .cart-items.loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .error-message {
      color: #ef4444;
      font-size: 0.75rem;
      margin-top: 0.25rem;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .dark-mode {
      background: linear-gradient(135deg, #1e293b, #374151);
      color: var(--text-light);
    }

    .dark-mode .dashboard-bg::before {
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.5));
    }

    .dark-mode .card, .dark-mode .modal-content, .dark-mode .dropdown-menu, .dark-mode .order-card, .dark-mode .menu-card, .dark-mode .favorite-card, .dark-mode .coupon-card {
      background: var(--card-bg-dark);
      color: var(--text-light);
    }

    .dark-mode .profile-modal-content {
      background: linear-gradient(145deg, rgba(17, 24, 39, 0.95), rgba(30, 41, 59, 0.95));
    }

    .dark-mode .input-field {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-light);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .dark-mode .input-field.valid {
      border-color: #34d399;
    }

    .dark-mode .input-field.invalid {
      border-color: #f87171;
    }

    .dark-mode .search-bar, .dark-mode .category-filter {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .dark-mode .search-bar input {
      color: var(--text-light);
    }

    .dark-mode .search-bar input::placeholder {
      color: #9ca3af;
    }

    .dark-mode .btn-quantity {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-light);
    }

    .dark-mode .btn-quantity:disabled {
      background: rgba(255, 255, 255, 0.05);
      color: #6b7280;
    }

    .dark-mode .btn-quantity:hover:not(:disabled) {
      background: rgba(168, 85, 247, 0.2);
    }

    .dark-mode .error-message {
      color: #f87171;
    }

    .tracking-bar {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }

    .tracking-step {
      flex: 1;
      text-align: center;
      padding: 0.4rem;
      border-radius: 0.4rem;
      font-size: 0.75rem;
      transition: background 0.3s ease;
    }

    .tracking-step.active {
      background: var(--primary-gradient);
      color: #ffffff;
    }

    .tracking-step.inactive {
      background: rgba(255, 255, 255, 0.4);
      color: #6b7280;
    }

    .dark-mode .tracking-step.inactive {
      background: rgba(255, 255, 255, 0.1);
      color: #9ca3af;
    }

    .btn-primary:focus, .btn-secondary:focus, .btn-quantity:focus {
      outline: 2px solid #a855f7;
      outline-offset: 2px;
    }

    @media (max-width: 768px) {
      .dashboard-content {
        margin: 0.5rem;
        padding: 0.5rem;
      }

      .header {
        margin: 0.25rem;
        padding: 0.5rem;
        border-radius: 0.5rem;
      }

      .nav-links {
        display: none;
      }

      .logo {
        font-size: 1.25rem;
      }

      .profile-img {
        width: 32px;
        height: 32px;
      }

      .dropdown-menu {
        min-width: 160px;
        top: 45px;
        right: -4px;
      }

      .dropdown-item {
        font-size: 0.8rem;
        padding: 0.5rem 0.75rem;
      }

      .hero-section {
        padding: 1.25rem 0.5rem;
        margin-bottom: 1rem;
      }

      .hero-section h2 {
        font-size: 1.5rem;
      }

      .hero-section p {
        font-size: 0.8rem;
      }

      .card {
        padding: 1rem;
        margin-bottom: 0.75rem;
        border-radius: 0.5rem;
      }

      .card h2 {
        font-size: 1.25rem;
      }

      .menu-items {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }

      .menu-card {
        padding: 0.5rem;
      }

      .menu-card img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 0.4rem;
      }

      .menu-card h3 {
        font-size: 0.875rem;
      }

      .menu-card p {
        font-size: 0.7rem;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      .menu-card .flex {
        flex-direction: column;
        gap: 0.4rem;
      }

      .btn-primary {
        padding: 0.4rem 0.75rem;
        font-size: 0.75rem;
      }

      .btn-secondary {
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
      }

      .btn-quantity {
        width: 1.75rem;
        height: 1.75rem;
        font-size: 0.875rem;
      }

      .modal-content {
        padding: 0.75rem;
        max-width: 95%;
        border-radius: 0.5rem;
      }

      .profile-modal-content {
        padding: 1.25rem;
      }

      .profile-modal-content img {
        width: 80px;
        height: 80px;
      }

      .modal-content h2 {
        font-size: 1.25rem;
      }

      .input-field {
        padding: 0.5rem;
        font-size: 0.8rem;
      }

      .search-bar {
        padding: 0.4rem 0.75rem;
      }

      .search-bar input {
        font-size: 0.8rem;
      }

      .category-filter {
        padding: 0.4rem 0.75rem;
        font-size: 0.8rem;
        max-width: 8rem;
      }

      .tracking-bar {
        gap: 0.25rem;
      }

      .tracking-step {
        font-size: 0.65rem;
        padding: 0.2rem;
      }
    }

    @media (min-width: 768px) {
      .menu-items {
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-bg">
    <div class="dashboard-content" id="content">
      <div class="header">
        <div class="logo">
          <img src="https://i.postimg.cc/zv19J0xv/Zbhz-Fq-T-Imgur.jpg" alt="Delicute Logo" class="w-8 h-8 rounded-full border-2 border-white" loading="lazy">
          <span>Delicute</span>
        </div>
        <div class="profile-dropdown" aria-label="User Profile">
          <div class="cart-icon" onclick="ui.openModal('cartModal')" aria-label="Open Cart">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-count" id="cartCount">0</span>
          </div>
          <img
            src="https://via.placeholder.com/40x40.png?text=Profile"
            alt="Profile Image"
            class="profile-img"
            id="profileImg"
            loading="lazy"
            onclick="ui.toggleDropdown()"
            aria-label="Toggle profile dropdown"
          >
          <div class="dropdown-menu" id="profileDropdown" aria-expanded="false">
            <div class="dropdown-item" onclick="utils.scrollToSection('dashboard-content')" aria-label="Go to Home"><i class="fas fa-home"></i>Home</div>
            <div class="dropdown-item" onclick="utils.scrollToSection('myOrders')" aria-label="Go to My Orders"><i class="fas fa-box"></i>My Orders</div>
            <div class="dropdown-item" onclick="utils.scrollToSection('orders')" aria-label="Go to Order History"><i class="fas fa-history"></i>Order History</div>
            <div class="dropdown-item" onclick="ui.openModal('profileModal')" aria-label="Edit Profile"><i class="fas fa-user-edit"></i>Edit Profile</div>
            <div class="dropdown-item" onclick="ui.openModal('addressModal')" aria-label="Manage Addresses"><i class="fas fa-map-marker-alt"></i>Manage Addresses</div>
            <div class="dropdown-item" onclick="ui.openModal('favoritesModal')" aria-label="View Favorites"><i class="fas fa-heart"></i>Favorites</div>
            <div class="dropdown-item" onclick="ui.openModal('cartModal')" aria-label="Open Cart"><i class="fas fa-shopping-cart"></i>Cart</div>
            <div class="dropdown-item" onclick="ui.toggleDarkMode()" aria-label="Toggle Dark Mode"><i class="fas fa-moon"></i>Toggle Dark Mode</div>
            <div class="dropdown-item" onclick="data.logout()" aria-label="Logout"><i class="fas fa-sign-out-alt"></i>Logout</div>
          </div>
        </div>
      </div>

      <div class="hero-section">
        <h2 class="text-xl md:text-2xl font-semibold mb-2 text-black" style="font-family: 'Playfair Display', serif;">Welcome, <span id="userName">User</span>!</h2>
        <p class="text-sm md:text-base text-black mb-1">Total Orders: <span id="totalOrders">0</span></p>
        <p class="text-sm md:text-base text-black mb-2">"Every Bite Tells a Story!"</p>
        <button class="btn-primary" onclick="utils.scrollToSection('menuSection')" aria-label="Explore Menu">Explore Menu</button>
      </div>

      <div class="card" id="myOrders">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-lg md:text-xl font-semibold" style="font-family: 'Playfair Display', serif;">My Orders</h2>
          <button class="btn-secondary text-xs" onclick="data.refreshOrders()" aria-label="Refresh Orders">Refresh</button>
        </div>
        <div id="orderHistory"></div>
      </div>

      <div class="card" id="menuSection">
        <h2 class="text-lg md:text-xl font-semibold mb-2" style="font-family: 'Playfair Display', serif;">Our Menu</h2>
        <div class="flex flex-col md:flex-row justify-between items-center mb-3 gap-2">
          <div class="search-bar w-full sm:w-auto flex-grow max-w-xs">
            <svg class="w-4 h-4 text-gray-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input type="text" id="menuSearch" placeholder="Search menu..." oninput="debounceSearch()" aria-label="Search menu items">
          </div>
          <div class="category-filter">
            <select id="categoryFilter" class="w-full text-sm" onchange="data.filterCategory()" aria-label="Filter by category">
              <option value="">All Categories</option>
              <option value="starter">Starter</option>
              <option value="main">Main</option>
              <option value="dessert">Dessert</option>
              <option value="beverage">Beverage</option>
            </select>
          </div>
        </div>
        <div id="menuItems" class="menu-items"></div>
      </div>

      <div class="card" id="couponsSection">
        <h2 class="text-lg md:text-xl font-semibold mb-2" style="font-family: 'Playfair Display', serif;">Exclusive Offers</h2>
        <div id="couponsList" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-2 mb-2"></div>
      </div>

      <div class="card" id="favoritesSection">
        <h2 class="text-lg md:text-xl font-semibold mb-2" style="font-family: 'Playfair Display', serif;">Your Favorites</h2>
        <div id="favoritesList" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-2"></div>
      </div>

      <div class="card" id="orders">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-lg md:text-xl font-semibold" style="font-family: 'Playfair Display', serif;">Order History</h2>
          <button class="btn-secondary text-xs" onclick="data.clearOrderHistory()" aria-label="Clear Order History">Clear History</button>
        </div>
        <div id="activeOrders"></div>
      </div>
    </div>

    <div id="profileModal" class="modal">
      <div class="modal-content profile-modal-content">
        <span class="close-btn" onclick="ui.closeModal('profileModal')" aria-label="Close">&times;</span>
        <img src="https://via.placeholder.com/100x100.png?text=Profile" alt="Profile Picture" id="profileModalImg" loading="lazy">
        <h2 class="text-lg md:text-xl font-semibold mb-3 text-center" style="font-family: 'Playfair Display', serif;">Edit Profile</h2>
        <div class="mb-3">
          <label class="block text-sm mb-1" for="profileName">Name *</label>
          <input type="text" id="profileName" class="input-field" placeholder="Enter Name" required aria-required="true">
        </div>
        <div class="mb-3">
          <label class="block text-sm mb-1" for="profileEmail">Email *</label>
          <input type="email" id="profileEmail" class="input-field" placeholder="Enter Email" required aria-required="true">
        </div>
        <div class="mb-3">
          <label class="block text-sm mb-1" for="mobile">Mobile Number</label>
          <input type="tel" id="mobile" class="input-field bg-gray-100" readonly aria-readonly="true">
        </div>
        <div class="mb-3">
          <label class="block text-sm mb-1" for="profileImage">Profile Picture (JPEG/PNG, max 2MB)</label>
          <input type="file" id="profileImage" accept="image/jpeg,image/png" class="input-field" aria-describedby="profileImageError">
          <p class="error-message" id="profileImageError"></p>
        </div>
        <button class="btn-primary w-full" onclick="data.updateProfile()" aria-label="Save Changes">Save Changes</button>
      </div>
    </div>

    <div id="addressModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="ui.closeModal('addressModal')" aria-label="Close">&times;</span>
        <h2 class="text-lg md:text-xl font-semibold mb-3 text-center" style="font-family: 'Playfair Display', serif;">Manage Addresses</h2>
        <div id="addressList" class="mb-3"></div>
        <h3 class="text-base font-medium mb-2" id="addressFormTitle">Add New Address</h3>
        <div id="addressForm">
          <input type="hidden" id="addressId">
          <div class="mb-3">
            <label class="block text-sm mb-1" for="fullName">Full Name *</label>
            <input type="text" id="fullName" class="input-field" placeholder="Enter Full Name" required aria-required="true">
          </div>
          <div class="mb-3">
            <label class="block text-sm mb-1" for="addressMobile">Mobile Number *</label>
            <input type="tel" id="addressMobile" class="input-field" placeholder="Enter Mobile Number" required aria-required="true">
          </div>
          <div class="mb-3">
            <label class="block text-sm mb-1" for="houseNo">House/Flat Number *</label>
            <input type="text" id="houseNo" class="input-field" placeholder="Enter House/Flat Number" required aria-required="true">
          </div>
          <div class="mb-3">
            <label class="block text-sm mb-1" for="addressLocation">Street Address *</label>
            <input type="text" id="addressLocation" class="input-field" placeholder="Enter Street Address" required aria-required="true">
          </div>
          <div class="mb-3">
            <label class="block text-sm mb-1" for="landmark">Landmark</label>
            <input type="text" id="landmark" class="input-field" placeholder="Enter Landmark">
          </div>
          <button type="submit" class="btn-primary w-full" id="submitAddressBtn" onclick="data.addOrUpdateAddress(event)" aria-label="Add Address">Add Address</button>
        </div>
      </div>
    </div>

    <div id="favoritesModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="ui.closeModal('favoritesModal')" aria-label="Close">&times;</span>
        <h2 class="text-lg md:text-xl font-semibold mb-3 text-center" style="font-family: 'Playfair Display', serif;">Your Favorites</h2>
        <div id="favoritesModalList" class="grid grid-cols-2 sm:grid-cols-2 gap-2 mb-2"></div>
      </div>
    </div>

    <div id="cartModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="ui.closeModal('cartModal')" aria-label="Close">&times;</span>
        <h2 class="text-lg md:text-xl font-semibold mb-3 text-center" style="font-family: 'Playfair Display', serif;">Your Order</h2>
        <div id="cartItems" class="mb-3 cart-items"></div>
        <div class="flex justify-between items-center mb-2">
          <button class="btn-secondary text-xs" onclick="data.clearCart()" aria-label="Clear Cart">Clear Cart</button>
        </div>
        <div class="mb-3">
          <label class="block text-sm mb-1" for="cartAddressSelect">Select Address *</label>
          <select id="cartAddressSelect" class="input-field" required aria-required="true">
            <option value="">Select Address</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="block text-sm mb-1" for="couponCode">Apply Coupon</label>
          <div class="flex gap-2">
            <input type="text" id="couponCode" class="input-field" placeholder="Enter Coupon Code" oninput="data.validateCoupon()" aria-describedby="couponError">
            <button class="btn-primary px-3" onclick="data.applyCoupon()" aria-label="Apply Coupon">Apply</button>
          </div>
          <p class="error-message" id="couponError"></p>
        </div>
        <div class="mb-3">
          <p class="text-sm mb-1">Subtotal: ₹<span id="cartOriginalTotal">0</span></p>
          <p class="text-green-600 text-sm mb-1">Discount: ₹<span id="cartDiscount">0</span></p>
          <p class="text-sm mb-1">Delivery: ₹<span id="cartDelivery">0</span> (Free)</p>
          <p class="text-base font-medium mb-2">Final Total: ₹<span id="cartFinalTotal">0</span></p>
        </div>
        <p class="text-red-500 text-sm mb-3 text-center">Note: UPI payments coming soon.</p>
        <button class="btn-primary w-full" id="placeOrderBtn" onclick="data.placeOrder('cod')" aria-label="Place Order">Place Order (COD)</button>
      </div>
    </div>

    <div id="cancelOrderModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="ui.closeModal('cancelOrderModal')" aria-label="Close">&times;</span>
        <h2 class="text-lg mb-3 font-semibold text-center" style="font-family: 'Playfair Display', serif;">Cancel Order</h2>
        <p class="text-sm mb-3">Please provide a reason for cancellation:</p>
        <div id="cancelOrderForm">
          <input type="hidden" id="orderId">
          <div class="mb-3">
            <label class="block text-sm mb-1" for="cancelReason">Reason *</label>
            <textarea id="cancelReason" class="input-field" rows="3" placeholder="Enter cancellation reason..." required aria-required="true"></textarea>
          </div>
          <button type="submit" class="btn-primary w-full" onclick="data.cancelOrder(event)" aria-label="Submit Cancellation">Submit</button>
        </div>
      </div>
    </div>

    <div id="trackOrderModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="ui.closeModal('trackOrderModal')" aria-label="Close">&times;</span>
        <h2 class="text-lg mb-3 font-semibold text-center" style="font-family: 'Playfair Display', serif;">Track Order #<span id="trackOrderId"></span></h2>
        <div id="trackOrderDetails"></div>
      </div>
    </div>
  </div>

  <footer class="bg-gray-900 text-white py-4 text-center">
    <p class="text-xs">© 2025 Delicute. All Rights Reserved.</p>
  </footer>

  <script>
  const state = {
    cart: [],
    addresses: [],
    favorites: [],
    menuItems: [],
    coupons: [],
    orders: [],
    user: null,
    appliedCoupon: null,
    cartUpdating: false,
    API_BASE_URL: window.location.hostname.includes('localhost') ? 'http://localhost:3000' : 'https://delicute.onrender.com',
    cache: {},
  };

  const placeholderImage = 'https://via.placeholder.com/150x150.png?text=Image';
  const defaultProfileImage = 'https://via.placeholder.com/40x40.png?text=Profile';

  const sanitizeImageUrl = (url) => {
    if (!url || typeof url !== 'string' || url === 'null') return defaultProfileImage;
    return url.startsWith('https://res.cloudinary.com/') ? url : defaultProfileImage;
  };

  const sanitizeInput = (input) => {
    if (typeof input !== 'string') return input;
    const div = document.createElement('div');
    div.textContent = input;
    return div.innerHTML.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  };

  const getAddressString = (addr) => {
    if (!addr) return 'No address provided';
    return `${sanitizeInput(addr.fullName || '')}, ${sanitizeInput(addr.street || '')}, ${sanitizeInput(addr.city || '')}${addr.landmark ? `, ${sanitizeInput(addr.landmark)}` : ''}, Mobile: ${sanitizeInput(addr.phone || '')}`;
  };

  const utils = {
    debounce: (func, delay) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), delay);
      };
    },

    showToast: (message, type = 'success') => {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `<span>${sanitizeInput(message)}</span>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    },

    scrollToSection: (sectionId) => {
      const section = document.getElementById(sectionId);
      section?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      document.getElementById('profileDropdown').classList.remove('show');
    },

    fetchWithAuth: async (url, options = {}) => {
      try {
        const token = localStorage.getItem('token');
        if (!token) throw new Error('No token found');

        const headers = {
          ...options.headers,
          'Authorization': `Bearer ${token}`,
          'Content-Type': options.body instanceof FormData ? undefined : 'application/json',
        };

        let response = await fetch(`${state.API_BASE_URL}${url}`, {
          ...options,
          headers,
        });

        if (response.status === 403) {
          const refreshResponse = await fetch(`${state.API_BASE_URL}/api/user/refresh-token`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
          });
          if (refreshResponse.ok) {
            const { token: newToken } = await refreshResponse.json();
            localStorage.setItem('token', newToken);
            headers['Authorization'] = `Bearer ${newToken}`;
            response = await fetch(`${state.API_BASE_URL}${url}`, {
              ...options,
              headers,
            });
          } else {
            throw new Error('Session expired');
          }
        }

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }

        return await response.json().catch(() => ({}));
      } catch (error) {
        if (error.message.includes('Session expired') || error.message === 'No token found') {
          utils.showToast('Session expired. Please log in again.', 'error');
          localStorage.removeItem('token');
          setTimeout(() => window.location.href = '/index.html', 2000);
        } else {
          utils.showToast(error.message, 'error');
        }
        throw error;
      }
    },

    fetchWithCache: async (url, options = {}, ttl = 5 * 60 * 1000) => {
      const cacheKey = `${url}_${JSON.stringify(options)}`;
      const cached = state.cache[cacheKey];
      if (cached && Date.now() - cached.timestamp < ttl) {
        return cached.data;
      }
      const data = await utils.fetchWithAuth(url, options);
      state.cache[cacheKey] = { data, timestamp: Date.now() };
      return data;
    },

    validateMobile: (mobile) => /^\d{10}$/.test(mobile),

    validateEmail: (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email),

    validateImage: (file) => {
      if (!file) return true;
      const validTypes = ['image/jpeg', 'image/png'];
      const maxSize = 2 * 1024 * 1024;
      const errorElement = document.getElementById('profileImageError');
      if (!validTypes.includes(file.type)) {
        errorElement.textContent = 'Please upload a JPEG or PNG image.';
        errorElement.classList.add('show');
        return false;
      }
      if (file.size > maxSize) {
        errorElement.textContent = 'Image must be under 2MB.';
        errorElement.classList.add('show');
        return false;
      }
      errorElement.classList.remove('show');
      return true;
    },

    uploadImage: async (file) => {
      if (!file) return state.user?.image || defaultProfileImage;
      if (!utils.validateImage(file)) throw new Error('Invalid image');
      const formData = new FormData();
      formData.append('image', file);
      try {
        const response = await utils.fetchWithAuth('/api/user/upload', {
          method: 'POST',
          body: formData,
        });
        if (!response.url || !response.url.startsWith('https://res.cloudinary.com/')) {
          throw new Error('Invalid image URL');
        }
        return response.url;
      } catch (error) {
        utils.showToast('Image upload failed', 'error');
        return state.user?.image || defaultProfileImage;
      }
    },

    formatDate: (date) => {
      const d = new Date(date);
      const pad = (n) => n.toString().padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    },
  };

  const ui = {
    toggleDropdown: () => {
      const dropdown = document.getElementById('profileDropdown');
      const isOpen = dropdown.classList.contains('show');
      dropdown.classList.toggle('show');
      dropdown.setAttribute('aria-expanded', !isOpen);
    },

    openModal: (modalId) => {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      modal.style.display = 'flex';
      if (modalId === 'favoritesModal') data.loadFavorites();
      else if (modalId === 'cartModal') {
        data.loadCart();
        data.loadAddresses();
      } else if (modalId === 'profileModal') {
        ui.loadProfile();
      } else if (modalId === 'addressModal') {
        data.loadAddresses();
      }
      document.getElementById('profileDropdown').classList.remove('show');
    },

    closeModal: (modalId) => {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      modal.style.display = 'none';
      if (modalId === 'cartModal') {
        document.getElementById('couponCode').classList.remove('valid', 'invalid');
        document.getElementById('couponError').classList.remove('show');
      }
    },

    toggleDarkMode: () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
      utils.showToast(`Switched to ${document.body.classList.contains('dark-mode') ? 'Dark' : 'Light'} Mode`, 'success');
      document.getElementById('profileDropdown').classList.remove('show');
    },

    loadDarkMode: () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
    },

    populateAddressForm: (address = {}) => {
      document.getElementById('addressId').value = address.id || '';
      document.getElementById('fullName').value = address.fullName || '';
      document.getElementById('addressMobile').value = address.phone || '';
      document.getElementById('houseNo').value = address.street || '';
      document.getElementById('addressLocation').value = address.city || '';
      document.getElementById('landmark').value = address.landmark || '';
      document.getElementById('addressFormTitle').textContent = address.id ? 'Edit Address' : 'Add New Address';
      document.getElementById('submitAddressBtn').textContent = address.id ? 'Update Address' : 'Add Address';
    },

    loadProfile: () => {
      document.getElementById('profileName').value = state.user?.name || '';
      document.getElementById('profileEmail').value = state.user?.email || '';
      document.getElementById('mobile').value = state.user?.mobile || '';
      document.getElementById('profileModalImg').src = sanitizeImageUrl(state.user?.image);
      document.getElementById('profileImg').src = sanitizeImageUrl(state.user?.image);
      document.getElementById('profileImageError').classList.remove('show');
    },

    toggleCartLoading: (isLoading) => {
      state.cartUpdating = isLoading;
      const cartItems = document.getElementById('cartItems');
      const placeOrderBtn = document.getElementById('placeOrderBtn');
      if (isLoading) {
        cartItems.classList.add('loading');
        placeOrderBtn.disabled = true;
      } else {
        cartItems.classList.remove('loading');
        placeOrderBtn.disabled = state.cart.length === 0;
      }
    },

    updateCartCount: () => {
      const count = state.cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
      document.getElementById('cartCount').textContent = count;
    },
  };

  const data = {
    checkAuth: () => !!localStorage.getItem('token'),

    loadProfile: async () => {
      try {
        state.user = await utils.fetchWithCache('/api/user/profile');
        document.getElementById('userName').textContent = sanitizeInput(state.user.name) || 'User';
        ui.loadProfile();
      } catch (error) {
        utils.showToast('Failed to load profile', 'error');
      }
    },

    updateProfile: async () => {
      const name = document.getElementById('profileName').value.trim();
      const email = document.getElementById('profileEmail').value.trim();
      const imageInput = document.getElementById('profileImage').files[0];
      if (!name || !email) {
        return utils.showToast('Name and Email are required', 'error');
      }
      if (!utils.validateEmail(email)) {
        return utils.showToast('Invalid email format', 'error');
      }
      try {
        const body = { name, email };
        if (imageInput) {
          body.image = await utils.uploadImage(imageInput);
        }
        state.user = await utils.fetchWithAuth('/api/user/profile', {
          method: 'PUT',
          body: JSON.stringify(body),
        });
        document.getElementById('userName').textContent = sanitizeInput(state.user.name);
        ui.loadProfile();
        document.getElementById('profileImage').value = '';
        utils.showToast('Profile updated successfully', 'success');
        ui.closeModal('profileModal');
      } catch (error) {
        utils.showToast('Failed to update profile', 'error');
      }
    },

    loadAddresses: async () => {
      try {
        state.addresses = await utils.fetchWithCache('/api/user/addresses');
        const addressSelect = document.getElementById('cartAddressSelect');
        const addressList = document.getElementById('addressList');
        addressSelect.innerHTML = '<option value="">Select Address</option>';
        addressList.innerHTML = '';
        state.addresses.forEach(addr => {
          const addrString = getAddressString(addr);
          addressSelect.innerHTML += `<option value="${addr.id}">${addrString}</option>`;
          addressList.innerHTML += `
            <div class="order-card flex justify-between items-center">
              <p class="text-sm">${addrString}</p>
              <div class="flex gap-2">
                <button class="btn-primary text-xs" onclick="data.editAddress(${addr.id})" aria-label="Edit Address">Edit</button>
                <button class="btn-secondary text-xs" onclick="data.deleteAddress(${addr.id})" aria-label="Delete Address">Delete</button>
              </div>
            </div>
          `;
        });
      } catch (error) {
        utils.showToast('Failed to load addresses', 'error');
      }
    },

    addOrUpdateAddress: async (e) => {
      e.preventDefault();
      const id = document.getElementById('addressId').value;
      const fullName = sanitizeInput(document.getElementById('fullName').value.trim());
      const mobile = sanitizeInput(document.getElementById('addressMobile').value.trim());
      const houseNo = sanitizeInput(document.getElementById('houseNo').value.trim());
      const location = sanitizeInput(document.getElementById('addressLocation').value.trim());
      const landmark = sanitizeInput(document.getElementById('landmark').value.trim());
      if (!fullName || !mobile || !houseNo || !location) {
        return utils.showToast('Please fill all required fields', 'error');
      }
      if (!utils.validateMobile(mobile)) {
        return utils.showToast('Invalid mobile number', 'error');
      }
      try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/user/addresses/${id}` : '/api/user/addresses';
        const response = await utils.fetchWithAuth(url, {
          method,
          body: JSON.stringify({ fullName, phone: mobile, street: houseNo, city: location, landmark }),
        });
        if (id) {
          state.addresses = state.addresses.map(addr => addr.id === parseInt(id) ? response : addr);
        } else {
          state.addresses.push(response);
        }
        utils.showToast(id ? 'Address updated' : 'Address added', 'success');
        document.getElementById('addressForm').reset();
        ui.populateAddressForm();
        data.loadAddresses();
      } catch (error) {
        utils.showToast('Failed to save address', 'error');
      }
    },

    editAddress: (id) => {
      const address = state.addresses.find(addr => addr.id === parseInt(id));
      if (!address) {
        return utils.showToast('Address not found', 'error');
      }
      ui.populateAddressForm(address);
    },

    deleteAddress: async (id) => {
      if (!confirm('Are you sure you want to delete this address?')) return;
      try {
        await utils.fetchWithAuth(`/api/user/addresses/${id}`, { method: 'DELETE' });
        state.addresses = state.addresses.filter(addr => addr.id !== parseInt(id));
        utils.showToast('Address deleted', 'success');
        data.loadAddresses();
      } catch (error) {
        utils.showToast('Failed to delete address', 'error');
      }
    },

    loadMenu: async () => {
      try {
        state.menuItems = await utils.fetchWithCache('/api/user/menu');
        data.renderMenu();
      } catch (error) {
        utils.showToast('Failed to load menu', 'error');
      }
    },

    renderMenu: (items = state.menuItems) => {
      const menuContainer = document.getElementById('menuItems');
      menuContainer.innerHTML = '';
      if (!items || items.length === 0) {
        menuContainer.innerHTML = '<p class="text-center text-sm">No items found.</p>';
        return;
      }
      items.forEach(item => {
        const isFavorite = state.favorites.some(fav => fav.itemId === item.id);
        menuContainer.innerHTML += `
          <div class="menu-card">
            <img src="${sanitizeImageUrl(item.image)}" alt="${sanitizeInput(item.name)}" class="w-full h-32 object-cover rounded-md mb-2" loading="lazy" onerror="this.src='${placeholderImage}'">
            <h3 class="text-sm font-medium" style="font-family: 'Playfair Display', serif;">${sanitizeInput(item.name)}</h3>
            <p class="text-xs mb-1">${sanitizeInput(item.description) || 'No description'}</p>
            <p class="text-purple-600 font-bold text-sm mb-2">₹${parseFloat(item.price || 0).toFixed(2)}</p>
            <div class="flex flex-col gap-2">
              <button class="btn-primary text-xs" onclick="data.addToCart(${item.id}, '${sanitizeInput(item.name)}', ${item.price}, '${sanitizeImageUrl(item.image)}')" aria-label="Add ${sanitizeInput(item.name)} to Cart">Add to Cart</button>
              <button class="btn-secondary text-xs" onclick="${isFavorite ? `data.removeFromFavorites(${item.id})` : `data.addToFavorites(${item.id}, '${sanitizeInput(item.name)}', '${sanitizeImageUrl(item.image)}', ${item.price})`}" aria-label="${isFavorite ? 'Remove' : 'Add'} ${sanitizeInput(item.name)} to Favorites">${isFavorite ? 'Remove' : 'Favorite'}</button>
            </div>
          </div>
        `;
      });
    },

    searchMenu: () => {
      const query = sanitizeInput(document.getElementById('menuSearch').value.toLowerCase());
      const filteredItems = state.menuItems.filter(item => item.name.toLowerCase().includes(query));
      data.renderMenu(filteredItems);
    },

    filterCategory: () => {
      const category = document.getElementById('categoryFilter').value;
      const filteredItems = category ? state.menuItems.filter(item => item.category === category) : state.menuItems;
      data.renderMenu(filteredItems);
    },

    loadCoupons: async () => {
      try {
        state.coupons = await utils.fetchWithCache('/api/user/coupons');
        const couponsList = document.getElementById('couponsList');
        couponsList.innerHTML = '';
        if (!state.coupons || state.coupons.length === 0) {
          couponsList.innerHTML = '<p class="text-center text-sm">No coupons available.</p>';
          return;
        }
        state.coupons.forEach(coupon => {
          couponsList.innerHTML += `
            <div class="coupon-card">
              <img src="${sanitizeImageUrl(coupon.image)}" alt="${sanitizeInput(coupon.code)}" class="w-full h-20 object-cover rounded-md mb-2" loading="lazy" onerror="this.src='${placeholderImage}'">
              <h3 class="text-sm font-medium">${sanitizeInput(coupon.code)}</h3>
              <p class="text-xs mb-2">${coupon.discount}% OFF</p>
              <button class="btn-primary w-full text-xs" onclick="data.applyCouponFromList('${sanitizeInput(coupon.code)}', ${coupon.discount})" aria-label="Apply Coupon ${sanitizeInput(coupon.code)}">Apply Coupon</button>
            </div>
          `;
        });
      } catch (error) {
        utils.showToast('Failed to load coupons', 'error');
      }
    },

    loadFavorites: async () => {
      try {
        state.favorites = await utils.fetchWithCache('/api/user/favorites');
        data.renderFavorites();
        data.renderMenu();
      } catch (error) {
        utils.showToast('Failed to load favorites', 'error');
      }
    },

    renderFavorites: () => {
      const favoritesList = document.getElementById('favoritesList');
      const favoritesModalList = document.getElementById('favoritesModalList');
      favoritesList.innerHTML = '';
      favoritesModalList.innerHTML = '';
      if (!state.favorites || state.favorites.length === 0) {
        favoritesList.innerHTML = '<p class="text-center text-sm">No favorites yet.</p>';
        favoritesModalList.innerHTML = '<p class="text-center text-sm">No favorites yet.</p>';
        return;
      }
      state.favorites.forEach(item => {
        const cardHTML = `
          <div class="favorite-card flex items-center gap-2">
            <img src="${sanitizeImageUrl(item.image)}" alt="${sanitizeInput(item.name)}" class="w-12 h-12 object-cover rounded-md" loading="lazy" onerror="this.src='${placeholderImage}'">
            <div class="flex-1">
              <h3 class="text-sm font-medium">${sanitizeInput(item.name)}</h3>
              <p class="text-xs">₹${parseFloat(item.price || 0).toFixed(2)}</p>
            </div>
            <div class="flex flex-col gap-2">
              <button class="btn-primary text-xs" onclick="data.addToCart(${item.itemId}, '${sanitizeInput(item.name)}', ${item.price}, '${sanitizeImageUrl(item.image)}')" aria-label="Add ${sanitizeInput(item.name)} to Cart">Add to Cart</button>
              <button class="btn-secondary text-xs" onclick="data.removeFromFavorites(${item.itemId})" aria-label="Remove ${sanitizeInput(item.name)} from Favorites">Remove</button>
            </div>
          </div>
        `;
        favoritesList.innerHTML += cardHTML;
        favoritesModalList.innerHTML += cardHTML;
      });
    },

    addToFavorites: async (id, name, image, price) => {
      try {
        await utils.fetchWithAuth('/api/user/favorites', {
          method: 'POST',
          body: JSON.stringify({ itemId: id, name: sanitizeInput(name), image: sanitizeImageUrl(image), price }),
        });
        utils.showToast(`${sanitizeInput(name)} added to favorites`, 'success');
        await data.loadFavorites();
      } catch (error) {
        utils.showToast('Failed to add favorite', 'error');
      }
    },

    removeFromFavorites: async (id) => {
      try {
        await utils.fetchWithAuth(`/api/user/favorites/${id}`, { method: 'DELETE' });
        state.favorites = state.favorites.filter(fav => fav.itemId !== id);
        utils.showToast('Removed from favorites', 'success');
        data.renderFavorites();
        data.renderMenu();
      } catch (error) {
        utils.showToast('Failed to remove favorite', 'error');
      }
    },

    loadCart: async () => {
      try {
        ui.toggleCartLoading(true);
        const response = await utils.fetchWithCache('/api/user/cart');
        state.cart = response.items || [];
        data.renderCart();
        ui.updateCartCount();
      } catch (error) {
        utils.showToast('Failed to load cart', 'error');
      } finally {
        ui.toggleCartLoading(false);
      }
    },

    renderCart: () => {
      const cartItems = document.getElementById('cartItems');
      cartItems.innerHTML = '';
      let originalTotal = 0;
      state.cart.forEach(item => {
        originalTotal += item.price * (item.quantity || 1);
        cartItems.innerHTML += `
          <div class="order-card flex items-center gap-2 mb-2">
            <img src="${sanitizeImageUrl(item.image)}" alt="${sanitizeInput(item.name)}" class="w-12 h-12 object-cover rounded-md" loading="lazy" onerror="this.src='${placeholderImage}'">
            <div class="flex-1">
              <h3 class="text-sm font-medium">${sanitizeInput(item.name)}</h3>
              <p class="text-xs mb-1">${sanitizeInput(item.description) || 'No description'}</p>
              <p class="text-purple-600 font-bold text-sm">₹${parseFloat(item.price * (item.quantity || 1)).toFixed(2)} (₹${parseFloat(item.price).toFixed(2)} x ${item.quantity || 1})</p>
              <div class="flex items-center gap-2 mt-1">
                <button class="btn-quantity" onclick="data.updateQuantity(${item.id}, ${(item.quantity || 1) - 1})" aria-label="Decrease quantity of ${sanitizeInput(item.name)}">-</button>
                <span class="text-xs">${item.quantity || 1}</span>
                <button class="btn-quantity" onclick="data.updateQuantity(${item.id}, ${(item.quantity || 1) + 1})" aria-label="Increase quantity of ${sanitizeInput(item.name)}">+</button>
              </div>
            </div>
            <button class="btn-secondary text-xs" onclick="data.removeFromCart(${item.id})" aria-label="Remove ${sanitizeInput(item.name)} from Cart">Remove</button>
          </div>
        `;
      });
      const discount = state.appliedCoupon ? (originalTotal * state.appliedCoupon.discount) / 100 : 0;
      const finalTotal = originalTotal - discount;
      document.getElementById('cartOriginalTotal').textContent = originalTotal.toFixed(2);
      document.getElementById('cartDiscount').textContent = discount.toFixed(2);
      document.getElementById('cartDelivery').textContent = '0.00';
      document.getElementById('cartFinalTotal').textContent = finalTotal.toFixed(2);
      if (state.cart.length === 0) {
        cartItems.innerHTML = '<p class="text-center text-sm">Your cart is empty.</p>';
      }
      document.getElementById('placeOrderBtn').disabled = state.cart.length === 0;
      ui.updateCartCount();
    },

    addToCart: async (id, name, price, image) => {
      if (state.cartUpdating) return;
      try {
        ui.toggleCartLoading(true);
        const existingItem = state.cart.find(item => item.itemId === id);
        if (existingItem) {
          await data.updateQuantity(existingItem.id, (existingItem.quantity || 1) + 1);
        } else {
          const response = await utils.fetchWithAuth('/api/user/cart', {
            method: 'POST',
            body: JSON.stringify({
              itemId: id,
              name: sanitizeInput(name),
              price: parseFloat(price),
              image: sanitizeImageUrl(image),
              quantity: 1,
            }),
          });
          state.cart.push(response);
          utils.showToast(`${sanitizeInput(name)} added to cart`, 'success');
        }
        await data.loadCart();
      } catch (error) {
        utils.showToast('Failed to add to cart', 'error');
      } finally {
        ui.toggleCartLoading(false);
      }
    },

    updateQuantity: async (id, newQuantity) => {
      if (state.cartUpdating) return;
      try {
        ui.toggleCartLoading(true);
        if (newQuantity < 1) {
          await data.removeFromCart(id);
          return;
        }
        await utils.fetchWithAuth(`/api/user/cart/${id}`, {
          method: 'PUT',
          body: JSON.stringify({ quantity: newQuantity }),
        });
        state.cart = state.cart.map(item => item.id === id ? { ...item, quantity: newQuantity } : item);
        utils.showToast('Quantity updated', 'success');
        data.renderCart();
      } catch (error) {
        utils.showToast('Failed to update quantity', 'error');
      } finally {
        ui.toggleCartLoading(false);
      }
    },

    removeFromCart: async (id) => {
      if (state.cartUpdating) return;
      try {
        ui.toggleCartLoading(true);
        await utils.fetchWithAuth(`/api/user/cart/${id}`, { method: 'DELETE' });
        state.cart = state.cart.filter(item => item.id !== id);
        utils.showToast('Item removed from cart', 'success');
        data.renderCart();
      } catch (error) {
        utils.showToast('Failed to remove item', 'error');
      } finally {
        ui.toggleCartLoading(false);
      }
    },

    clearCart: async () => {
      if (state.cartUpdating || state.cart.length === 0) return;
      if (!confirm('Are you sure you want to clear your cart?')) return;
      try {
        ui.toggleCartLoading(true);
        await utils.fetchWithAuth('/api/user/cart', { method: 'DELETE' });
        state.cart = [];
        state.appliedCoupon = null;
        utils.showToast('Cart cleared', 'success');
        data.renderCart();
      } catch (error) {
        utils.showToast('Failed to clear cart', 'error');
      } finally {
        ui.toggleCartLoading(false);
      }
    },

    clearOrderHistory: async () => {
      if (state.orders.length === 0) return;
      if (!confirm('Are you sure you want to clear your order history?')) return;
      try {
        await utils.fetchWithAuth('/api/user/orders', { method: 'DELETE' });
        state.orders = [];
        utils.showToast('Order history cleared', 'success');
        data.renderActiveOrders();
        data.renderOrderHistory();
      } catch (error) {
        utils.showToast('Failed to clear order history', 'error');
      }
    },

    validateCoupon: () => {
      const couponInput = document.getElementById('couponCode');
      const couponError = document.getElementById('couponError');
      const code = sanitizeInput(couponInput.value.trim().toUpperCase());
      if (!code) {
        couponInput.classList.remove('valid', 'invalid');
        couponError.classList.remove('show');
        return;
      }
      const validCoupon = state.coupons.find(c => c.code === code);
      if (validCoupon) {
        couponInput.classList.add('valid');
        couponInput.classList.remove('invalid');
        couponError.classList.remove('show');
      } else {
        couponInput.classList.add('invalid');
        couponInput.classList.remove('valid');
        couponError.textContent = 'Invalid coupon code';
        couponError.classList.add('show');
      }
    },

    applyCoupon: async () => {
      const code = sanitizeInput(document.getElementById('couponCode').value.trim().toUpperCase());
      if (!code) {
        return utils.showToast('Please enter a coupon code', 'error');
      }
      try {
        const response = await utils.fetchWithAuth(`/api/user/coupons/apply?code=${encodeURIComponent(code)}`);
        state.appliedCoupon = { code, discount: response.discount };
        utils.showToast(`Coupon ${code} applied! ${response.discount}% off`, 'success');
        data.renderCart();
      } catch (error) {
        utils.showToast('Failed to apply coupon', 'error');
        document.getElementById('couponError').textContent = 'Invalid coupon code';
        document.getElementById('couponError').classList.add('show');
      }
    },

    applyCouponFromList: async (code, discount) => {
      try {
        state.appliedCoupon = { code: sanitizeInput(code), discount };
        utils.showToast(`Coupon ${sanitizeInput(code)} applied! ${discount}% off`, 'success');
        data.renderCart();
        ui.closeModal('cartModal');
        ui.openModal('cartModal');
        document.getElementById('couponCode').value = code;
        document.getElementById('couponCode').classList.add('valid');
      } catch (error) {
        utils.showToast('Failed to apply coupon', 'error');
      }
    },

    placeOrder: async (paymentMethod) => {
      if (state.cartUpdating || state.cart.length === 0) return;
      const addressId = document.getElementById('cartAddressSelect').value;
      if (!addressId) {
        return utils.showToast('Please select a delivery address', 'error');
      }
      try {
        ui.toggleCartLoading(true);
        const address = state.addresses.find(addr => addr.id === parseInt(addressId));
        const orderData = {
          items: state.cart.map(item => ({
            itemId: item.itemId,
            quantity: item.quantity || 1,
            price: item.price,
            name: sanitizeInput(item.name),
          })),
          address: getAddressString(address),
          addressId: parseInt(addressId),
          couponCode: state.appliedCoupon ? state.appliedCoupon.code : null,
          paymentMethod,
        };
        const response = await utils.fetchWithAuth('/api/user/orders', {
          method: 'POST',
          body: JSON.stringify(orderData),
        });
        state.cart = [];
        state.appliedCoupon = null;
        document.getElementById('couponCode').value = '';
        document.getElementById('cartAddressSelect').value = '';
        utils.showToast(`Order #${response.orderId} placed successfully`, 'success');
        data.renderCart();
        data.loadOrders();
        ui.closeModal('cartModal');
      } catch (error) {
        utils.showToast('Failed to place order', 'error');
      } finally {
        ui.toggleCartLoading(false);
      }
    },

    loadOrders: async () => {
      try {
        state.orders = await utils.fetchWithCache('/api/user/orders');
        document.getElementById('totalOrders').textContent = state.orders.length;
        data.renderActiveOrders();
        data.renderOrderHistory();
      } catch (error) {
        utils.showToast('Failed to load orders', 'error');
      }
    },

    renderActiveOrders: () => {
      const activeOrders = document.getElementById('activeOrders');
      const active = state.orders.filter(order => order.status !== 'Delivered' && order.status !== 'Cancelled');
      activeOrders.innerHTML = '';
      if (!active.length) {
        activeOrders.innerHTML = '<p class="text-center text-sm">No active orders.</p>';
        return;
      }
      active.forEach(order => {
        activeOrders.innerHTML += `
          <div class="order-card">
            <div class="flex justify-between items-center">
              <h3 class="text-sm font-medium">Order #${order.orderId}</h3>
              <span class="text-xs ${order.status === 'Pending' ? 'text-yellow-600' : order.status === 'Confirmed' ? 'text-blue-600' : order.status === 'Out for Delivery' ? 'text-purple-600' : 'text-green-600'}">${sanitizeInput(order.status)}</span>
            </div>
            <p class="text-xs mb-1">${getAddressString(order.address)}</p>
            <p class="text-xs mb-1">Total: ₹${parseFloat(order.total || 0).toFixed(2)}</p>
            <p class="text-xs mb-2">Placed on: ${utils.formatDate(order.createdAt)}</p>
            <div class="tracking-bar">
              <div class="tracking-step ${order.status === 'Pending' ? 'active' : 'inactive'}">Pending</div>
              <div class="tracking-step ${order.status === 'Confirmed' ? 'active' : 'inactive'}">Confirmed</div>
              <div class="tracking-step ${order.status === 'Out for Delivery' ? 'active' : 'inactive'}">Out for Delivery</div>
              <div class="tracking-step ${order.status === 'Delivered' ? 'active' : 'inactive'}">Delivered</div>
            </div>
            <div class="flex gap-2 mt-2">
              <button class="btn-primary text-xs" onclick="data.trackOrder(${order.orderId})" aria-label="Track Order #${order.orderId}">Track</button>
              ${order.status !== 'Cancelled' && order.status !== 'Delivered' ? `<button class="btn-secondary text-xs" onclick="data.openCancelOrderModal(${order.orderId})" aria-label="Cancel Order #${order.orderId}">Cancel</button>` : ''}
            </div>
          </div>
        `;
      });
    },

    renderOrderHistory: () => {
      const orderHistory = document.getElementById('orderHistory');
      const history = state.orders.filter(order => order.status === 'Delivered' || order.status === 'Cancelled');
      orderHistory.innerHTML = '';
      if (!history.length) {
        orderHistory.innerHTML = '<p class="text-center text-sm">No order history.</p>';
        return;
      }
      history.forEach(order => {
        orderHistory.innerHTML += `
          <div class="order-card">
            <div class="flex justify-between items-center">
              <h3 class="text-sm font-medium">Order #${order.orderId}</h3>
              <span class="text-xs ${order.status === 'Delivered' ? 'text-green-600' : 'text-red-600'}">${sanitizeInput(order.status)}</span>
            </div>
            <p class="text-xs mb-1">${getAddressString(order.address)}</p>
            <p class="text-xs mb-1">Total: ₹${parseFloat(order.total || 0).toFixed(2)}</p>
            <p class="text-xs mb-2">Date: ${utils.formatDate(order.createdAt)}</p>
            <button class="btn-primary text-xs" onclick="data.trackOrder(${order.orderId})" aria-label="View Details of Order #${order.orderId}">View Details</button>
          </div>
        `;
      });
    },

    openCancelOrderModal: (orderId) => {
      document.getElementById('orderId').value = orderId;
      ui.openModal('cancelOrderModal');
    },

    cancelOrder: async (e) => {
      e.preventDefault();
      const orderId = document.getElementById('orderId').value;
      const reason = sanitizeInput(document.getElementById('cancelReason').value.trim());
      if (!reason) {
        return utils.showToast('Please provide a cancellation reason', 'error');
      }
      try {
        await utils.fetchWithAuth(`/api/user/orders/${orderId}/cancel`, {
          method: 'PUT',
          body: JSON.stringify({ reason }),
        });
        state.orders = state.orders.map(order => order.orderId === parseInt(orderId) ? { ...order, status: 'Cancelled', reason } : order);
        utils.showToast('Order cancelled successfully', 'success');
        document.getElementById('cancelOrderForm').reset();
        ui.closeModal('cancelOrderModal');
        data.renderActiveOrders();
        data.renderOrderHistory();
      } catch (error) {
        utils.showToast(error.message || 'Failed to cancel order', 'error');
      }
    },

    trackOrder: async (orderId) => {
      try {
        const order = state.orders.find(o => o.orderId === parseInt(orderId));
        if (!order) throw new Error('Order not found');
        document.getElementById('trackOrderId').textContent = order.orderId;
        const trackDetails = document.getElementById('trackOrderDetails');
        trackDetails.innerHTML = `
          <p class="text-sm mb-1"><strong>Status:</strong> <span class="${order.status === 'Pending' ? 'text-yellow-600' : order.status === 'Confirmed' ? 'text-blue-600' : order.status === 'Out for Delivery' ? 'text-purple-600' : order.status === 'Delivered' ? 'text-green-600' : 'text-red-600'}">${sanitizeInput(order.status)}</span></p>
          <p class="text-sm mb-1"><strong>Address:</strong> ${getAddressString(order.address)}</p>
          <p class="text-sm mb-1"><strong>Total:</strong> ₹${parseFloat(order.total || 0).toFixed(2)}</p>
          <p class="text-sm mb-2"><strong>Placed on:</strong> ${utils.formatDate(order.createdAt)}</p>
          <h3 class="text-sm font-medium mb-2">Items:</h3>
          ${order.items.map(item => `
            <div class="flex items-center gap-2 mb-2">
              <img src="${sanitizeImageUrl(item.image)}" alt="${sanitizeInput(item.name)}" class="w-10 h-10 object-cover rounded-md" loading="lazy" onerror="this.src='${placeholderImage}'">
              <div>
                <p class="text-xs font-medium">${sanitizeInput(item.name)}</p>
                <p class="text-xs">₹${parseFloat(item.price || 0).toFixed(2)} x ${item.quantity}</p>
              </div>
            </div>
          `).join('')}
          ${order.couponCode ? `<p class="text-sm mb-2"><strong>Coupon Applied:</strong> ${sanitizeInput(order.couponCode)}</p>` : ''}
          ${order.reason ? `<p class="text-sm mb-2"><strong>Cancellation Reason:</strong> ${sanitizeInput(order.reason)}</p>` : ''}
        `;
        ui.openModal('trackOrderModal');
      } catch (error) {
        utils.showToast(error.message || 'Failed to load order details', 'error');
      }
    },

    refreshOrders: async () => {
      try {
        await data.loadOrders();
        utils.showToast('Orders refreshed', 'success');
      } catch (error) {
        utils.showToast(error.message || 'Failed to refresh orders', 'error');
      }
    },

    logout: async () => {
      try {
        await utils.fetchWithAuth('/api/user/logout', { method: 'POST' });
        localStorage.removeItem('token');
        window.location.href = '/index.html';
      } catch (error) {
        utils.showToast(error.message || 'Failed to logout', 'error');
      }
    },
  };

  const init = async () => {
    if (!data.checkAuth()) {
      window.location.href = '/index.html';
      return;
    }
    ui.loadDarkMode();
    try {
      await Promise.all([
        data.loadProfile(),
        data.loadMenu(),
        data.loadCoupons(),
        data.loadFavorites(),
        data.loadCart(),
        data.loadOrders(),
        data.loadAddresses(),
      ]);
    } catch (error) {
      console.error('Initialization error:', error);
      utils.showToast('Failed to initialize dashboard', 'error');
    }
    document.getElementById('addressForm').addEventListener('submit', data.addOrUpdateAddress);
    document.getElementById('cancelOrderForm').addEventListener('submit', data.cancelOrder);
  };

  const debounceSearch = utils.debounce(data.searchMenu, 300);

  document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('profileDropdown');
    const profileImg = document.getElementById('profileImg');
    if (!dropdown.contains(e.target) && !profileImg.contains(e.target)) {
      dropdown.classList.remove('show');
      dropdown.setAttribute('aria-expanded', 'false');
    }
  });

  window.addEventListener('load', init);
  </script>
</body>
</html>