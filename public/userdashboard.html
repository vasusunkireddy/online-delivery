<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delicute - User Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f0f2f6 0%, #e5e7eb 100%);
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
        }
        body.dark-mode {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: #e5e7eb;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 16px;
            max-width: 90%;
            width: 500px;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }
        body.dark-mode .modal-content {
            background: #374151;
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 24px;
            cursor: pointer;
            color: #374151;
            transition: color 0.2s;
        }
        body.dark-mode .close-btn {
            color: #e5e7eb;
        }
        .close-btn:hover {
            color: #f59e0b;
        }
        .toast {
            position: fixed;
            top: 16px;
            right: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            z-index: 2000;
            display: none;
            min-width: 200px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s ease-in;
        }
        .toast.success {
            background-color: #22c55e;
        }
        .toast.error {
            background-color: #ef4444;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .btn-primary {
            background: linear-gradient(90deg, #f59e0b, #d97706);
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            transition: background 0.3s, transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary:hover {
            background: linear-gradient(90deg, #d97706, #f59e0b);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: linear-gradient(90deg, #6b7280, #4b5563);
            color: white;
            padding: 8px 16px;
            border-radius: 9999px;
            transition: background 0.3s, transform 0.2s;
        }
        .btn-secondary:hover {
            background: linear-gradient(90deg, #4b5563, #6b7280);
            transform: translateY(-2px);
        }
        .input-field {
            transition: border-color 0.3s, box-shadow 0.3s;
            border-radius: 8px;
            border: 1px solid #d1d5db;
        }
        .input-field:focus {
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
            outline: none;
        }
        .navbar-menu {
            transition: max-height 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
        }
        .navbar-menu.active {
            max-height: 400px;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .menu-card, .coupon-card, .cart-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        body.dark-mode .menu-card, body.dark-mode .coupon-card, body.dark-mode .cart-card {
            background: #374151;
        }
        .menu-card:hover, .coupon-card:hover, .cart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .menu-card img, .coupon-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            object-position: center;
        }
        .cart-card img {
            height: 80px;
            width: 80px;
            border-radius: 8px;
            object-fit: cover;
        }
        .coupon-card {
            border: 2px solid #f59e0b;
        }
        body.dark-mode .coupon-card {
            border-color: #d97706;
        }
        .special-coupon {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #d97706;
        }
        body.dark-mode .special-coupon {
            background: linear-gradient(135deg, #4b5563, #6b7280);
        }
        .address-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark-mode .address-card {
            background: #374151;
        }
        .address-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        .dropdown {
            position: relative;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
        }
        body.dark-mode .dropdown-content {
            background: #374151;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        .dropdown-content a, .dropdown-content button {
            color: #374151;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background 0.2s;
        }
        body.dark-mode .dropdown-content a, body.dark-mode .dropdown-content button {
            color: #e5e7eb;
        }
        .dropdown-content a:hover, .dropdown-content button:hover {
            background: #f3f4f6;
        }
        body.dark-mode .dropdown-content a:hover, body.dark-mode .dropdown-content button:hover {
            background: #4b5563;
        }
        .rating-stars {
            color: #f59e0b;
        }
        .welcome-message {
            background: linear-gradient(90deg, #f59e0b, #d97706);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 24px;
        }
        .profile-card {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 32px;
            transform: perspective(1000px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark-mode .profile-card {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
        }
        .profile-card:hover {
            transform: perspective(1000px) translateY(-10px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
        }
        .profile-image-container {
            position: relative;
            display: inline-block;
        }
        .profile-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(245, 158, 11, 0.2);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .profile-image-container:hover .profile-image-overlay {
            opacity: 1;
        }
        .cart-container {
            background: linear-gradient(135deg, #ffffff, #f9fafb);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        body.dark-mode .cart-container {
            background: linear-gradient(135deg, #374151, #4b5563);
        }
        .cart-item {
            display: flex;
            align-items: center;
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 12px;
            background: white;
            transition: transform 0.3s ease;
        }
        body.dark-mode .cart-item {
            background: #4b5563;
        }
        .cart-item:hover {
            transform: translateY(-3px);
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f3f4f6;
            border-radius: 9999px;
            padding: 4px 8px;
        }
        body.dark-mode .quantity-controls {
            background: #6b7280;
        }
        .quantity-btn {
            background: none;
            color: #f59e0b;
            font-size: 18px;
            padding: 4px 8px;
            transition: color 0.2s;
        }
        .quantity-btn:hover {
            color: #d97706;
        }
        .cart-summary {
            background: #fef3c7;
            border-radius: 12px;
            padding: 16px;
            margin-top: 24px;
        }
        body.dark-mode .cart-summary {
            background: #4b5563;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        @media (max-width: 640px) {
            .modal-content {
                padding: 16px;
                width: 95%;
            }
            .toast {
                top: 12px;
                right: 12px;
                padding: 10px;
                min-width: 160px;
            }
            .navbar-menu {
                max-height: 0;
                overflow: hidden;
            }
            .navbar-menu.active {
                max-height: 400px;
            }
            .dropdown-content {
                width: 100%;
            }
            .menu-card img, .coupon-card img {
                height: 150px;
            }
            .cart-card img {
                height: 60px;
                width: 60px;
            }
            .cart-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .cart-item img {
                width: 100%;
                height: 120px;
            }
            .quantity-controls {
                width: 100%;
                justify-content: center;
            }
            .cart-summary {
                padding: 12px;
            }
            .profile-card {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Navbar -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center space-x-3">
                    <img src="https://i.postimg.cc/zv19J0xv/Zbhz-Fq-T-Imgur.jpg" alt="Delicute Logo" class="h-10">
                    <div>
                        <h1 class="text-xl font-bold text-gray-800 sm:text-2xl">DELICUTE</h1>
                        <p class="text-xs text-gray-500 sm:text-sm">Every bite tells a story</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="dropdown">
                        <button class="flex items-center space-x-2 text-gray-600 hover:text-gray-900">
                            <img id="headerProfileImage" src="https://via.placeholder.com/100" alt="Profile" class="h-10 w-10 rounded-full object-cover">
                        </button>
                        <div class="dropdown-content">
                            <a href="#" onclick="showSection('home')">Home</a>
                            <a href="#" onclick="showSection('cart')">Cart</a>
                            <a href="#" onclick="showSection('orders')">Orders</a>
                            <a href="#" onclick="showSection('favorites')">Favorites</a>
                            <a href="#" onclick="showSection('orderHistory')">Order History</a>
                            <a href="#" onclick="showSection('profile')">Profile</a>
                            <a href="#" onclick="showSection('addresses')">Addresses</a>
                            <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
                            <button onclick="logout()">Logout</button>
                        </div>
                    </div>
                    <div class="sm:hidden">
                        <button id="menuToggle" class="text-gray-600 hover:text-gray-900 focus:outline-none">
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div id="navbarMenu" class="navbar-menu sm:hidden">
                <div class="flex flex-col space-y-2 px-4 pb-4">
                    <a href="#" onclick="showSection('home')" class="text-gray-600 hover:text-gray-900 text-sm">Home</a>
                    <a href="#" onclick="showSection('cart')" class="text-gray-600 hover:text-gray-900 text-sm">Cart</a>
                    <a href="#" onclick="showSection('orders')" class="text-gray-600 hover:text-gray-900 text-sm">Orders</a>
                    <a href="#" onclick="showSection('favorites')" class="text-gray-600 hover:text-gray-900 text-sm">Favorites</a>
                    <a href="#" onclick="showSection('orderHistory')" class="text-gray-600 hover:text-gray-900 text-sm">Order History</a>
                    <a href="#" onclick="showSection('profile')" class="text-gray-600 hover:text-gray-900 text-sm">Profile</a>
                    <a href="#" onclick="showSection('addresses')" class="text-gray-600 hover:text-gray-900 text-sm">Addresses</a>
                    <button onclick="toggleDarkMode()" class="text-gray-600 hover:text-gray-900 text-sm text-left">Toggle Dark Mode</button>
                    <button onclick="logout()" class="text-gray-600 hover:text-gray-900 text-sm text-left">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('paymentModal')">×</span>
            <h2 class="text-xl font-bold text-gray-800 text-center mb-6 sm:text-2xl">Select Payment Method</h2>
            <div class="space-y-4">
                <button onclick="initiatePayment('phonepe')" class="btn-primary w-full text-sm sm:text-base">
                    <img src="https://i.postimg.cc/15Z7fkyj/phonepe.jpg" alt="PhonePe" class="h-6">
                    Pay with PhonePe
                </button>
                <button onclick="initiatePayment('gpay')" class="btn-primary w-full text-sm sm:text-base">
                    <img src="https://i.postimg.cc/GhkNKcMR/gpay.webp" alt="Google Pay" class="h-6">
                    Pay with Google Pay
                </button>
                <button onclick="initiatePayment('cod')" class="btn-primary w-full text-sm sm:text-base">Cash on Delivery</button>
            </div>
        </div>
    </div>

    <!-- Coupon Modal -->
    <div id="couponModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('couponModal')">×</span>
            <h2 class="text-xl font-bold text-gray-800 text-center mb-6 sm:text-2xl">Apply Coupon</h2>
            <div>
                <label for="couponCode" class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">Enter Coupon Code</label>
                <input type="text" id="couponCode" class="input-field w-full p-3 border rounded-md text-sm sm:text-base" placeholder="Enter coupon code">
            </div>
            <div class="mt-6">
                <button onclick="applyCoupon()" class="btn-primary w-full text-sm sm:text-base">Apply Coupon</button>
            </div>
        </div>
    </div>

    <!-- Rate Item Modal -->
    <div id="rateModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('rateModal')">×</span>
            <h2 class="text-xl font-bold text-gray-800 text-center mb-6 sm:text-2xl">Rate Item</h2>
            <div>
                <label for="rating" class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">Rating (1-5)</label>
                <input type="number" id="rating" min="1" max="5" class="input-field w-full p-3 border rounded-md text-sm sm:text-base" placeholder="Enter rating">
                <label for="review" class="block text-gray-700 font-medium mb-2 mt-4 text-sm sm:text-base">Review (Optional)</label>
                <textarea id="review" class="input-field w-full p-3 border rounded-md text-sm sm:text-base" placeholder="Write your review"></textarea>
            </div>
            <div class="mt-6">
                <button onclick="submitRating()" class="btn-primary w-full text-sm sm:text-base">Submit Rating</button>
            </div>
        </div>
    </div>

    <!-- Order Confirmation Modal -->
    <div id="orderConfirmationModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('orderConfirmationModal')">×</span>
            <h2 class="text-xl font-bold text-gray-800 text-center mb-6 sm:text-2xl">Order Confirmed!</h2>
            <div id="orderConfirmationDetails" class="text-sm sm:text-base text-gray-600"></div>
            <div class="mt-6">
                <button onclick="closeModal('orderConfirmationModal')" class="btn-primary w-full text-sm sm:text-base">Close</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Address Modal -->
    <div id="addressModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('addressModal')">×</span>
            <h2 id="addressModalTitle" class="text-xl font-bold text-gray-800 text-center mb-6 sm:text-2xl">Add Address</h2>
            <div>
                <label for="addressFullName" class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">Full Name</label>
                <input type="text" id="addressFullName" class="input-field w-full p-3 border rounded-md text-sm sm:text-base" placeholder="Enter full name">
                <label for="addressMobile" class="block text-gray-700 font-medium mb-2 mt-4 text-sm sm:text-base">Mobile Number</label>
                <input type="tel" id="addressMobile" class="input-field w-full p-3 border rounded-md text-sm sm:text-base" placeholder="Enter mobile number">
                <label for="addressHouse" class="block text-gray-700 font-medium mb-2 mt-4 text-sm sm:text-base">House Number</label>
                <input type="text" id="addressHouse" class="input-field w-full p-3 border rounded-md text-sm sm:text-base" placeholder="Enter house number">
                <label for="addressStreet" class="block text-gray-700 font-medium mb-2 mt-4 text-sm sm:text-base">Street</label>
                <input type="text" id="addressStreet" class="input-field w-full p-3 border rounded-md text-sm sm:text-base" placeholder="Enter street">
                <label for="addressLandmark" class="block text-gray-700 font-medium mb-2 mt-4 text-sm sm:text-base">Landmark</label>
                <input type="text" id="addressLandmark" class="input-field w-full p-3 border rounded-md text-sm sm:text-base" placeholder="Enter landmark (optional)">
                <label for="addressPincode" class="block text-gray-700 font-medium mb-2 mt-4 text-sm sm:text-base">Pincode</label>
                <input type="text" id="addressPincode" class="input-field w-full p-3 border rounded-md text-sm sm:text-base" placeholder="Enter pincode">
            </div>
            <div class="mt-6 flex space-x-4">
                <button id="saveAddressBtn" onclick="saveAddress()" class="btn-primary w-full text-sm sm:text-base">Save Address</button>
                <button onclick="closeModal('addressModal')" class="btn-secondary w-full text-sm sm:text-base">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <!-- Home Section -->
        <section id="homeSection" class="section active">
            <div id="welcomeMessage" class="welcome-message text-lg sm:text-xl font-semibold"></div>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6 sm:text-3xl">Special Offers</h2>
            <div id="specialCouponItems" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 mb-12"></div>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6 sm:text-3xl">Available Coupons</h2>
            <div id="couponItems" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 mb-12"></div>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6 sm:text-3xl">Explore Our Menu</h2>
            <div class="flex flex-col sm:flex-row justify-between mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
                <input type="text" id="searchInput" class="input-field w-full sm:w-1/2 p-3 border rounded-md text-sm sm:text-base" placeholder="Search menu items...">
                <select id="categoryFilter" class="input-field w-full sm:w-1/4 p-3 border rounded-md text-sm sm:text-base">
                    <option value="">All Categories</option>
                    <option value="veg">Vegetarian</option>
                    <option value="non-veg">Non-Vegetarian</option>
                    <option value="dessert">Dessert</option>
                    <option value="beverage">Beverage</option>
                </select>
            </div>
            <div id="menuItems" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3"></div>
        </section>

        <!-- Cart Section -->
        <section id="cartSection" class="section">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6 sm:text-3xl">Your Cart</h2>
            <div class="cart-container">
                <div class="flex flex-col sm:flex-row justify-between mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
                    <button onclick="showCouponModal()" class="btn-primary text-sm sm:text-base">Apply Coupon</button>
                    <select id="deliveryAddress" class="input-field w-full sm:w-1/2 p-3 border rounded-md text-sm sm:text-base" onchange="selectDeliveryAddress(this.value)">
                        <option value="">Select Delivery Address</option>
                    </select>
                </div>
                <div id="couponInfo" class="mb-4 text-sm sm:text-base text-gray-600"></div>
                <div id="cartItems" class="mb-6"></div>
                <div id="cartSummary" class="cart-summary"></div>
                <div class="text-center mt-6">
                    <button id="proceedToPayment" onclick="showPaymentModal()" class="btn-primary text-sm sm:text-base">Proceed to Payment</button>
                </div>
            </div>
        </section>

        <!-- Orders Section -->
        <section id="ordersSection" class="section">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6 sm:text-3xl">Your Orders</h2>
            <div id="orderItems"></div>
        </section>

        <!-- Favorites Section -->
        <section id="favoritesSection" class="section">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6 sm:text-3xl">Your Favorites</h2>
            <div id="favoriteItems" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3"></div>
        </section>

        <!-- Order History Section -->
        <section id="orderHistorySection" class="section">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 text-center sm:text-3xl">Order History</h2>
                <button onclick="clearOrderHistory()" class="btn-primary text-sm sm:text-base">Clear History</button>
            </div>
            <div id="orderHistoryItems"></div>
        </section>

        <!-- Profile Section -->
        <section id="profileSection" class="section">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6 sm:text-3xl">Your Profile</h2>
            <div class="max-w-lg mx-auto profile-card">
                <div class="flex justify-center mb-6 profile-image-container">
                    <img id="profileImage" src="https://via.placeholder.com/100" alt="Profile" class="h-40 w-40 rounded-full object-cover border-4 border-yellow-500 shadow-lg">
                    <div class="profile-image-overlay"></div>
                </div>
                <div>
                    <label for="profileName" class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">Name</label>
                    <input type="text" id="profileName" class="input-field w-full p-3 border rounded-md text-sm sm:text-base" placeholder="Enter your name">
                </div>
                <div class="mt-4">
                    <label for="profileEmail" class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">Email</label>
                    <input type="email" id="profileEmail" class="input-field w-full p-3 border rounded-md text-sm sm:text-base bg-gray-100" readonly>
                </div>
                <div class="mt-4">
                    <label for="profilePhone" class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">Phone</label>
                    <input type="tel" id="profilePhone" class="input-field w-full p-3 border rounded-md text-sm sm:text-base bg-gray-100" readonly>
                </div>
                <div class="mt-4">
                    <label for="profileImageUpload" class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">Upload Profile Image</label>
                    <input type="file" id="profileImageUpload" class="input-field w-full p-3 border rounded-md text-sm sm:text-base" accept="image/*">
                </div>
                <div class="mt-6 text-center">
                    <button id="saveProfileBtn" onclick="saveProfile()" class="btn-primary text-sm sm:text-base">Save Profile</button>
                </div>
            </div>
        </section>

        <!-- Addresses Section -->
        <section id="addressesSection" class="section">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6 sm:text-3xl">Your Addresses</h2>
            <div class="flex justify-end mb-4">
                <button onclick="showAddAddressModal()" class="btn-primary text-sm sm:text-base">Add New Address</button>
            </div>
            <div id="addressList" class="max-w-3xl mx-auto"></div>
        </section>
    </div>

    <script>
        const BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://delicute.onrender.com';
        const DEFAULT_IMAGE = 'https://via.placeholder.com/300';
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let addresses = [];
        let currentOrderTotal = 0;
        let appliedCoupon = null;
        let currentRatingItemId = null;
        let userName = '';
        let selectedAddressId = localStorage.getItem('selectedAddressId') || null;
        let editingAddressId = null;
        let isLoading = false;

        function sanitizeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function setLoading(elementId, state) {
            const element = document.getElementById(elementId);
            if (element) {
                element.disabled = state;
                element.classList.toggle('loading', state);
            }
            isLoading = state;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = sanitizeHTML(message);
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            const section = document.getElementById(`${sectionId}Section`);
            if (section) section.classList.add('active');
            switch (sectionId) {
                case 'cart': loadCart(); break;
                case 'orders': fetchOrders(); break;
                case 'home': fetchMenuItems(); fetchCoupons(); fetchSpecialCoupons(); break;
                case 'favorites': loadFavorites(); break;
                case 'orderHistory': fetchOrderHistory(); break;
                case 'addresses': fetchAddresses(); break;
            }
            document.getElementById('navbarMenu').classList.remove('active');
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                showToast('Please log in to access the dashboard.', 'error');
                setTimeout(() => window.location.href = 'index.html', 1000);
                return false;
            }
            try {
                const response = await fetch(`${BASE_URL}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Invalid token');
                await Promise.all([fetchUserDetails(), fetchAddresses()]);
                showSection('home');
                loadCart();
                if (localStorage.getItem('darkMode') === 'true') {
                    document.body.classList.add('dark-mode');
                }
                return true;
            } catch (error) {
                console.error('Auth error:', error);
                showToast('Session expired. Please log in again.', 'error');
                localStorage.clear();
                setTimeout(() => window.location.href = 'index.html', 1000);
                return false;
            }
        }

        async function fetchUserDetails() {
            const token = localStorage.getItem('token');
            setLoading('saveProfileBtn', true);
            try {
                const response = await fetch(`${BASE_URL}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (response.ok) {
                    userName = sanitizeHTML(data.name || 'Guest');
                    document.getElementById('welcomeMessage').textContent = `Welcome, ${userName}!`;
                    document.getElementById('profileName').value = data.name || '';
                    document.getElementById('profileEmail').value = data.email || '';
                    document.getElementById('profilePhone').value = data.phone || '';
                    const profileImage = data.profileImage || DEFAULT_IMAGE;
                    document.getElementById('profileImage').src = profileImage;
                    document.getElementById('headerProfileImage').src = profileImage;
                    localStorage.setItem('userProfileImage', profileImage);
                } else {
                    showToast(data.error || 'Failed to fetch profile.', 'error');
                }
            } catch (error) {
                console.error('Fetch user error:', error);
                showToast('Error fetching profile.', 'error');
            } finally {
                setLoading('saveProfileBtn', false);
            }
        }

        async function saveProfile() {
            if (isLoading) return;
            const token = localStorage.getItem('token');
            const name = document.getElementById('profileName').value.trim();
            const fileInput = document.getElementById('profileImageUpload');
            if (!name) {
                showToast('Please enter a name.', 'error');
                return;
            }
            setLoading('saveProfileBtn', true);
            const formData = new FormData();
            formData.append('name', sanitizeHTML(name));
            if (fileInput.files[0]) {
                if (fileInput.files[0].size > 5 * 1024 * 1024) {
                    showToast('Image size should be less than 5MB.', 'error');
                    setLoading('saveProfileBtn', false);
                    return;
                }
                formData.append('profileImage', fileInput.files[0]);
            }
            try {
                const response = await fetch(`${BASE_URL}/api/auth/update`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await response.json();
                if (response.ok) {
                    showToast('Profile updated successfully!', 'success');
                    userName = sanitizeHTML(name);
                    document.getElementById('welcomeMessage').textContent = `Welcome, ${userName}!`;
                    if (data.profileImage) {
                        document.getElementById('profileImage').src = data.profileImage;
                        document.getElementById('headerProfileImage').src = data.profileImage;
                        localStorage.setItem('userProfileImage', data.profileImage);
                    }
                    document.getElementById('profileImageUpload').value = '';
                } else {
                    showToast(data.error || 'Failed to update profile.', 'error');
                }
            } catch (error) {
                console.error('Update profile error:', error);
                showToast('Error updating profile.', 'error');
            } finally {
                setLoading('saveProfileBtn', false);
            }
        }

        async function fetchAddresses() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${BASE_URL}/api/addresses`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (response.ok) {
                    addresses = data || [];
                    renderAddresses();
                    updateDeliveryAddressDropdown();
                    if (selectedAddressId && !addresses.find(addr => addr._id === selectedAddressId)) {
                        selectedAddressId = null;
                        localStorage.removeItem('selectedAddressId');
                    }
                    if (addresses.length > 0 && !selectedAddressId) {
                        selectDeliveryAddress(addresses[0]._id);
                    }
                } else {
                    showToast(data.error || 'Failed to fetch addresses.', 'error');
                    addresses = [];
                    renderAddresses();
                    updateDeliveryAddressDropdown();
                }
            } catch (error) {
                console.error('Fetch addresses error:', error);
                showToast('Failed to fetch addresses.', 'error');
                addresses = [];
                renderAddresses();
                updateDeliveryAddressDropdown();
            }
        }

        function renderAddresses() {
            const addressListDiv = document.getElementById('addressList');
            if (!addressListDiv) return;
            if (addresses.length === 0) {
                addressListDiv.innerHTML = '<p class="text-gray-600 text-sm sm:text-base">No addresses saved. Please add an address.</p>';
                return;
            }
            addressListDiv.innerHTML = addresses.map(address => `
                <div class="address-card">
                    <p class="text-gray-800 font-medium text-sm sm:text-base">${sanitizeHTML(address.fullName || 'Unknown')}</p>
                    <p class="text-gray-600 text-sm sm:text-base">${sanitizeHTML(address.houseNumber || '')}, ${sanitizeHTML(address.street || '')}${address.landmark ? `, ${sanitizeHTML(address.landmark)}` : ''}, ${sanitizeHTML(address.pincode || '')}</p>
                    <p class="text-gray-600 text-sm sm:text-base">Mobile: ${sanitizeHTML(address.mobile || 'N/A')}</p>
                    <div class="flex space-x-2 mt-3">
                        <button onclick="showEditAddressModal('${address._id}')" class="btn-primary text-sm sm:text-base">Edit</button>
                        <button onclick="deleteAddress('${address._id}')" class="btn-secondary text-sm sm:text-base">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function updateDeliveryAddressDropdown() {
            const dropdown = document.getElementById('deliveryAddress');
            if (!dropdown) return;
            dropdown.innerHTML = '<option value="">Select Delivery Address</option>';
            addresses.forEach(address => {
                const option = document.createElement('option');
                option.value = address._id;
                option.textContent = `${sanitizeHTML(address.fullName || 'Unknown')}, ${sanitizeHTML(address.houseNumber || '')}, ${sanitizeHTML(address.street || '')}, ${sanitizeHTML(address.pincode || '')}`;
                if (address._id === selectedAddressId) {
                    option.selected = true;
                }
                dropdown.appendChild(option);
            });
        }

        function showAddAddressModal() {
            editingAddressId = null;
            document.getElementById('addressModalTitle').textContent = 'Add Address';
            document.getElementById('addressFullName').value = '';
            document.getElementById('addressMobile').value = '';
            document.getElementById('addressHouse').value = '';
            document.getElementById('addressStreet').value = '';
            document.getElementById('addressLandmark').value = '';
            document.getElementById('addressPincode').value = '';
            showModal('addressModal');
        }

        function showEditAddressModal(addressId) {
            editingAddressId = addressId;
            const address = addresses.find(addr => addr._id === addressId);
            if (!address) {
                showToast('Address not found.', 'error');
                return;
            }
            document.getElementById('addressModalTitle').textContent = 'Edit Address';
            document.getElementById('addressFullName').value = address.fullName || '';
            document.getElementById('addressMobile').value = address.mobile || '';
            document.getElementById('addressHouse').value = address.houseNumber || '';
            document.getElementById('addressStreet').value = address.street || '';
            document.getElementById('addressLandmark').value = address.landmark || '';
            document.getElementById('addressPincode').value = address.pincode || '';
            showModal('addressModal');
        }

        async function saveAddress() {
            if (isLoading) return;
            const token = localStorage.getItem('token');
            const fullName = document.getElementById('addressFullName').value.trim();
            const mobile = document.getElementById('addressMobile').value.trim();
            const houseNumber = document.getElementById('addressHouse').value.trim();
            const street = document.getElementById('addressStreet').value.trim();
            const landmark = document.getElementById('addressLandmark').value.trim();
            const pincode = document.getElementById('addressPincode').value.trim();

            if (!fullName || !mobile || !houseNumber || !street || !pincode) {
                showToast('Please fill in all required fields.', 'error');
                return;
            }

            if (!/^\d{10}$/.test(mobile)) {
                showToast('Please enter a valid 10-digit mobile number.', 'error');
                return;
            }

            if (!/^\d{6}$/.test(pincode)) {
                showToast('Please enter a valid 6-digit pincode.', 'error');
                return;
            }

            const addressData = { fullName, mobile, houseNumber, street, landmark, pincode };
            const url = editingAddressId ? `${BASE_URL}/api/addresses/${editingAddressId}` : `${BASE_URL}/api/addresses`;
            const method = editingAddressId ? 'PUT' : 'POST';
            setLoading('saveAddressBtn', true);

            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(addressData)
                });
                const data = await response.json();
                if (response.ok) {
                    showToast(editingAddressId ? 'Address updated successfully!' : 'Address added successfully!', 'success');
                    closeModal('addressModal');
                    await fetchAddresses();
                    if (!selectedAddressId && addresses.length > 0) {
                        selectDeliveryAddress(addresses[0]._id);
                    }
                } else {
                    showToast(data.error || 'Failed to save address.', 'error');
                }
            } catch (error) {
                console.error('Save address error:', error);
                showToast('Failed to save address.', 'error');
            } finally {
                setLoading('saveAddressBtn', false);
            }
        }

        async function deleteAddress(addressId) {
            if (isLoading) return;
            const token = localStorage.getItem('token');
            setLoading('addressList', true);
            try {
                const response = await fetch(`${BASE_URL}/api/addresses/${addressId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (response.ok) {
                    showToast('Address deleted successfully!', 'success');
                    if (selectedAddressId === addressId) {
                        selectedAddressId = null;
                        localStorage.removeItem('selectedAddressId');
                    }
                    await fetchAddresses();
                } else {
                    showToast(data.error || 'Failed to delete address.', 'error');
                }
            } catch (error) {
                console.error('Delete address error:', error);
                showToast('Failed to delete address.', 'error');
            } finally {
                setLoading('addressList', false);
            }
        }

        function selectDeliveryAddress(addressId) {
            selectedAddressId = addressId || null;
            localStorage.setItem('selectedAddressId', selectedAddressId);
            updateDeliveryAddressDropdown();
            loadCart();
        }

        async function fetchMenuItems() {
            setLoading('menuItems', true);
            try {
                const response = await fetch(`${BASE_URL}/api/menu`);
                const menuItems = await response.json();
                const searchQuery = document.getElementById('searchInput')?.value.toLowerCase().trim() || '';
                const category = document.getElementById('categoryFilter')?.value || '';
                const filteredItems = menuItems.filter(item =>
                    item.name.toLowerCase().includes(searchQuery) &&
                    (!category || item.category === category)
                );
                const menuItemsDiv = document.getElementById('menuItems');
                if (!menuItemsDiv) return;
                if (filteredItems.length === 0) {
                    menuItemsDiv.innerHTML = '<p class="text-gray-600 text-sm sm:text-base">No items available.</p>';
                    return;
                }
                menuItemsDiv.innerHTML = filteredItems.map(item => `
                    <div class="menu-card">
                        <img src="${sanitizeHTML(item.image || DEFAULT_IMAGE)}" alt="${sanitizeHTML(item.name)}" class="w-full object-cover h-48">
                        <div class="p-6">
                            <h3 class="text-base font-semibold text-gray-800 sm:text-lg">${sanitizeHTML(item.name)}</h3>
                            <p class="text-gray-600 text-sm mt-2 sm:text-base">${sanitizeHTML(item.description || 'No description available')}</p>
                            <p class="text-yellow-600 font-bold mt-2 text-sm sm:text-base">₹${item.price.toFixed(2)}</p>
                            <p class="text-gray-600 text-sm mt-2 sm:text-base rating-stars">${'★'.repeat(item.rating || 0)}${'☆'.repeat(5 - (item.rating || 0))}</p>
                            <div class="flex justify-between mt-3">
                                <button onclick='addToCart(${JSON.stringify({ _id: item._id, name: item.name, price: item.price, image: item.image })})' class="btn-primary w-3/4 text-sm sm:text-base">Add to Cart</button>
                                <button onclick='toggleFavorite(${JSON.stringify({ _id: item._id, name: item.name, price: item.price, image: item.image, category: item.category })})' class="text-red-500 hover:text-red-700 text-sm sm:text-base">
                                    ${favorites.some(fav => fav.id === item._id) ? '♥' : '♡'}
                                </button>
                            </div>
                            <button onclick="showRateModal('${item._id}')" class="mt-3 text-sm sm:text-base text-gray-600 hover:text-gray-900">Rate Item</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Fetch menu error:', error);
                document.getElementById('menuItems').innerHTML = '<p class="text-red-500 text-sm sm:text-base">Failed to load menu items.</p>';
            } finally {
                setLoading('menuItems', false);
            }
        }

        async function fetchCoupons() {
            setLoading('couponItems', true);
            try {
                const response = await fetch(`${BASE_URL}/api/coupons`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const coupons = await response.json();
                const couponItemsDiv = document.getElementById('couponItems');
                if (!couponItemsDiv) return;
                if (coupons.length === 0) {
                    couponItemsDiv.innerHTML = '<p class="text-gray-600 text-sm sm:text-base">No coupons available.</p>';
                    return;
                }
                couponItemsDiv.innerHTML = coupons.filter(coupon => !coupon.isSpecial).map(coupon => `
                    <div class="coupon-card">
                        <img src="${sanitizeHTML(coupon.image || DEFAULT_IMAGE)}" alt="${sanitizeHTML(coupon.code)}" class="w-full object-cover h-48">
                        <div class="p-6">
                            <h3 class="text-base font-semibold text-gray-800 sm:text-lg">${sanitizeHTML(coupon.code)}</h3>
                            <p class="text-gray-600 text-sm mt-2 sm:text-base">${sanitizeHTML(coupon.description || 'No description available')}</p>
                            <p class="text-yellow-600 font-bold mt-2 text-sm sm:text-base">${coupon.discount}% Off</p>
                            <button onclick="applyCouponDirectly('${sanitizeHTML(coupon.code)}')" class="btn-primary w-full mt-3 text-sm sm:text-base">Apply Coupon</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Fetch coupons error:', error);
                document.getElementById('couponItems').innerHTML = '<p class="text-red-500 text-sm sm:text-base">Failed to load coupons.</p>';
            } finally {
                setLoading('couponItems', false);
            }
        }

        async function fetchSpecialCoupons() {
            setLoading('specialCouponItems', true);
            try {
                const response = await fetch(`${BASE_URL}/api/coupons`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const coupons = await response.json();
                const specialCouponItemsDiv = document.getElementById('specialCouponItems');
                if (!specialCouponItemsDiv) return;
                const specialCoupons = coupons.filter(coupon => coupon.isSpecial);
                if (specialCoupons.length === 0) {
                    specialCouponItemsDiv.innerHTML = '<p class="text-gray-600 text-sm sm:text-base">No special offers available.</p>';
                    return;
                }
                specialCouponItemsDiv.innerHTML = specialCoupons.map(coupon => `
                    <div class="coupon-card special-coupon">
                        <img src="${sanitizeHTML(coupon.image || DEFAULT_IMAGE)}" alt="${sanitizeHTML(coupon.code)}" class="w-full object-cover h-48">
                        <div class="p-6">
                            <h3 class="text-base font-semibold text-gray-800 sm:text-lg">${sanitizeHTML(coupon.code)}</h3>
                            <p class="text-gray-600 text-sm mt-2 sm:text-base">${sanitizeHTML(coupon.description || 'No description available')}</p>
                            <p class="text-yellow-600 font-bold mt-2 text-sm sm:text-base">${coupon.discount}% Off</p>
                            <p class="text-gray-600 text-sm mt-2 sm:text-base">Special Offer by Admin</p>
                            <button onclick="applyCouponDirectly('${sanitizeHTML(coupon.code)}')" class="btn-primary w-full mt-3 text-sm sm:text-base">Apply Coupon</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Fetch special coupons error:', error);
                document.getElementById('specialCouponItems').innerHTML = '<p class="text-red-500 text-sm sm:text-base">Failed to load special coupons.</p>';
            } finally {
                setLoading('specialCouponItems', false);
            }
        }

        async function applyCouponDirectly(couponCode) {
            if (isLoading) return;
            setLoading('couponItems', true);
            try {
                const response = await fetch(`${BASE_URL}/api/coupons/validate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ couponCode })
                });
                const data = await response.json();
                if (response.ok) {
                    appliedCoupon = data;
                    showToast(`Coupon ${sanitizeHTML(couponCode)} applied! ${data.discount}% off`, 'success');
                    loadCart();
                } else {
                    showToast(data.error || 'Invalid coupon code.', 'error');
                }
            } catch (error) {
                console.error('Apply coupon error:', error);
                showToast('Failed to apply coupon.', 'error');
            } finally {
                setLoading('couponItems', false);
            }
        }

        function addToCart(item) {
            if (!item._id || !item.name || !item.price) {
                showToast('Invalid item data.', 'error');
                return;
            }
            const existingItem = cart.find(cartItem => cartItem.id === item._id);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    id: item._id,
                    name: sanitizeHTML(item.name),
                    price: parseFloat(item.price),
                    quantity: 1,
                    image: item.image || DEFAULT_IMAGE,
                    type: 'menu'
                });
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            showToast(`${sanitizeHTML(item.name)} added to cart!`, 'success');
            if (document.getElementById('cartSection').classList.contains('active')) loadCart();
        }

        function toggleFavorite(item) {
            if (!item._id || !item.name || !item.price) {
                showToast('Invalid item data.', 'error');
                return;
            }
            const existingFav = favorites.find(fav => fav.id === item._id);
            if (existingFav) {
                favorites = favorites.filter(fav => fav.id !== item._id);
                showToast(`${sanitizeHTML(item.name)} removed from favorites.`, 'success');
            } else {
                favorites.push({
                    id: item._id,
                    name: sanitizeHTML(item.name),
                    price: parseFloat(item.price),
                    image: item.image || DEFAULT_IMAGE,
                    category: item.category || 'Unknown'
                });
                showToast(`${sanitizeHTML(item.name)} added to favorites!`, 'success');
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            if (document.getElementById('favoritesSection').classList.contains('active')) loadFavorites();
            if (document.getElementById('homeSection').classList.contains('active')) fetchMenuItems();
        }

        function loadFavorites() {
            const favoriteItemsDiv = document.getElementById('favoriteItems');
            if (!favoriteItemsDiv) return;
            if (favorites.length === 0) {
                favoriteItemsDiv.innerHTML = '<p class="text-gray-600 text-sm sm:text-base">No favorite items.</p>';
                return;
            }
            favoriteItemsDiv.innerHTML = favorites.map(item => `
                <div class="menu-card">
                    <img src="${sanitizeHTML(item.image)}" alt="${sanitizeHTML(item.name)}" class="w-full object-cover h-48">
                    <div class="p-6">
                        <h3 class="text-base font-semibold text-gray-800 sm:text-lg">${sanitizeHTML(item.name)}</h3>
                        <p class="text-gray-600 text-sm mt-2 sm:text-base">${sanitizeHTML(item.category)}</p>
                        <p class="text-yellow-600 font-bold mt-2 text-sm sm:text-base">₹${item.price.toFixed(2)}</p>
                        <div class="flex justify-between mt-3">
                            <button onclick='addToCart(${JSON.stringify({ _id: item.id, name: item.name, price: item.price, image: item.image })})' class="btn-primary w-3/4 text-sm sm:text-base">Add to Cart</button>
                            <button onclick='toggleFavorite(${JSON.stringify({ _id: item.id, name: item.name, price: item.price, image: item.image, category: item.category })})' class="text-red-500 hover:text-red-700 text-sm sm:text-base">♥</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function removeFromCart(index) {
            if (index < 0 || index >= cart.length) {
                showToast('Invalid cart item.', 'error');
                return;
            }
            const itemName = cart[index].name;
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
            showToast(`${sanitizeHTML(itemName)} removed from cart.`, 'success');
        }

        function updateQuantity(index, delta) {
            if (index < 0 || index >= cart.length) {
                showToast('Invalid cart item.', 'error');
                return;
            }
            cart[index].quantity += delta;
            if (cart[index].quantity <= 0) {
                removeFromCart(index);
            } else {
                localStorage.setItem('cart', JSON.stringify(cart));
                loadCart();
            }
        }

        function showCouponModal() {
            document.getElementById('couponCode').value = '';
            showModal('couponModal');
        }

        async function applyCoupon() {
            if (isLoading) return;
            const couponCode = document.getElementById('couponCode').value.trim();
            if (!couponCode) {
                showToast('Please enter a coupon code.', 'error');
                return;
            }
            setLoading('couponModal', true);
            try {
                const response = await fetch(`${BASE_URL}/api/coupons/validate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ couponCode })
                });
                const data = await response.json();
                if (response.ok) {
                    appliedCoupon = data;
                    showToast(`Coupon ${sanitizeHTML(couponCode)} applied! ${data.discount}% off`, 'success');
                    closeModal('couponModal');
                    loadCart();
                } else {
                    showToast(data.error || 'Invalid coupon code.', 'error');
                }
            } catch (error) {
                console.error('Apply coupon error:', error);
                showToast('Failed to apply coupon.', 'error');
            } finally {
                setLoading('couponModal', false);
            }
        }

        function loadCart() {
            const cartItemsDiv = document.getElementById('cartItems');
            const cartSummaryDiv = document.getElementById('cartSummary');
            const couponInfoDiv = document.getElementById('couponInfo');
            if (!cartItemsDiv || !cartSummaryDiv || !couponInfoDiv) return;

            // Validate cart items
            cart = cart.filter(item => item.id && item.name && item.price && item.quantity);
            localStorage.setItem('cart', JSON.stringify(cart));

            if (cart.length === 0) {
                cartItemsDiv.innerHTML = '<p class="text-gray-600 text-center text-sm sm:text-base">Your cart is empty. Add some delicious items!</p>';
                cartSummaryDiv.innerHTML = '';
                couponInfoDiv.innerHTML = '';
                document.getElementById('deliveryAddress').value = selectedAddressId || '';
                currentOrderTotal = 0;
                return;
            }

            let subtotal = 0;
            cartItemsDiv.innerHTML = cart.map((item, index) => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                return `
                    <div class="cart-item cart-card">
                        <img src="${sanitizeHTML(item.image)}" alt="${sanitizeHTML(item.name)}" class="cart-card-img">
                        <div class="flex-1 ml-4">
                            <h3 class="text-base font-semibold text-gray-800 sm:text-lg">${sanitizeHTML(item.name)}</h3>
                            <p class="text-gray-600 text-sm sm:text-base">₹${item.price.toFixed(2)} x ${item.quantity}</p>
                            <p class="text-yellow-600 font-bold text-sm sm:text-base">₹${itemTotal.toFixed(2)}</p>
                        </div>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="updateQuantity(${index}, -1)">-</button>
                            <span class="text-sm sm:text-base">${item.quantity}</span>
                            <button class="quantity-btn" onclick="updateQuantity(${index}, 1)">+</button>
                        </div>
                        <button onclick="removeFromCart(${index})" class="ml-4 text-red-500 hover:text-red-700 text-sm sm:text-base">Remove</button>
                    </div>
                `;
            }).join('');

            let discount = 0;
            if (appliedCoupon) {
                discount = (subtotal * appliedCoupon.discount) / 100;
                couponInfoDiv.innerHTML = `<p class="text-green-600 text-sm sm:text-base">Coupon Applied: ${sanitizeHTML(appliedCoupon.code)} (${appliedCoupon.discount}% off)</p>`;
            } else {
                couponInfoDiv.innerHTML = '<button onclick="showCouponModal()" class="text-blue-500 hover:text-blue-700 text-sm sm:text-base">Apply a coupon</button>';
            }

            currentOrderTotal = subtotal - discount;
            const selectedAddress = addresses.find(addr => addr._id === selectedAddressId);
            cartSummaryDiv.innerHTML = `
                <div class="flex justify-between text-sm sm:text-base mb-2">
                    <span>Subtotal</span>
                    <span>₹${subtotal.toFixed(2)}</span>
                </div>
                <div class="flex justify-between text-sm sm:text-base mb-2">
                    <span>Discount</span>
                    <span>-₹${discount.toFixed(2)}</span>
                </div>
                <div class="flex justify-between font-bold text-sm sm:text-base mb-2">
                    <span>Total</span>
                    <span>₹${currentOrderTotal.toFixed(2)}</span>
                </div>
                <div class="text-sm sm:text-base">
                    <span class="font-medium">Delivery Address:</span>
                    <span>${selectedAddress ? `${sanitizeHTML(selectedAddress.fullName || 'Unknown')}, ${sanitizeHTML(selectedAddress.houseNumber || '')}, ${sanitizeHTML(selectedAddress.street || '')}, ${sanitizeHTML(selectedAddress.pincode || '')}` : 'Please select an address'}</span>
                </div>
            `;
            document.getElementById('deliveryAddress').value = selectedAddressId || '';
        }

        function showPaymentModal() {
            if (cart.length === 0) {
                showToast('Your cart is empty.', 'error');
                return;
            }
            if (!selectedAddressId) {
                showToast('Please select a delivery address.', 'error');
                return;
            }
            showModal('paymentModal');
        }

        async function initiatePayment(method) {
            if (isLoading) return;
            if (cart.length === 0) {
                showToast('Your cart is empty.', 'error');
                closeModal('paymentModal');
                return;
            }
            if (!selectedAddressId) {
                showToast('Please select a delivery address.', 'error');
                closeModal('paymentModal');
                return;
            }
            setLoading('paymentModal', true);
            const paymentMethod = method === 'cod' ? 'COD' : method.toUpperCase();
            try {
                if (method === 'phonepe' || method === 'gpay') {
                    const response = await fetch(`${BASE_URL}/api/payment/${method}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            amount: currentOrderTotal,
                            deliveryAddress: selectedAddressId
                        })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showToast(`Redirecting to ${method === 'phonepe' ? 'PhonePe' : 'Google Pay'}...`, 'success');
                        await placeOrder(paymentMethod, { transactionId: data.transactionId || 'SIMULATED' });
                    } else {
                        showToast(data.error || `Failed to initiate ${method} payment.`, 'error');
                    }
                } else if (method === 'cod') {
                    await placeOrder('COD', {});
                }
            } catch (error) {
                console.error(`Initiate payment error:`, error);
                showToast(`Failed to initiate ${method} payment.`, 'error');
            } finally {
                setLoading('paymentModal', false);
            }
        }

        async function placeOrder(paymentMethod, paymentDetails = {}) {
            if (isLoading) return;
            const token = localStorage.getItem('token');
            const selectedAddress = addresses.find(addr => addr._id === selectedAddressId);
            if (!selectedAddress) {
                showToast('Invalid delivery address.', 'error');
                return;
            }
            setLoading('proceedToPayment', true);
            try {
                const response = await fetch(`${BASE_URL}/api/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        items: cart.map(item => ({
                            item: item.id,
                            quantity: item.quantity,
                            itemName: sanitizeHTML(item.name),
                            price: item.price
                        })),
                        total: currentOrderTotal,
                        paymentMethod,
                        paymentDetails,
                        coupon: appliedCoupon ? appliedCoupon.code : null,
                        deliveryAddress: selectedAddressId
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    showToast('Order placed successfully!', 'success');
                    document.getElementById('orderConfirmationDetails').innerHTML = `
                        <p><strong>Order #${sanitizeHTML(data._id)}</strong></p>
                        <p>Total: ₹${data.total.toFixed(2)}</p>
                        <p>Payment Method: ${sanitizeHTML(data.paymentMethod)}</p>
                        <p>Delivery Address: ${sanitizeHTML(selectedAddress.fullName || 'Unknown')}, ${sanitizeHTML(selectedAddress.houseNumber || '')}, ${sanitizeHTML(selectedAddress.street || '')}, ${sanitizeHTML(selectedAddress.pincode || '')}</p>
                        <p>Items: ${cart.map(item => `${sanitizeHTML(item.name)} (Qty: ${item.quantity})`).join(', ')}</p>
                        ${appliedCoupon ? `<p>Coupon: ${sanitizeHTML(appliedCoupon.code)} (${appliedCoupon.discount}% off)</p>` : ''}
                    `;
                    showModal('orderConfirmationModal');
                    cart = [];
                    appliedCoupon = null;
                    localStorage.setItem('cart', JSON.stringify(cart));
                    closeModal('paymentModal');
                    loadCart();
                    fetchOrders();
                    fetchOrderHistory();
                } else {
                    showToast(data.error || 'Failed to place order.', 'error');
                }
            } catch (error) {
                console.error('Place order error:', error);
                showToast('Failed to place order.', 'error');
            } finally {
                setLoading('proceedToPayment', false);
            }
        }

        async function fetchOrders() {
            setLoading('orderItems', true);
            try {
                const response = await fetch(`${BASE_URL}/api/orders`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const orders = await response.json();
                const orderItemsDiv = document.getElementById('orderItems');
                if (!orderItemsDiv) return;
                if (orders.length === 0) {
                    orderItemsDiv.innerHTML = '<p class="text-gray-600 text-sm sm:text-base">No orders found.</p>';
                    return;
                }
                orderItemsDiv.innerHTML = orders.map(order => `
                    <div class="bg-white p-6 rounded-lg shadow-md mb-4">
                        <h3 class="text-base font-semibold text-gray-800 sm:text-lg">Order #${sanitizeHTML(order._id)}</h3>
                        <p class="text-gray-600 text-sm mt-2 sm:text-base">Total: ₹${order.total.toFixed(2)}</p>
                        <p class="text-gray-600 text-sm mt-2 sm:text-base">Status: ${sanitizeHTML(order.status)}</p>
                        <p class="text-gray-600 text-sm mt-2 sm:text-base">Payment Method: ${sanitizeHTML(order.paymentMethod)}</p>
                        <p class="text-gray-600 text-sm mt-2 sm:text-base">Date: ${new Date(order.createdAt).toLocaleDateString()}</p>
                        ${order.deliveryAddress ? `<p class="text-gray-600 text-sm mt-2 sm:text-base">Delivery Address: ${sanitizeHTML(order.deliveryAddress.fullName || 'Unknown')}, ${sanitizeHTML(order.deliveryAddress.houseNumber || '')}, ${sanitizeHTML(order.deliveryAddress.street || '')}, ${sanitizeHTML(order.deliveryAddress.pincode || '')}</p>` : '<p class="text-gray-600 text-sm mt-2 sm:text-base">Delivery Address: Not specified</p>'}
                        ${order.coupon ? `<p class="text-gray-600 text-sm mt-2 sm:text-base">Coupon: ${sanitizeHTML(order.coupon)} (${order.discount}% off)</p>` : ''}
                        <div class="flex space-x-2 mt-3">
                            <button onclick="trackOrder('${order._id}')" class="btn-primary text-sm sm:text-base">Track Order</button>
                            <button onclick="reorder('${order._id}')" class="btn-primary text-sm sm:text-base">Reorder</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Fetch orders error:', error);
                document.getElementById('orderItems').innerHTML = '<p class="text-red-500 text-sm sm:text-base">Failed to load orders.</p>';
            } finally {
                setLoading('orderItems', false);
            }
        }

        async function fetchOrderHistory() {
            setLoading('orderHistoryItems', true);
            try {
                const response = await fetch(`${BASE_URL}/api/orders/history`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const orders = await response.json();
                const orderHistoryItemsDiv = document.getElementById('orderHistoryItems');
                if (!orderHistoryItemsDiv) return;
                if (orders.length === 0) {
                    orderHistoryItemsDiv.innerHTML = '<p class="text-gray-600 text-sm sm:text-base">No order history found.</p>';
                    return;
                }
                orderHistoryItemsDiv.innerHTML = orders.map(order => `
                    <div class="bg-white p-6 rounded-lg shadow-md mb-4">
                        <h3 class="text-base font-semibold text-gray-800 sm:text-lg">Order #${sanitizeHTML(order._id)}</h3>
                        <p class="text-gray-600 text-sm mt-2 sm:text-base">Total: ₹${order.total.toFixed(2)}</p>
                        <p class="text-gray-600 text-sm mt-2 sm:text-base">Status: ${sanitizeHTML(order.status)}</p>
                        <p class="text-gray-600 text-sm mt-2 sm:text-base">Payment Method: ${sanitizeHTML(order.paymentMethod)}</p>
                        <p class="text-gray-600 text-sm mt-2 sm:text-base">Date: ${new Date(order.createdAt).toLocaleDateString()}</p>
                        ${order.deliveryAddress ? `<p class="text-gray-600 text-sm mt-2 sm:text-base">Delivery Address: ${sanitizeHTML(order.deliveryAddress.fullName || 'Unknown')}, ${sanitizeHTML(order.deliveryAddress.houseNumber || '')}, ${sanitizeHTML(order.deliveryAddress.street || '')}, ${sanitizeHTML(order.deliveryAddress.pincode || '')}</p>` : '<p class="text-gray-600 text-sm mt-2 sm:text-base">Delivery Address: Not specified</p>'}
                        ${order.coupon ? `<p class="text-gray-600 text-sm mt-2 sm:text-base">Coupon: ${sanitizeHTML(order.coupon)} (${order.discount}% off)</p>` : ''}
                        <p class="text-gray-600 text-sm mt-2 sm:text-base">Items:</p>
                        <ul class="list-disc pl-5 text-sm sm:text-base">
                            ${order.items.map(item => `<li>${sanitizeHTML(item.itemName)} (Qty: ${item.quantity})</li>`).join('')}
                        </ul>
                        <div class="flex space-x-2 mt-3">
                            <button onclick="trackOrder('${order._id}')" class="btn-primary text-sm sm:text-base">Track Order</button>
                            <button onclick="reorder('${order._id}')" class="btn-primary text-sm sm:text-base">Reorder</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Fetch order history error:', error);
                document.getElementById('orderHistoryItems').innerHTML = '<p class="text-red-500 text-sm sm:text-base">Failed to load order history.</p>';
            } finally {
                setLoading('orderHistoryItems', false);
            }
        }

        async function clearOrderHistory() {
            if (isLoading) return;
            const token = localStorage.getItem('token');
            setLoading('orderHistoryItems', true);
            try {
                const response = await fetch(`${BASE_URL}/api/orders/history`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (response.ok) {
                    showToast('Order history cleared successfully!', 'success');
                    fetchOrderHistory();
                } else {
                    showToast(data.error || 'Failed to clear order history.', 'error');
                }
            } catch (error) {
                console.error('Clear order history error:', error);
                showToast('Failed to clear order history.', 'error');
            } finally {
                setLoading('orderHistoryItems', false);
            }
        }

        async function trackOrder(orderId) {
            if (isLoading) return;
            setLoading('orderItems', true);
            try {
                const response = await fetch(`${BASE_URL}/api/orders/${orderId}/track`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();
                if (response.ok) {
                    showToast(`Order #${sanitizeHTML(orderId)} status: ${sanitizeHTML(data.status)}`, 'success');
                } else {
                    showToast(data.error || 'Failed to track order.', 'error');
                }
            } catch (error) {
                console.error('Track order error:', error);
                showToast('Failed to track order.', 'error');
            } finally {
                setLoading('orderItems', false);
            }
        }

        async function reorder(orderId) {
            if (isLoading) return;
            setLoading('orderItems', true);
            try {
                const response = await fetch(`${BASE_URL}/api/orders/${orderId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const order = await response.json();
                if (response.ok) {
                    cart = order.items.map(item => ({
                        id: item.item,
                        name: sanitizeHTML(item.itemName),
                        price: item.price,
                        quantity: item.quantity,
                        image: item.image || DEFAULT_IMAGE,
                        type: 'menu'
                    }));
                    localStorage.setItem('cart', JSON.stringify(cart));
                    appliedCoupon = order.coupon ? { code: order.coupon, discount: order.discount } : null;
                    selectDeliveryAddress(order.deliveryAddress?._id || null);
                    showToast('Order added to cart!', 'success');
                    showSection('cart');
                } else {
                    showToast(order.error || 'Failed to reorder.', 'error');
                }
            } catch (error) {
                console.error('Reorder error:', error);
                showToast('Failed to reorder.', 'error');
            } finally {
                setLoading('orderItems', false);
            }
        }

        function showRateModal(itemId) {
            currentRatingItemId = itemId;
            document.getElementById('rating').value = '';
            document.getElementById('review').value = '';
            showModal('rateModal');
        }

        async function submitRating() {
            if (isLoading) return;
            const token = localStorage.getItem('token');
            const rating = parseInt(document.getElementById('rating').value);
            const review = document.getElementById('review').value.trim();
            if (!currentRatingItemId || isNaN(rating) || rating < 1 || rating > 5) {
                showToast('Please enter a valid rating (1-5).', 'error');
                return;
            }
            setLoading('rateModal', true);
            try {
                const response = await fetch(`${BASE_URL}/api/menu/${currentRatingItemId}/rate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ rating, review: sanitizeHTML(review) })
                });
                const data = await response.json();
                if (response.ok) {
                    showToast('Rating submitted successfully!', 'success');
                    closeModal('rateModal');
                    if (document.getElementById('homeSection').classList.contains('active')) {
                        fetchMenuItems();
                    }
                } else {
                    showToast(data.error || 'Failed to submit rating.', 'error');
                }
            } catch (error) {
                console.error('Submit rating error:', error);
                showToast('Failed to submit rating.', 'error');
            } finally {
                setLoading('rateModal', false);
            }
        }

        function logout() {
            localStorage.clear();
            showToast('Logged out successfully!', 'success');
            setTimeout(() => window.location.href = 'index.html', 1000);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            if (!await checkAuth()) return;

            const searchInput = document.getElementById('searchInput');
            const categoryFilter = document.getElementById('categoryFilter');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    clearTimeout(searchInput.dataset.timeout);
                    searchInput.dataset.timeout = setTimeout(fetchMenuItems, 300);
                });
            }
            if (categoryFilter) {
                categoryFilter.addEventListener('change', fetchMenuItems);
            }

            const menuToggle = document.getElementById('menuToggle');
            const navbarMenu = document.getElementById('navbarMenu');
            if (menuToggle && navbarMenu) {
                menuToggle.addEventListener('click', () => {
                    navbarMenu.classList.toggle('active');
                });
            }

            // Prevent form submissions
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', (e) => e.preventDefault());
            });

            // Close modals on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(modal.id);
                });
            });
        });

        // Cleanup event listeners on page unload
        window.addEventListener('unload', () => {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.removeEventListener('click', null);
            });
            const searchInput = document.getElementById('searchInput');
            const categoryFilter = document.getElementById('categoryFilter');
            const menuToggle = document.getElementById('menuToggle');
            if (searchInput) searchInput.removeEventListener('input', null);
            if (categoryFilter) categoryFilter.removeEventListener('change', null);
            if (menuToggle) menuToggle.removeEventListener('click', null);
        });
    </script>
</body>
</html>