<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://cdn.tailwindcss.com https://cdn.jsdelivr.net 'unsafe-inline';
    style-src 'self' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com 'unsafe-inline';
    img-src 'self' data: https://images.unsplash.com https://via.placeholder.com https://i.imgur.com;
    connect-src 'self';
    font-src 'self' https://cdnjs.cloudflare.com;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
  ">
  <title>User Dashboard - DELICUTE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/vanilla-tilt@1.7.0/dist/vanilla-tilt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; overflow-x: hidden; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
    .animate-slideUp { animation: slideUp 0.5s ease-out; }
    .animate-slideIn { animation: slideIn 0.3s ease-out forwards; }

    .toast {
      position: fixed; bottom: 20px; right: 20px; background: #f97316; color: white;
      padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000; display: none; font-size: 0.9rem; transition: opacity 0.3s ease;
    }

    .sidebar {
      background: linear-gradient(180deg, #1e293b 0%, #334155 100%); width: 260px; height: 100vh;
      position: fixed; top: 0; left: 0; padding: 16px; box-shadow: 4px 0 20px rgba(0, 0, 0, 0.2);
      z-index: 1000; transition: transform 0.3s ease; border-radius: 0 12px 12px 0; overflow-y: auto;
    }
    .sidebar-hidden { transform: translateX(-100%); }
    .sidebar button {
      color: #e2e8f0; width: 100%; text-align: left; padding: 10px 12px; border-radius: 8px;
      display: flex; align-items: center; gap: 10px; font-size: 0.9rem; font-weight: 500;
      transition: all 0.2s ease; position: relative; overflow: hidden;
    }
    .sidebar button::before {
      content: ''; position: absolute; left: 0; top: 0; width: 4px; height: 100%;
      background: #f97316; transform: translateX(-100%); transition: transform 0.2s ease;
    }
    .sidebar button:hover { background: rgba(71, 85, 105, 0.5); }
    .sidebar button:hover::before { transform: translateX(0); }
    .sidebar button.active { background: #f97316; color: white; }
    .sidebar button.active::before { transform: translateX(0); }
    .sidebar button i { font-size: 1.1rem; transition: transform 0.2s ease; }
    .sidebar button:hover i { transform: scale(1.1); }
    .sidebar img.profile-img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #f97316; object-fit: cover; }

    .hamburger {
      display: flex; flex-direction: column; justify-content: space-around; width: 24px; height: 18px;
      cursor: pointer; transition: all 0.3s ease; z-index: 1010; padding: 4px;
    }
    .hamburger div {
      width: 100%; height: 3px; background: white; border-radius: 2px;
      transition: all 0.3s ease; transform-origin: center;
    }
    .hamburger.open div:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
    .hamburger.open div:nth-child(2) { opacity: 0; }
    .hamburger.open div:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }

    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b;
      display: none; justify-content: space-around; padding: 10px 0; z-index: 1000;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
    }
    .bottom-nav button {
      color: #e2e8f0; font-size: 0.7rem; display: flex; flex-direction: column;
      align-items: center; gap: 4px; background: none; border: none; padding: 6px;
      transition: color 0.2s ease;
    }
    .bottom-nav button.active { color: #f97316; }
    .bottom-nav button i { font-size: 1.4rem; }

    header {
      background: linear-gradient(to right, #f97316, #fb923c); padding: 10px 12px;
      position: sticky; top: 0; z-index: 20;
    }

    .hero-bg {
      background: linear-gradient(to right, #ffedd5, #fed7aa); position: relative;
      overflow: hidden; border-radius: 10px; padding: 12px; display: flex; align-items: center;
      gap: 12px;
    }
    .particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

    .menu-item {
      background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
    }
    .menu-item:hover { transform: scale(1.02); }
    .menu-item img { width: 100%; height: 120px; object-fit: cover; display: block; }

    .banner-container {
      position: relative; overflow: hidden; width: 100%; padding: 0 12px;
    }
    .banner-item {
      background: white; border-radius: 10px; padding: 12px; min-height: 120px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); position: relative;
    }
    .banner-item.hidden { transform: translateX(100%); opacity: 0; position: absolute; }
    .banner-item:not(.hidden) { transform: translateX(0); opacity: 1; }
    .banner-item img {
      width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;
      z-index: -1; filter: brightness(0.7);
    }
    .banner-content { z-index: 1; color: white; max-width: 100%; }
    .banner-arrow {
      position: absolute; top: 50%; transform: translateY(-50%); background: #f97316;
      color: white; padding: 6px; border-radius: 50%; cursor: pointer; z-index: 10;
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
    }
    .banner-arrow.left { left: 6px; }
    .banner-arrow.right { right: 6px; }

    .chat-container {
      max-height: 250px; overflow-y: auto; padding: 8px; border: 1px solid #e5e7eb;
      border-radius: 8px; background: white;
    }
    .chat-message {
      margin-bottom: 8px; padding: 6px 10px; border-radius: 8px; max-width: 75%;
    }
    .chat-message.user { background: #f97316; color: white; margin-left: auto; }
    .chat-message.admin { background: #e5e7eb; color: #374151; margin-right: auto; }

    .share-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);
      z-index: 2000; display: none; justify-content: center; align-items: center; transition: opacity 0.3s ease;
    }
    .share-modal.active { display: flex; opacity: 1; }
    .share-modal-content {
      background: white; padding: 12px; border-radius: 10px; max-width: 90%; width: 320px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transform: scale(0.8); transition: transform 0.3s ease;
    }
    .share-modal.active .share-modal-content { transform: scale(1); }
    .share-modal-content .close {
      position: absolute; top: 8px; right: 8px; font-size: 1.2rem; cursor: pointer;
      color: #374151;
    }

    .profile-img-upload {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .profile-img-upload:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(249, 115, 22, 0.5);
    }

    @media (min-width: 1024px) {
      .bottom-nav { display: none; }
      .sidebar { transform: translateX(0); }
      .main-content { margin-left: 260px; }
      .menu-item img { height: 180px; }
      .banner-item { min-height: 180px; }
      .banner-content { max-width: 60%; }
      .text-2xl { font-size: 1.5rem; }
      .grid-cols-2 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .hamburger { display: none; }
    }
    @media (max-width: 1023px) {
      .sidebar { transform: translateX(-100%); width: 220px; }
      .main-content { margin-bottom: 60px; }
      .bottom-nav { display: flex; }
      .text-2xl { font-size: 1.25rem; }
      .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .hero-bg { flex-direction: column; align-items: flex-start; }
      header img.profile-img { width: 32px; height: 32px; }
    }
    @media (max-width: 640px) {
      .sidebar { width: 200px; }
      .grid-cols-2 { grid-template-columns: 1fr; }
      .banner-item { padding: 10px; min-height: 100px; }
      .banner-content { max-width: 100%; }
      .menu-item img { height: 100px; }
      .text-2xl { font-size: 1.1rem; }
      .hero-bg { padding: 10px; }
      header { padding: 8px 10px; }
      .banner-arrow { width: 24px; height: 24px; padding: 5px; }
      .chat-container { max-height: 200px; }
      .share-modal-content { width: 280px; }
    }
  </style>
</head>
<body>
  <header class="text-white">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div id="sidebarToggle" class="hamburger">
          <div></div>
          <div></div>
          <div></div>
        </div>
        <img src="https://i.imgur.com/ZbhzFqT.png" alt="DELICUTE Logo" class="h-7">
        <div class="text-2xl font-bold">DELICUTE</div>
      </div>
      <div class="flex items-center gap-3">
        <div class="relative sm:block hidden">
          <input type="text" id="searchMenu" class="px-3 py-1.5 rounded-full bg-white text-gray-800 w-40 focus:outline-none focus:ring-2 focus:ring-orange-400 text-sm" placeholder="Search..." aria-label="Search dishes">
          <i class="fas fa-search absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm"></i>
        </div>
        <button id="cartSummary" class="relative" aria-label="View cart">
          <i class="fas fa-cart-shopping text-lg"></i>
          <span id="cartCount" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full px-1.5">0</span>
        </button>
        <button id="profileQuick" aria-label="View profile">
          <img src="https://via.placeholder.com/32" alt="Profile" class="profile-img rounded-full">
        </button>
      </div>
    </div>
  </header>

  <div class="flex min-h-screen">
    <div id="sidebar" class="sidebar text-white sidebar-hidden">
      <div class="flex items-center gap-2 mb-6">
        <img src="https://via.placeholder.com/40" alt="Profile" class="profile-img">
        <div class="text-lg font-bold">DELICUTE</div>
      </div>
      <nav class="space-y-1">
        <button data-section="dashboard" class="user-nav active"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
        <button data-section="menu" class="user-nav"><i class="fas fa-utensils"></i> Menu</button>
        <button data-section="orders" class="user-nav"><i class="fas fa-shopping-cart"></i> Orders</button>
        <button data-section="cart" class="user-nav"><i class="fas fa-cart-shopping"></i> Cart</button>
        <button data-section="favourites" class="user-nav"><i class="fas fa-heart"></i> Favourites</button>
        <button data-section="addresses" class="user-nav"><i class="fas fa-map-marker-alt"></i> Addresses</button>
        <button data-section="loyalty" class="user-nav"><i class="fas fa-star"></i> Loyalty</button>
        <button data-section="referrals" class="user-nav"><i class="fas fa-user-friends"></i> Refer & Earn</button>
        <button data-section="support" class="user-nav"><i class="fas fa-headset"></i> Support</button>
        <button data-section="faq" class="user-nav"><i class="fas fa-question-circle"></i> FAQ</button>
        <button data-section="profile" class="user-nav"><i class="fas fa-user"></i> Profile</button>
        <button id="logoutBtn" class="text-red-300 hover:bg-red-800 hover:text-white"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </nav>
    </div>

    <div class="main-content flex-1 p-3">
      <section id="user-dashboard" class="user-section animate-slideUp">
        <div id="statusBar" class="bg-yellow-100 text-yellow-800 p-2 rounded-lg mb-3 text-center text-xs">Restaurant: Open | Prep: 30 mins</div>
        <div class="banner-container mb-4">
          <div id="banner1" class="banner-item hidden">
            <div class="banner-content">
              <h3 class="text-base font-bold">Loading...</h3>
              <p class="text-xs">Loading...</p>
              <button class="apply-banner-offer bg-orange-600 text-white px-3 py-1 rounded-full hover:bg-orange-700 text-sm">Apply Now</button>
            </div>
          </div>
          <button id="prevBanner" class="banner-arrow left"><i class="fas fa-chevron-left"></i></button>
          <button id="nextBanner" class="banner-arrow right"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="hero-bg mb-4">
          <canvas class="particles"></canvas>
          <div class="relative z-10">
            <h2 class="text-2xl font-bold mb-1">Savor the Moment!</h2>
            <p class="text-xs mb-3">Discover gourmet dishes crafted for you.</p>
            <div class="flex gap-3">
              <button data-section="menu" class="user-nav bg-orange-600 text-white px-3 py-1.5 rounded-full hover:bg-orange-700 text-sm">Explore Menu</button>
              <button id="applyOffer" class="bg-white text-orange-600 px-3 py-1.5 rounded-full hover:bg-gray-100 text-sm">Check Offers</button>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-4">
          <button data-section="orders" class="user-nav bg-orange-100 text-orange-600 p-2 rounded-lg hover:bg-orange-200 flex items-center justify-center text-sm"><i class="fas fa-shopping-cart mr-1"></i> Track Order</button>
          <button data-section="favourites" class="user-nav bg-orange-100 text-orange-600 p-2 rounded-lg hover:bg-orange-200 flex items-center justify-center text-sm"><i class="fas fa-heart mr-1"></i> Favourites</button>
          <button data-section="support" class="user-nav bg-orange-100 text-orange-600 p-2 rounded-lg hover:bg-orange-200 flex items-center justify-center text-sm"><i class="fas fa-headset mr-1"></i> Support</button>
          <button data-section="loyalty" class="user-nav bg-orange-100 text-orange-600 p-2 rounded-lg hover:bg-orange-200 flex items-center justify-center text-sm"><i class="fas fa-star mr-1"></i> Loyalty</button>
        </div>
        <h3 class="text-lg font-bold mb-3">Popular Picks</h3>
        <div id="popular" class="grid grid-cols-2 gap-3 mb-4"></div>
        <h3 class="text-lg font-bold mb-3">Explore Our Menu</h3>
        <div class="flex flex-col gap-3 mb-4">
          <div class="flex flex-wrap gap-2">
            <button class="filter-btn bg-orange-600 text-white px-3 py-1.5 rounded-full active text-sm" data-category="all">All</button>
            <button class="filter-btn bg-orange-600 text-white px-3 py-1.5 rounded-full text-sm" data-category="Vegetarian">Veg</button>
            <button class="filter-btn bg-orange-600 text-white px-3 py-1.5 rounded-full text-sm" data-category="Non-Veg">Non-Veg</button>
            <button class="filter-btn bg-orange-600 text-white px-3 py-1.5 rounded-full text-sm" data-category="Desserts">Desserts</button>
          </div>
          <select class="px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400 text-sm" id="priceFilter" aria-label="Filter by price">
            <option value="all">All Prices</option>
            <option value="0-200">₹0 - ₹200</option>
            <option value="200-500">₹200 - ₹500</option>
            <option value="500+">₹500+</option>
          </select>
        </div>
        <div id="menuPreview" class="grid grid-cols-2 gap-3 mb-4"></div>
        <div class="text-center">
          <button id="shareBtn" class="bg-orange-600 text-white px-3 py-1.5 rounded-full hover:bg-orange-700 text-sm"><i class="fas fa-share-alt mr-1"></i>Share DELICUTE</button>
        </div>
      </section>

      <section id="user-menu" class="user-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-2xl font-bold text-orange-600">Our Menu</h2>
          <button id="backFromMenu" class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded-full hover:bg-gray-300 text-sm"><i class="fas fa-arrow-left mr-1"></i>Back</button>
        </div>
        <div class="flex flex-col gap-3 mb-4">
          <div class="relative">
            <input type="text" id="menuSearch" class="w-full px-3 py-1.5 rounded-full border focus:outline-none focus:ring-2 focus:ring-orange-400 text-sm" placeholder="Search dishes..." aria-label="Search dishes">
            <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm"></i>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="filter-btn bg-orange-600 text-white px-3 py-1.5 rounded-full active text-sm" data-category="all">All</button>
            <button class="filter-btn bg-orange-600 text-white px-3 py-1.5 rounded-full text-sm" data-category="Vegetarian">Veg</button>
            <button class="filter-btn bg-orange-600 text-white px-3 py-1.5 rounded-full text-sm" data-category="Non-Veg">Non-Veg</button>
            <button class="filter-btn bg-orange-600 text-white px-3 py-1.5 rounded-full text-sm" data-category="Desserts">Desserts</button>
          </div>
          <select class="px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400 text-sm" id="menuPriceFilter" aria-label="Filter by price">
            <option value="all">All Prices</option>
            <option value="0-200">₹0 - ₹200</option>
            <option value="200-500">₹200 - ₹500</option>
            <option value="500+">₹500+</option>
          </select>
        </div>
        <div id="menuItems" class="grid grid-cols-2 gap-3"></div>
      </section>

      <section id="user-orders" class="user-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-2xl font-bold text-orange-600">Your Orders</h2>
          <button id="backFromOrders" class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded-full hover:bg-gray-300 text-sm"><i class="fas fa-arrow-left mr-1"></i>Back</button>
        </div>
        <div class="bg-white rounded-lg p-3 shadow mb-3">
          <h3 class="text-base font-bold mb-1">Cancellation Policy</h3>
          <p id="cancellationPolicy" class="text-sm">Cancel within 10 mins for full refund</p>
        </div>
        <div class="bg-white rounded-lg shadow overflow-x-auto">
          <table class="w-full text-xs">
            <thead>
              <tr class="bg-orange-100 text-orange-600">
                <th class="p-2 text-left">Order ID</th>
                <th class="p-2 text-left">Date</th>
                <th class="p-2 text-left">Items</th>
                <th class="p-2 text-left">Total</th>
                <th class="p-2 text-left">Status</th>
                <th class="p-2 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="orderItems"></tbody>
          </table>
        </div>
      </section>

      <section id="user-cart" class="user-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-2xl font-bold text-orange-600">Your Cart</h2>
          <button id="backFromCart" class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded-full hover:bg-gray-300 text-sm"><i class="fas fa-arrow-left mr-1"></i>Back</button>
        </div>
        <div class="bg-white rounded-lg p-3 shadow">
          <div id="cartItems" class="space-y-3"></div>
          <div class="mt-3 border-t pt-3">
            <div class="flex justify-between items-center mb-3">
              <input type="text" id="couponCode" class="px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400 w-2/3 text-sm" placeholder="Promo code" aria-label="Promo code">
              <button id="applyCoupon" class="bg-orange-600 text-white px-3 py-1.5 rounded-full hover:bg-orange-700 text-sm">Apply</button>
            </div>
            <p class="flex justify-between text-sm"><span>Subtotal:</span> <span id="cartSubtotal">₹0</span></p>
            <p class="flex justify-between text-sm"><span>Discount:</span> <span id="cartDiscount">₹0</span></p>
            <p class="flex justify-between font-bold text-sm"><span>Total:</span> <span id="cartTotal">₹0</span></p>
            <div class="mt-3">
              <label class="block text-gray-700 text-sm mb-1">Delivery Address</label>
              <select id="cartAddress" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400 text-sm" aria-label="Select address">
                <option value="">Select Address</option>
              </select>
            </div>
            <div class="mt-3">
              <label class="block text-gray-700 text-sm mb-1">Payment Method</label>
              <select id="paymentMethod" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400 text-sm" aria-label="Select payment">
                <option value="cod">Cash on Delivery</option>
                <option value="online">Online Payment</option>
              </select>
            </div>
            <button id="checkoutBtn" class="mt-3 w-full bg-orange-600 text-white px-3 py-1.5 rounded-full hover:bg-orange-700 text-sm">Checkout</button>
          </div>
        </div>
      </section>

      <section id="user-favourites" class="user-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-2xl font-bold text-orange-600">Your Favourites</h2>
          <button id="backFromFavourites" class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded-full hover:bg-gray-300 text-sm"><i class="fas fa-arrow-left mr-1"></i>Back</button>
        </div>
        <div id="favouritesItems" class="grid grid-cols-2 gap-3"></div>
      </section>

      <section id="user-addresses" class="user-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-2xl font-bold text-orange-600">Your Addresses</h2>
          <button id="backFromAddresses" class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded-full hover:bg-gray-300 text-sm"><i class="fas fa-arrow-left mr-1"></i>Back</button>
        </div>
        <button id="addAddress" class="mb-3 bg-orange-600 text-white px-3 py-1.5 rounded-full hover:bg-orange-700 text-sm"><i class="fas fa-plus mr-1"></i>Add Address</button>
        <div id="addressItems" class="space-y-3"></div>
      </section>

      <section id="user-loyalty" class="user-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-2xl font-bold text-orange-600">Loyalty Points</h2>
          <button id="backFromLoyalty" class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded-full hover:bg-gray-300 text-sm"><i class="fas fa-arrow-left mr-1"></i>Back</button>
        </div>
        <div class="bg-white rounded-lg p-3 shadow">
          <p class="text-base font-semibold mb-3">Points: <span id="loyaltyPoints">0</span></p>
          <h3 class="text-base font-bold mb-1">History</h3>
          <div id="loyaltyHistory"></div>
        </div>
      </section>

      <section id="user-referrals" class="user-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-2xl font-bold text-orange-600">Refer & Earn</h2>
          <button id="backFromReferrals" class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded-full hover:bg-gray-300 text-sm"><i class="fas fa-arrow-left mr-1"></i>Back</button>
        </div>
        <div class="bg-white rounded-lg p-3 shadow">
          <p class="text-xs mb-3">Share your referral code!</p>
          <p class="text-base font-semibold">Code: <span id="referralCode"></span></p>
          <a id="referralLink" href="#" class="mt-3 inline-block bg-orange-600 text-white px-3 py-1.5 rounded-full hover:bg-orange-700 text-sm"><i class="fas fa-share-alt mr-1"></i>Share Link</a>
        </div>
      </section>

      <section id="user-support" class="user-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-2xl font-bold text-orange-600">Support</h2>
          <button id="backFromSupport" class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded-full hover:bg-gray-300 text-sm"><i class="fas fa-arrow-left mr-1"></i>Back</button>
        </div>
        <button id="createTicketBtn" class="mb-3 bg-orange-600 text-white px-3 py-1.5 rounded-full hover:bg-orange-700 text-sm"><i class="fas fa-ticket-alt mr-1"></i>Create Ticket</button>
        <div class="bg-white rounded-lg p-3 shadow mb-3">
          <h3 class="text-base font-bold mb-1">Tickets</h3>
          <div id="supportTickets" class="space-y-3"></div>
        </div>
        <div class="bg-white rounded-lg p-3 shadow">
          <h3 class="text-base font-bold mb-1">Live Chat</h3>
          <div id="chatMessages" class="chat-container mb-3"></div>
          <div class="typing-indicator text-xs text-gray-500" id="typingIndicator"></div>
          <div class="flex gap-2">
            <input type="text" id="chatInput" class="flex-1 px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400 text-sm" placeholder="Type message..." aria-label="Chat message">
            <button id="sendChat" class="bg-orange-600 text-white px-3 py-1.5 rounded-full hover:bg-orange-700 text-sm"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>
      </section>

      <section id="user-faq" class="user-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-2xl font-bold text-orange-600">FAQ</h2>
          <button id="backFromFAQ" class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded-full hover:bg-gray-300 text-sm"><i class="fas fa-arrow-left mr-1"></i>Back</button>
        </div>
        <div class="bg-white rounded-lg p-3 shadow">
          <div id="faqItems" class="space-y-3"></div>
        </div>
      </section>

      <section id="user-profile" class="user-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-2xl font-bold text-orange-600">Your Profile</h2>
          <button id="backFromProfile" class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded-full hover:bg-gray-300 text-sm"><i class="fas fa-arrow-left mr-1"></i>Back</button>
        </div>
        <div class="bg-white rounded-lg p-3 shadow space-y-3">
          <div class="flex justify-center">
            <img src="https://via.placeholder.com/80" alt="Profile" id="profileImage" class="profile-img profile-img-upload rounded-full w-20 h-20 object-cover">
          </div>
          <div>
            <label class="block text-gray-700 text-sm">Upload Profile Image</label>
            <input type="file" id="profileImageInput" accept="image/*" class="w-full px-3 py-1.5 border rounded-full text-sm" required>
          </div>
          <div>
            <label class="block text-gray-700 text-sm">Name</label>
            <input type="text" id="profileName" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400 text-sm" readonly>
          </div>
          <div>
            <label class="block text-gray-700 text-sm">Email</label>
            <input type="email" id="profileEmail" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400 text-sm" readonly>
          </div>
          <div>
            <label class="block text-gray-700 text-sm">Phone</label>
            <input type="tel" id="profilePhone" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400 text-sm" readonly>
          </div>
          <button id="editProfileBtn" class="w-full bg-orange-600 text-white px-3 py-1.5 rounded-full hover:bg-orange-700 text-sm"><i class="fas fa-edit mr-1"></i>Edit Profile</button>
        </div>
      </section>
    </div>
  </div>

  <nav class="bottom-nav">
    <button data-section="dashboard" class="user-nav active"><i class="fas fa-home"></i><span>Home</span></button>
    <button data-section="menu" class="user-nav"><i class="fas fa-utensils"></i><span>Menu</span></button>
    <button data-section="cart" class="user-nav"><i class="fas fa-cart-shopping"></i><span>Cart</span></button>
    <button data-section="orders" class="user-nav"><i class="fas fa-shopping-bag"></i><span>Orders</span></button>
    <button data-section="profile" class="user-nav"><i class="fas fa-user"></i><span>Profile</span></button>
  </nav>

  <div id="toast" class="toast"></div>

  <div id="shareModal" class="share-modal">
    <div class="share-modal-content">
      <span class="close">×</span>
      <h3 class="text-base font-bold text-orange-600">Share DELICUTE!</h3>
      <div class="share-buttons flex flex-wrap gap-2 justify-center">
        <a href="#" id="shareWhatsApp" class="bg-green-500 text-white px-3 py-1.5 rounded-full hover:bg-green-600 text-sm"><i class="fab fa-whatsapp mr-1"></i>WhatsApp</a>
        <a href="#" id="shareTwitter" class="bg-blue-500 text-white px-3 py-1.5 rounded-full hover:bg-blue-600 text-sm"><i class="fab fa-twitter mr-1"></i>Twitter</a>
        <a href="#" id="shareFacebook" class="bg-blue-700 text-white px-3 py-1.5 rounded-full hover:bg-blue-800 text-sm"><i class="fab fa-facebook mr-1"></i>Facebook</a>
      </div>
    </div>
  </div>

  <script>
    // Mock Data
    const MOCK_DATA = {
      status: { isOpen: true, prepTime: 30 },
      offers: [
        { id: 1, title: '20% Off First Order', description: 'Use code FIRST20', code: 'FIRST20', discount: 20, image: 'https://images.unsplash.com/photo-1513106580091-1d82408b8cd6' },
        { id: 2, title: 'Free Delivery', description: 'On orders above ₹500', code: 'FREEDEL', discount: 10, image: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38' }
      ],
      menu: [
        { id: '1', name: 'Margherita Pizza', price: 250, description: 'Classic pizza with tomato and mozzarella', category: 'Vegetarian', image: 'https://images.unsplash.com/photo-1513106580091-1d82408b8cd6', is_popular: true },
        { id: '2', name: 'Butter Chicken', price: 350, description: 'Creamy chicken curry', category: 'Non-Veg', image: 'https://images.unsplash.com/photo-1603894584373-5ac82b2ae398', is_popular: true },
        { id: '3', name: 'Chocolate Lava Cake', price: 150, description: 'Warm cake with molten center', category: 'Desserts', image: 'https://images.unsplash.com/photo-1617303421954-0db7df940ce3', is_popular: false }
      ],
      cart: {
        items: [
          { id: '1', name: 'Margherita Pizza', price: 250, quantity: 2 },
          { id: '3', name: 'Chocolate Lava Cake', price: 150, quantity: 1 }
        ]
      },
      orders: [
        { id: 'ORD001', date: '2025-05-01', items: [{ name: 'Margherita Pizza' }, { name: 'Butter Chicken' }], total: 600, status: 'Delivered' },
        { id: 'ORD002', date: '2025-05-02', items: [{ name: 'Chocolate Lava Cake' }], total: 150, status: 'In Transit' }
      ],
      cancellationPolicy: { text: 'Cancel within 10 mins for full refund' },
      favourites: [
        { id: '1', name: 'Margherita Pizza', price: 250, description: 'Classic pizza', image: 'https://images.unsplash.com/photo-1513106580091-1d82408b8cd6' }
      ],
      addresses: [
        { id: '1', name: 'Home', street: '123 MG Road', city: 'Mumbai', state: 'MH', zip: '400001', mobile: '9876543210', isDefault: true },
        { id: '2', name: 'Office', street: '456 Corporate Park', city: 'Mumbai', state: 'MH', zip: '400002', mobile: '9876543211', isDefault: false }
      ],
      loyalty: {
        points: 150,
        history: [
          { description: 'Order #ORD001', points: 50, date: '2025-05-01' },
          { description: 'Referral Bonus', points: 100, date: '2025-05-02' }
        ]
      },
      referrals: { code: 'DEL123', link: 'https://delicute.com/refer/DEL123' },
      support: {
        tickets: [
          { id: 'TCK001', subject: 'Order Issue', status: 'Open', createdAt: '2025-05-01' }
        ],
        chat: [
          { sender: 'user', content: 'I have an issue with my order', timestamp: '2025-05-01T10:00:00Z' },
          { sender: 'admin', content: 'Please provide order ID', timestamp: '2025-05-01T10:01:00Z' }
        ]
      },
      profile: {
        id: 'USR001',
        name: 'John Doe',
        email: 'john.doe@example.com',
        phone: '9876543210',
        image: 'https://via.placeholder.com/96'
      }
    };

    // Static FAQ Data (Frontend Only)
    const STATIC_FAQ = [
      { question: 'How do I track my order?', answer: 'Visit the Orders section, select your order, and click Track to view real-time updates.' },
      { question: 'What is the cancellation policy?', answer: 'You can cancel within 10 minutes of placing the order for a full refund.' },
      { question: 'How do I apply a promo code?', answer: 'Enter the promo code in the cart section and click Apply to see the discount.' },
      { question: 'Can I change my delivery address?', answer: 'Yes, you can update your address in the Addresses section before checkout.' },
      { question: 'How do loyalty points work?', answer: 'Earn points on every order and redeem them for discounts in the Loyalty section.' }
    ];

    // State
    let state = {
      isLoggedIn: true,
      userId: null,
      navigationHistory: ['dashboard'],
      appliedCoupon: null,
      favourites: [],
      referral: { link: '' },
      profileImage: MOCK_DATA.profile.image,
      currentSection: 'dashboard'
    };

    // Utilities
    const showToast = (msg) => {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.display = 'block';
      toast.style.opacity = '1';
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.style.display = 'none', 300);
      }, 3000);
    };

    const triggerConfetti = () => confetti({
      particleCount: 100,
      spread: 70,
      origin: { y: 0.6 },
      colors: ['#f97316', '#fb923c', '#fff']
    });

    // Mock API Fetch
    const apiFetch = async (endpoint, method = 'GET', data = null) => {
      try {
        await new Promise(resolve => setTimeout(resolve, 500));
        if (endpoint === '/status') return MOCK_DATA.status;
        if (endpoint === '/offers') return MOCK_DATA.offers;
        if (endpoint.startsWith('/menu')) {
          const params = new URLSearchParams(endpoint.split('?')[1] || '');
          let items = MOCK_DATA.menu;
          const category = params.get('category');
          const price = params.get('price');
          const query = params.get('query')?.toLowerCase();
          if (category && category !== 'all') items = items.filter(i => i.category === category);
          if (price && price !== 'all') {
            const [min, max] = price.split('-').map(Number);
            items = items.filter(i => i.price >= min && (max ? i.price <= max : true));
          }
          if (query) items = items.filter(i => i.name.toLowerCase().includes(query));
          return items;
        }
        if (endpoint === '/cart') return MOCK_DATA.cart;
        if (endpoint === '/cart/apply-coupon') return { success: true, discount: data.code === 'FIRST20' ? 20 : 10 };
        if (endpoint === '/cart/add') {
          const existing = MOCK_DATA.cart.items.find(i => i.id === data.item.id);
          if (existing) existing.quantity += 1;
          else MOCK_DATA.cart.items.push(data.item);
          return { success: true };
        }
        if (endpoint === '/cart/update') {
          const item = MOCK_DATA.cart.items.find(i => i.id === data.itemId);
          if (item) {
            if (data.action === 'increase') item.quantity += 1;
            if (data.action === 'decrease' && item.quantity > 1) item.quantity -= 1;
          }
          return { success: true };
        }
        if (endpoint === '/cart/remove') {
          MOCK_DATA.cart.items = MOCK_DATA.cart.items.filter(i => i.id !== data.itemId);
          return { success: true };
        }
        if (endpoint === '/orders') return MOCK_DATA.orders;
        if (endpoint === '/cancellation-policy') return MOCK_DATA.cancellationPolicy;
        if (endpoint.startsWith('/orders/') && endpoint.endsWith('/track')) {
          const orderId = endpoint.split('/')[2];
          return { status: MOCK_DATA.orders.find(o => o.id === orderId)?.status, deliveryPartner: { name: 'Jane Doe', contact: '9876543212' } };
        }
        if (endpoint.startsWith('/orders/') && endpoint.endsWith('/reorder')) {
          MOCK_DATA.cart.items = MOCK_DATA.orders.find(o => o.id === endpoint.split('/')[2]).items.map(i => ({ ...i, id: '1', price: 250, quantity: 1 }));
          return { success: true };
        }
        if (endpoint.startsWith('/orders/') && endpoint.endsWith('/rate')) return { success: true };
        if (endpoint === '/favourites') return MOCK_DATA.favourites;
        if (endpoint === '/favourites/add') {
          MOCK_DATA.favourites.push(MOCK_DATA.menu.find(i => i.id === data.itemId));
          return { success: true };
        }
        if (endpoint === '/favourites/remove') {
          MOCK_DATA.favourites = MOCK_DATA.favourites.filter(f => f.id !== data.itemId);
          return { success: true };
        }
        if (endpoint === '/addresses') return MOCK_DATA.addresses;
        if (endpoint === '/addresses/add') {
          MOCK_DATA.addresses.push({ id: `ADD${MOCK_DATA.addresses.length + 1}`, ...data });
          return { success: true };
        }
        if (endpoint === '/addresses/update') {
          const index = MOCK_DATA.addresses.findIndex(a => a.id === data.id);
          MOCK_DATA.addresses[index] = { ...MOCK_DATA.addresses[index], ...data };
          return { success: true };
        }
        if (endpoint === '/addresses/delete') {
          MOCK_DATA.addresses = MOCK_DATA.addresses.filter(a => a.id !== data.id);
          return { success: true };
        }
        if (endpoint === '/addresses/set-default') {
          MOCK_DATA.addresses.forEach(a => a.isDefault = a.id === data.id);
          return { success: true };
        }
        if (endpoint === '/checkout') {
          MOCK_DATA.cart.items = [];
          MOCK_DATA.orders.push({
            id: `ORD00${MOCK_DATA.orders.length + 3}`,
            date: new Date().toISOString(),
            items: MOCK_DATA.cart.items,
            total: MOCK_DATA.cart.items.reduce((sum, i) => sum + i.price * i.quantity, 0),
            status: 'Confirmed'
          });
          return { success: true };
        }
        if (endpoint === '/loyalty') return MOCK_DATA.loyalty;
        if (endpoint === '/referrals') return MOCK_DATA.referrals;
        if (endpoint === '/support/tickets') return MOCK_DATA.support.tickets;
        if (endpoint === '/support/chat') return MOCK_DATA.support.chat;
        if (endpoint === '/support/chat/send') {
          MOCK_DATA.support.chat.push({ sender: 'user', content: data.message, timestamp: new Date().toISOString() });
          return { success: true };
        }
        if (endpoint === '/support/tickets/create') {
          MOCK_DATA.support.tickets.push({ id: `TCK00${MOCK_DATA.support.tickets.length + 2}`, ...data, status: 'Open', createdAt: new Date().toISOString() });
          return { success: true };
        }
        if (endpoint === '/profile') return MOCK_DATA.profile;
        if (endpoint === '/profile/update') {
          MOCK_DATA.profile = { ...MOCK_DATA.profile, ...data };
          return { success: true };
        }
        if (endpoint === '/profile/upload-image') {
          MOCK_DATA.profile.image = data.image;
          return { success: true, imageUrl: data.image };
        }
        if (endpoint === '/logout') return { success: true };
        throw new Error('Endpoint not found');
      } catch (err) {
        showToast(`Error: ${err.message}`);
        return null;
      }
    };

    // Sidebar Toggle
    const sidebar = document.getElementById('sidebar');
    const toggleSidebar = () => {
      sidebar.classList.toggle('sidebar-hidden');
      const isOpen = !sidebar.classList.contains('sidebar-hidden');
      document.querySelectorAll('.hamburger').forEach(h => h.classList.toggle('open', isOpen));
      document.body.style.overflow = isOpen && window.innerWidth < 1024 ? 'hidden' : 'auto';
      if (isOpen) sidebar.classList.add('animate-slideIn');
      else sidebar.classList.remove('animate-slideIn');
    };

    document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);

    document.addEventListener('click', (e) => {
      if (window.innerWidth < 1024 && !sidebar.contains(e.target) &&
          !e.target.closest('#sidebarToggle') &&
          !sidebar.classList.contains('sidebar-hidden')) {
        toggleSidebar();
      }
    });

    // Navigation
    const sections = document.querySelectorAll('.user-section');
    const navButtons = document.querySelectorAll('.user-nav');
    const showSection = (sectionId) => {
      if (state.currentSection === sectionId && sectionId !== 'dashboard') {
        sectionId = 'dashboard';
      }
      state.currentSection = sectionId;
      sections.forEach(s => s.classList.add('hidden'));
      const target = document.getElementById(`user-${sectionId}`);
      target.classList.remove('hidden');
      navButtons.forEach(b => b.classList.remove('active'));
      document.querySelectorAll(`[data-section="${sectionId}"]`).forEach(b => b.classList.add('active'));
      if (state.navigationHistory[state.navigationHistory.length - 1] !== sectionId) state.navigationHistory.push(sectionId);
      if (sectionId === 'menu') loadMenu();
      else if (sectionId === 'cart') loadCart();
      else if (sectionId === 'orders') loadOrders();
      else if (sectionId === 'favourites') loadFavourites();
      else if (sectionId === 'addresses') loadAddresses();
      else if (sectionId === 'loyalty') loadLoyalty();
      else if (sectionId === 'referrals') loadReferrals();
      else if (sectionId === 'support') loadSupport();
      else if (sectionId === 'faq') loadFAQ();
      else if (sectionId === 'profile') loadProfile();
      if (window.innerWidth < 1024) toggleSidebar();
    };

    navButtons.forEach(btn => btn.addEventListener('click', () => showSection(btn.dataset.section)));
    document.getElementById('cartSummary').addEventListener('click', () => showSection('cart'));
    document.getElementById('profileQuick').addEventListener('click', () => showSection('profile'));

    const goBack = () => {
      state.navigationHistory.pop();
      state.currentSection = state.navigationHistory[state.navigationHistory.length - 1] || 'dashboard';
      showSection(state.currentSection);
    };

    document.querySelectorAll('[id^="backFrom"]').forEach(btn => btn.addEventListener('click', goBack));

    // Logout
    const handleLogout = async () => {
      const data = await apiFetch('/logout', 'POST');
      if (data && data.success) {
        showToast('Logged out successfully');
        state.isLoggedIn = false;
        setTimeout(() => window.location.href = 'index.html', 1000);
      }
    };

    document.getElementById('logoutBtn').addEventListener('click', handleLogout);

    // Status Bar
    const loadStatusBar = async () => {
      const status = await apiFetch('/status');
      document.getElementById('statusBar').textContent = status ?
        `Restaurant: ${status.isOpen ? 'Open' : 'Closed'} | Prep: ${status.prepTime} mins` : 'Status unavailable';
    };

    // Banners
    const loadBanners = async () => {
      const offers = await apiFetch('/offers');
      const carousel = document.getElementById('banner1').parentElement;
      if (!offers || !offers.length) {
        carousel.innerHTML = `<div class="banner-item"><div class="banner-content"><p class="text-sm">No promotions available</p></div></div>`;
        return;
      }
      carousel.innerHTML = offers.map((o, i) => `
        <div id="banner${i}" class="banner-item ${i ? 'hidden' : ''}">
          <img src="${o.image}" alt="${o.title}" class="banner-image" loading="lazy" onerror="this.style.display='none'">
          <div class="banner-content">
            <h3 class="text-base font-bold">${o.title}</h3>
            <p class="text-xs">${o.description} | Code: ${o.code}</p>
            <button class="apply-banner-offer bg-orange-600 text-white px-3 py-1 rounded-full hover:bg-orange-700 text-sm" data-code="${o.code}" data-discount="${o.discount}">Claim</button>
          </div>
        </div>
      `).join('');
      initBannerCarousel();
    };

    const initBannerCarousel = () => {
      const items = document.querySelectorAll('.banner-item');
      let idx = 0;
      const showBanner = (i) => {
        items.forEach((item, j) => item.classList.toggle('hidden', i !== j));
      };
      document.getElementById('nextBanner').addEventListener('click', () => showBanner(idx = (idx + 1) % items.length));
      document.getElementById('prevBanner').addEventListener('click', () => showBanner(idx = (idx - 1 + items.length) % items.length));
      setInterval(() => showBanner(idx = (idx + 1) % items.length), 5000);
      document.querySelectorAll('.apply-banner-offer').forEach(btn => {
        btn.addEventListener('click', async () => {
          state.appliedCoupon = { code: btn.dataset.code, discount: parseFloat(btn.dataset.discount) };
          const data = await apiFetch('/cart/apply-coupon', 'POST', { code: state.appliedCoupon.code });
          if (data && data.success) {
            showToast(`Offer ${state.appliedCoupon.code} applied! ${state.appliedCoupon.discount}% off`);
            loadCart();
          }
        });
      });
    };

    // Offers
    const loadOffers = async () => {
      const offers = await apiFetch('/offers');
      if (!offers || !offers.length) {
        document.getElementById('applyOffer').classList.add('hidden');
        return;
      }
      const offer = offers[0];
      document.getElementById('applyOffer').addEventListener('click', async () => {
        state.appliedCoupon = { code: offer.code, discount: offer.discount };
        const data = await apiFetch('/cart/apply-coupon', 'POST', { code: offer.code });
        if (data && data.success) {
          showToast(`Offer ${offer.code} applied! ${offer.discount}% off`);
          loadCart();
        }
      });
    };

    // Menu
    const loadMenu = async (category = 'all', price = 'all', query = '') => {
      const params = new URLSearchParams({ category, price, query });
      const items = await apiFetch(`/menu?${params.toString()}`);
      const favouriteIds = state.favourites.map(f => f.id);
      const renderItem = item => `
        <div class="menu-item">
          <img src="${item.image}" alt="${item.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
          <div class="p-3">
            <h3 class="text-sm font-semibold">${item.name}</h3>
            <p class="text-gray-600 text-xs">₹${item.price}</p>
            <p class="text-xs text-gray-500">${item.description || 'No description'}</p>
            <div class="flex gap-2 mt-2">
              <button class="add-to-cart bg-orange-600 text-white px-3 py-1 rounded-full hover:bg-orange-700 text-xs" data-id="${item.id}" data-name="${item.name}" data-price="${item.price}"><i class="fas fa-cart-plus mr-1"></i>Add</button>
              <button class="toggle-favourite bg-gray-200 text-gray-800 px-3 py-1 rounded-full hover:bg-gray-300 text-xs" data-id="${item.id}"><i class="fas fa-heart ${favouriteIds.includes(item.id) ? 'text-red-500' : ''}"></i></button>
            </div>
          </div>
        </div>
      `;
      document.getElementById('menuItems').innerHTML = items?.length ? items.map(renderItem).join('') : '<p class="text-sm">No items found</p>';
      document.getElementById('menuPreview').innerHTML = items?.slice(0, 4).map(renderItem).join('') || '';
      document.getElementById('popular').innerHTML = items?.filter(i => i.is_popular).slice(0, 4).map(renderItem).join('') || '';
      VanillaTilt.init(document.querySelectorAll('.menu-item'), { max: 8, speed: 300 });
    };

    // Cart
    const loadCart = async () => {
      const cart = await apiFetch('/cart');
      const itemsEl = document.getElementById('cartItems');
      const subtotalEl = document.getElementById('cartSubtotal');
      const discountEl = document.getElementById('cartDiscount');
      const totalEl = document.getElementById('cartTotal');
      const countEl = document.getElementById('cartCount');
      const addressEl = document.getElementById('cartAddress');
      if (!cart || !cart.items?.length) {
        itemsEl.innerHTML = '<p class="text-sm">Cart is empty</p>';
        subtotalEl.textContent = '₹0';
        discountEl.textContent = '₹0';
        totalEl.textContent = '₹0';
        countEl.textContent = '0';
        addressEl.innerHTML = '<option value="">Select Address</option>';
        return;
      }
      const addresses = await apiFetch('/addresses') || [];
      addressEl.innerHTML = '<option value="">Select Address</option>' + addresses.map(a => `<option value="${a.id}" ${a.isDefault ? 'selected' : ''}>${a.name}: ${a.street}, ${a.city}</option>`).join('');
      const subtotal = cart.items.reduce((sum, i) => sum + (i.price * i.quantity), 0);
      const discount = state.appliedCoupon ? (subtotal * state.appliedCoupon.discount / 100) : 0;
      const total = subtotal - discount;
      itemsEl.innerHTML = cart.items.map(i => `
        <div class="flex justify-between items-center p-2 border-b">
          <div>
            <h4 class="text-sm font-semibold">${i.name}</h4>
            <p class="text-gray-600 text-xs">₹${i.price} x ${i.quantity}</p>
          </div>
          <div class="flex gap-2">
            <button class="update-cart bg-orange-600 text-white px-2 py-1 rounded-full hover:bg-orange-700 text-xs" data-id="${i.id}" data-action="decrease">-</button>
            <span class="text-xs">${i.quantity}</span>
            <button class="update-cart bg-orange-600 text-white px-2 py-1 rounded-full hover:bg-orange-700 text-xs" data-id="${i.id}" data-action="increase">+</button>
            <button class="remove-from-cart bg-red-600 text-white px-2 py-1 rounded-full hover:bg-red-700 text-xs" data-id="${i.id}"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      `).join('');
      subtotalEl.textContent = `₹${subtotal.toFixed(2)}`;
      discountEl.textContent = `₹${discount.toFixed(2)}`;
      totalEl.textContent = `₹${total.toFixed(2)}`;
      countEl.textContent = cart.items.reduce((sum, i) => sum + i.quantity, 0);
    };

    // Cart Actions
    document.addEventListener('click', async e => {
      const btn = e.target.closest('.add-to-cart, .update-cart, .remove-from-cart');
      if (!btn) return;
      const id = btn.dataset.id;
      if (btn.classList.contains('add-to-cart')) {
        const item = { id, name: btn.dataset.name, price: parseFloat(btn.dataset.price), quantity: 1 };
        const cart = await apiFetch('/cart');
        const existing = cart?.items.find(i => i.id === id);
        if (existing) {
          const data = await apiFetch('/cart/update', 'POST', { itemId: id, action: 'increase' });
          if (data && data.success) {
            showToast(`${item.name} quantity updated`);
            loadCart();
          }
        } else {
          const data = await apiFetch('/cart/add', 'POST', { item });
          if (data && data.success) {
            showToast(`${item.name} added to cart`);
            loadCart();
          }
        }
      } else if (btn.classList.contains('update-cart')) {
        const action = btn.dataset.action;
        const data = await apiFetch('/cart/update', 'POST', { itemId: id, action });
        if (data && data.success) {
          showToast('Cart updated');
          loadCart();
        }
      } else if (btn.classList.contains('remove-from-cart')) {
        const data = await apiFetch('/cart/remove', 'POST', { itemId: id });
        if (data && data.success) {
          showToast('Item removed');
          loadCart();
        }
      }
    });

    // Coupon
    document.getElementById('applyCoupon').addEventListener('click', async () => {
      const code = document.getElementById('couponCode').value.trim();
      if (!code) return showToast('Enter a promo code');
      const data = await apiFetch('/cart/apply-coupon', 'POST', { code });
      if (data && data.success) {
        state.appliedCoupon = { code, discount: data.discount };
        showToast(`Coupon ${code} applied! ${data.discount}% off`);
        loadCart();
      }
    });

    // Orders
    const loadOrders = async () => {
      const orders = await apiFetch('/orders');
      const policy = await apiFetch('/cancellation-policy');
      document.getElementById('cancellationPolicy').textContent = policy?.text || 'Cancel within 10 mins for full refund';
      document.getElementById('orderItems').innerHTML = orders?.length ? orders.map(o => `
        <tr>
          <td class="p-2">${o.id}</td>
          <td class="p-2">${new Date(o.date).toLocaleDateString()}</td>
          <td class="p-2">${o.items.map(i => i.name).join(', ')}</td>
          <td class="p-2">₹${o.total.toFixed(2)}</td>
          <td class="p-2">${o.status}</td>
          <td class="p-2 flex gap-2">
            <button class="track-order bg-orange-600 text-white px-2 py-1 rounded-full hover:bg-orange-700 text-xs" data-order-id="${o.id}"><i class="fas fa-map-marker-alt mr-1"></i>Track</button>
            <button class="reorder bg-blue-600 text-white px-2 py-1 rounded-full hover:bg-blue-700 text-xs" data-order-id="${o.id}"><i class="fas fa-redo mr-1"></i>Reorder</button>
            ${o.status === 'Delivered' ? `<button class="rate-order bg-green-600 text-white px-2 py-1 rounded-full hover:bg-green-700 text-xs" data-order-id="${o.id}"><i class="fas fa-star mr-1"></i>Rate</button>` : ''}
          </td>
        </tr>
      `).join('') : '<tr><td colspan="6" class="p-2 text-gray-600 text-sm">No orders</td></tr>';
    };

    // Order Actions
    document.addEventListener('click', async e => {
      const btn = e.target.closest('.track-order, .reorder, .rate-order');
      if (!btn) return;
      const orderId = btn.dataset.orderId;
      if (btn.classList.contains('track-order')) {
        const data = await apiFetch(`/orders/${orderId}/track`);
        if (data) {
          const modal = document.createElement('div');
          modal.className = 'share-modal active';
          modal.innerHTML = `
            <div class="share-modal-content">
              <span class="close">×</span>
              <h3 class="text-base">Track Order #${orderId}</h3>
              <div class="space-y-2 text-sm">
                <p>Status: ${data.status}</p>
                ${data.deliveryPartner ? `<p>Partner: ${data.deliveryPartner.name}</p><p>Contact: ${data.deliveryPartner.contact}</p>` : '<p>No delivery partner assigned</p>'}
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          modal.querySelector('.close').addEventListener('click', () => modal.remove());
        }
      } else if (btn.classList.contains('reorder')) {
        const data = await apiFetch(`/orders/${orderId}/reorder`, 'POST');
        if (data && data.success) {
          showToast('Items added to cart');
          loadCart();
          showSection('cart');
        }
      } else if (btn.classList.contains('rate-order')) {
        const modal = document.createElement('div');
        modal.className = 'share-modal active';
        modal.innerHTML = `
          <div class="share-modal-content">
            <span class="close">×</span>
            <h3 class="text-base">Rate Order #${orderId}</h3>
            <div class="space-y-3">
              <div class="flex justify-center gap-1">
                ${[1, 2, 3, 4, 5].map(i => `<i class="fas fa-star text-xl cursor-pointer" data-rating="${i}" style="color: ${i <= 3 ? '#f97316' : '#d1d5db'}"></i>`).join('')}
              </div>
              <textarea id="ratingComment" class="w-full px-3 py-1.5 border rounded-lg text-sm" rows="3" placeholder="Your feedback"></textarea>
              <button id="submitRating" class="w-full bg-orange-600 text-white px-3 py-1.5 rounded-full hover:bg-orange-700 text-sm">Submit</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        let rating = 3;
        modal.querySelectorAll('.fa-star').forEach(star => {
          star.addEventListener('click', () => {
            rating = parseInt(star.dataset.rating);
            modal.querySelectorAll('.fa-star').forEach(s => {
              s.style.color = parseInt(s.dataset.rating) <= rating ? '#f97316' : '#d1d5db';
            });
          });
        });
        modal.querySelector('.close').addEventListener('click', () => modal.remove());
        modal.querySelector('#submitRating').addEventListener('click', async () => {
          const comment = document.getElementById('ratingComment').value;
          if (!comment) return showToast('Please provide feedback');
          const data = await apiFetch(`/orders/${orderId}/rate`, 'POST', { rating, comment });
          if (data && data.success) {
            showToast('Rating submitted');
            modal.remove();
            loadOrders();
          }
        });
      }
    });

    // Favourites
    const loadFavourites = async () => {
      const favourites = await apiFetch('/favourites');
      state.favourites = favourites || [];
      const container = document.getElementById('favouritesItems');
      container.innerHTML = favourites?.length ? favourites.map(i => `
        <div class="menu-item">
          <img src="${i.image}" alt="${i.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
          <div class="p-3">
            <h3 class="text-sm font-semibold">${i.name}</h3>
            <p class="text-gray-600 text-xs">₹${i.price}</p>
            <p class="text-xs text-gray-500">${i.description || 'No description'}</p>
            <div class="flex gap-2 mt-2">
              <button class="add-to-cart bg-orange-600 text-white px-3 py-1 rounded-full hover:bg-orange-700 text-xs" data-id="${i.id}" data-name="${i.name}" data-price="${i.price}"><i class="fas fa-cart-plus mr-1"></i>Add</button>
              <button class="toggle-favourite bg-gray-200 text-gray-800 px-3 py-1 rounded-full hover:bg-gray-300 text-xs" data-id="${i.id}"><i class="fas fa-heart text-red-500"></i></button>
            </div>
          </div>
        </div>
      `).join('') : '<p class="text-sm">No favourite items</p>';
      VanillaTilt.init(document.querySelectorAll('.menu-item'), { max: 8, speed: 300 });
    };

    document.addEventListener('click', async e => {
      const btn = e.target.closest('.toggle-favourite');
      if (!btn) return;
      const id = btn.dataset.id;
      const isFavourite = state.favourites.some(f => f.id === id);
      const endpoint = isFavourite ? `/favourites/remove` : `/favourites/add`;
      const data = await apiFetch(endpoint, 'POST', { itemId: id });
      if (data && data.success) {
        if (isFavourite) {
          state.favourites = state.favourites.filter(f => f.id !== id);
          showToast('Removed from favourites');
        } else {
          const item = (await apiFetch('/menu')).find(i => i.id === id);
          state.favourites.push(item);
          showToast('Added to favourites');
        }
        if (!document.getElementById('user-favourites').classList.contains('hidden')) loadFavourites();
        btn.querySelector('i').classList.toggle('text-red-500');
      }
    });

    // Addresses
    const loadAddresses = async () => {
      const addresses = await apiFetch('/addresses');
      const container = document.getElementById('addressItems');
      container.innerHTML = addresses?.length ? addresses.map(a => `
        <div class="bg-white rounded-lg p-3 shadow flex justify-between items-start">
          <div>
            <h4 class="text-sm font-semibold">${a.name} ${a.isDefault ? '<span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full">Default</span>' : ''}</h4>
            <p class="text-xs text-gray-600">${a.street}, ${a.city}, ${a.state} ${a.zip}</p>
            <p class="text-xs text-gray-600">Mobile: ${a.mobile}</p>
          </div>
          <div class="flex gap-2">
            <button class="edit-address bg-orange-600 text-white px-2 py-1 rounded-full hover:bg-orange-700 text-xs" data-id="${a.id}"><i class="fas fa-edit"></i></button>
            <button class="delete-address bg-red-600 text-white px-2 py-1 rounded-full hover:bg-red-700 text-xs" data-id="${a.id}"><i class="fas fa-trash"></i></button>
            ${!a.isDefault ? `<button class="set-default-address bg-green-600 text-white px-2 py-1 rounded-full hover:bg-green-700 text-xs" data-id="${a.id}"><i class="fas fa-check"></i></button>` : ''}
          </div>
        </div>
      `).join('') : '<p class="text-sm">No addresses saved</p>';
    };

    // Address Actions
    document.getElementById('addAddress').addEventListener('click', () => {
      const modal = document.createElement('div');
      modal.className = 'share-modal active';
      modal.innerHTML = `
        <div class="share-modal-content">
          <span class="close">×</span>
          <h3 class="text-base font-bold text-orange-600">Add Address</h3>
          <form id="addressForm" class="space-y-3 text-sm">
            <div>
              <label class="block text-gray-700">Name</label>
              <input type="text" name="name" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400" required>
            </div>
            <div>
              <label class="block text-gray-700">Street</label>
              <input type="text" name="street" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400" required>
            </div>
            <div>
              <label class="block text-gray-700">City</label>
              <input type="text" name="city" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400" required>
            </div>
            <div>
              <label class="block text-gray-700">State</label>
              <input type="text" name="state" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400" required>
            </div>
            <div>
              <label class="block text-gray-700">ZIP Code</label>
              <input type="text" name="zip" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400" required>
            </div>
            <div>
              <label class="block text-gray-700">Mobile</label>
              <input type="tel" name="mobile" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400" required>
            </div>
            <button type="submit" class="w-full bg-orange-600 text-white px-3 py-1.5 rounded-full hover:bg-orange-700">Save</button>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      modal.querySelector('.close').addEventListener('click', () => modal.remove());
      modal.querySelector('#addressForm').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        const result = await apiFetch('/addresses/add', 'POST', data);
        if (result && result.success) {
          showToast('Address added');
          modal.remove();
          loadAddresses();
        }
      });
    });

    document.addEventListener('click', async e => {
      const btn = e.target.closest('.edit-address, .delete-address, .set-default-address');
      if (!btn) return;
      const id = btn.dataset.id;
      if (btn.classList.contains('edit-address')) {
        const address = (await apiFetch('/addresses')).find(a => a.id === id);
        const modal = document.createElement('div');
        modal.className = 'share-modal active';
        modal.innerHTML = `
          <div class="share-modal-content">
            <span class="close">×</span>
            <h3 class="text-base font-bold text-orange-600">Edit Address</h3>
            <form id="editAddressForm" class="space-y-3 text-sm">
              <input type="hidden" name="id" value="${id}">
              <div>
                <label class="block text-gray-700">Name</label>
                <input type="text" name="name" value="${address.name}" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400" required>
              </div>
              <div>
                <label class="block text-gray-700">Street</label>
                <input type="text" name="street" value="${address.street}" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400" required>
              </div>
              <div>
                <label class="block text-gray-700">City</label>
                <input type="text" name="city" value="${address.city}" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400" required>
              </div>
              <div>
                <label class="block text-gray-700">State</label>
                <input type="text" name="state" value="${address.state}" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400" required>
              </div>
              <div>
                <label class="block text-gray-700">ZIP Code</label>
                <input type="text" name="zip" value="${address.zip}" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400" required>
              </div>
              <div>
                <label class="block text-gray-700">Mobile</label>
                <input type="tel" name="mobile" value="${address.mobile}" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400" required>
              </div>
              <button type="submit" class="w-full bg-orange-600 text-white px-3 py-1.5 rounded-full hover:bg-orange-700">Save</button>
            </form>
          </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector('.close').addEventListener('click', () => modal.remove());
        modal.querySelector('#editAddressForm').addEventListener('submit', async e => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData);
          const result = await apiFetch('/addresses/update', 'POST', data);
          if (result && result.success) {
            showToast('Address updated');
            modal.remove();
            loadAddresses();
          }
        });
      } else if (btn.classList.contains('delete-address')) {
        if (confirm('Delete this address?')) {
          const data = await apiFetch('/addresses/delete', 'POST', { id });
          if (data && data.success) {
            showToast('Address deleted');
            loadAddresses();
          }
        }
      } else if (btn.classList.contains('set-default-address')) {
        const data = await apiFetch('/addresses/set-default', 'POST', { id });
        if (data && data.success) {
          showToast('Default address set');
          loadAddresses();
        }
      }
    });

    // Checkout
    document.getElementById('checkoutBtn').addEventListener('click', async () => {
      const addressId = document.getElementById('cartAddress').value;
      const paymentMethod = document.getElementById('paymentMethod').value;
      if (!addressId) return showToast('Select a delivery address');
      if (!paymentMethod) return showToast('Select a payment method');
      const cart = await apiFetch('/cart');
      if (!cart.items.length) return showToast('Cart is empty');
      const data = await apiFetch('/checkout', 'POST', { addressId, paymentMethod });
      if (data && data.success) {
        showToast('Order placed successfully');
        triggerConfetti();
        loadCart();
        loadOrders();
        showSection('orders');
      }
    });

    // Loyalty
    const loadLoyalty = async () => {
      const loyalty = await apiFetch('/loyalty');
      document.getElementById('loyaltyPoints').textContent = loyalty?.points || 0;
      document.getElementById('loyaltyHistory').innerHTML = loyalty?.history?.length ? loyalty.history.map(h => `
        <div class="border-b py-2 text-sm">
          <p>${h.description}</p>
          <p class="text-gray-600">Points: ${h.points} | ${new Date(h.date).toLocaleDateString()}</p>
        </div>
      `).join('') : '<p class="text-sm">No loyalty history</p>';
    };

    // Referrals
    const loadReferrals = async () => {
      const referrals = await apiFetch('/referrals');
      state.referral = referrals || { code: 'N/A', link: '#' };
      document.getElementById('referralCode').textContent = state.referral.code;
      document.getElementById('referralLink').href = state.referral.link;
      document.getElementById('shareWhatsApp').href = `https://wa.me/?text=Join DELICUTE with my code ${state.referral.code}! ${state.referral.link}`;
      document.getElementById('shareTwitter').href = `https://twitter.com/intent/tweet?text=Join DELICUTE with my code ${state.referral.code}! ${state.referral.link}`;
      document.getElementById('shareFacebook').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(state.referral.link)}`;
    };

    // Support
    const loadSupport = async () => {
      const tickets = await apiFetch('/support/tickets');
      const chat = await apiFetch('/support/chat');
      document.getElementById('supportTickets').innerHTML = tickets?.length ? tickets.map(t => `
        <div class="border-b py-2 text-sm">
          <p class="font-semibold">${t.subject}</p>
          <p class="text-gray-600">Status: ${t.status} | Created: ${new Date(t.createdAt).toLocaleDateString()}</p>
        </div>
      `).join('') : '<p class="text-sm">No tickets</p>';
      document.getElementById('chatMessages').innerHTML = chat?.length ? chat.map(m => `
        <div class="chat-message ${m.sender}">
          <p class="text-xs">${m.content}</p>
          <span class="text-xs text-gray-400">${new Date(m.timestamp).toLocaleString()}</span>
        </div>
      `).join('') : '<p class="text-sm">Start a conversation</p>';
      document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    };

    document.getElementById('createTicketBtn').addEventListener('click', () => {
      const modal = document.createElement('div');
      modal.className = 'share-modal active';
      modal.innerHTML = `
        <div class="share-modal-content">
          <span class="close">×</span>
          <h3 class="text-base font-bold text-orange-600">Create Support Ticket</h3>
          <form id="ticketForm" class="space-y-3 text-sm">
            <div>
              <label class="block text-gray-700">Subject</label>
              <input type="text" name="subject" class="w-full px-3 py-1.5 border rounded-full focus:outline-none focus:ring-2 focus:ring-orange-400" required>
            </div>
            <div>
              <label class="block text-gray-700">Description</label>
              <textarea name="description" class="w-full px-3 py-1.5 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400" rows="4" required></textarea>
            </div>
            <button type="submit" class="w-full bg-orange-600 text-white px-3 py-1.5 rounded-full hover:bg-orange-700">Submit</button>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      modal.querySelector('.close').addEventListener('click', () => modal.remove());
      modal.querySelector('#ticketForm').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        const result = await apiFetch('/support/tickets/create', 'POST', data);
        if (result && result.success) {
          showToast('Ticket created');
          modal.remove();
          loadSupport();
        }
      });
    });

    document.getElementById('sendChat').addEventListener('click', async () => {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return showToast('Enter a message');
      const data = await apiFetch('/support/chat/send', 'POST', { message });
      if (data && data.success) {
        input.value = '';
        loadSupport();
        // Simulate admin typing
        document.getElementById('typingIndicator').textContent = 'Admin is typing...';
        setTimeout(() => {
          document.getElementById('typingIndicator').textContent = '';
          MOCK_DATA.support.chat.push({
            sender: 'admin',
            content: 'Thank you for your message. How can we assist you further?',
            timestamp: new Date().toISOString()
          });
          loadSupport();
        }, 2000);
      }
    });

    // FAQ
    const loadFAQ = () => {
      document.getElementById('faqItems').innerHTML = STATIC_FAQ.map(f => `
        <div class="border-b py-2">
          <h4 class="text-sm font-semibold text-orange-600">${f.question}</h4>
          <p class="text-xs text-gray-600">${f.answer}</p>
        </div>
      `).join('');
    };
    // Profile
const loadProfile = async () => {
  const profile = await apiFetch('/profile');
  if (profile) {
    document.getElementById('profileName').value = profile.name;
    document.getElementById('profileEmail').value = profile.email;
    document.getElementById('profilePhone').value = profile.phone;
    document.getElementById('profileImage').src = profile.image || 'https://via.placeholder.com/80';
  }
};

document.getElementById('editProfileBtn').addEventListener('click', async () => {
  const inputs = document.querySelectorAll('#user-profile input:not(#profileImageInput)');
  const isEditable = inputs[0].hasAttribute('readonly');
  inputs.forEach(i => i.toggleAttribute('readonly', !isEditable));
  const btn = document.getElementById('editProfileBtn');
  btn.innerHTML = isEditable ? '<i class="fas fa-save mr-1"></i>Save Profile' : '<i class="fas fa-edit mr-1"></i>Edit Profile';
  if (!isEditable) {
    const data = {
      name: document.getElementById('profileName').value,
      email: document.getElementById('profileEmail').value,
      phone: document.getElementById('profilePhone').value
    };
    const result = await apiFetch('/profile/update', 'POST', data);
    if (result && result.success) {
      showToast('Profile updated');
      await loadProfile();
    } else {
      showToast('Failed to update profile');
    }
  }
});

document.getElementById('profileImageInput').addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file) return;
  if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
    showToast('Please upload a valid image (JPEG, PNG, or GIF)');
    return;
  }
  if (file.size > 5 * 1024 * 1024) {
    showToast('Image size must be less than 5MB');
    return;
  }
  const reader = new FileReader();
  reader.onload = async () => {
    const imageData = reader.result;
    try {
      const data = await apiFetch('/profile/upload-image', 'POST', { image: imageData });
      if (data && data.success) {
        document.getElementById('profileImage').src = data.imageUrl;
        MOCK_DATA.profile.image = data.imageUrl; // Update mock data
        showToast('Profile image updated');
        await loadProfile();
      } else {
        showToast('Failed to upload image');
      }
    } catch (err) {
      showToast('Error uploading image');
    }
  };
  reader.onerror = () => showToast('Error reading image file');
  reader.readAsDataURL(file);
});

    // Share Modal
    document.getElementById('shareBtn').addEventListener('click', () => {
      const modal = document.getElementById('shareModal');
      modal.classList.add('active');
    });

    document.getElementById('shareModal').addEventListener('click', e => {
      if (e.target.classList.contains('close') || e.target === document.getElementById('shareModal')) {
        document.getElementById('shareModal').classList.remove('active');
      }
    });

    // Filters
    const applyFilters = async (containerId, searchId, priceId, category = 'all') => {
      const query = document.getElementById(searchId)?.value.trim() || '';
      const price = document.getElementById(priceId)?.value || 'all';
      await loadMenu(category, price, query);
    };

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const section = btn.closest('#user-menu') ? 'menu' : 'dashboard';
        applyFilters(section === 'menu' ? 'menuItems' : 'menuPreview',
                    section === 'menu' ? 'menuSearch' : 'searchMenu',
                    section === 'menu' ? 'menuPriceFilter' : 'priceFilter',
                    btn.dataset.category);
      });
    });

    document.getElementById('priceFilter')?.addEventListener('change', () => {
      const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
      applyFilters('menuPreview', 'searchMenu', 'priceFilter', activeCategory);
    });

    document.getElementById('menuPriceFilter')?.addEventListener('change', () => {
      const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
      applyFilters('menuItems', 'menuSearch', 'menuPriceFilter', activeCategory);
    });

    document.getElementById('searchMenu')?.addEventListener('input', () => {
      const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
      applyFilters('menuPreview', 'searchMenu', 'priceFilter', activeCategory);
    });

    document.getElementById('menuSearch')?.addEventListener('input', () => {
      const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
      applyFilters('menuItems', 'menuSearch', 'menuPriceFilter', activeCategory);
    });

    // Particles
    const initParticles = () => {
      const canvas = document.querySelector('.particles');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.parentElement.offsetWidth;
      canvas.height = canvas.parentElement.offsetHeight;
      const particles = Array.from({ length: 50 }, () => ({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: Math.random() * 5 + 2,
        speedX: Math.random() * 1 - 0.5,
        speedY: Math.random() * 1 - 0.5
      }));
      const animate = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => {
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(249, 115, 22, 0.5)';
          ctx.fill();
          p.x += p.speedX;
          p.y += p.speedY;
          if (p.x < 0 || p.x > canvas.width) p.speedX *= -1;
          if (p.y < 0 || p.y > canvas.height) p.speedY *= -1;
        });
        requestAnimationFrame(animate);
      };
      animate();
    };

    // Initialize
    const init = async () => {
      await loadStatusBar();
      await loadBanners();
      await loadOffers();
      await loadMenu();
      await loadCart();
      initParticles();
      VanillaTilt.init(document.querySelectorAll('.menu-item'), { max: 8, speed: 300 });
      showSection('dashboard');
    };

    window.addEventListener('load', init);
  </script>
</body>
</html>