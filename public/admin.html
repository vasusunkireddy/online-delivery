<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="DELICUTE Admin Dashboard for restaurant management">
  <title>DELICUTE - Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/vanilla-tilt@1.7.0/dist/vanilla-tilt.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js" defer></script>
  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #ff6b00;
      --secondary: #ff8f33;
      --background: #fef3e7;
      --glass-bg: rgba(255, 255, 255, 0.95);
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      --accent: #34d399;
      --text-dark: #1a202c;
      --text-light: #ffffff;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes dropdown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, var(--background), #f8e7d4);
      color: var(--text-dark);
      margin: 0;
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
    }

    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: var(--shadow);
      border-radius: 16px;
      transition: all 0.3s ease;
    }

    .glass:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
    }

    .stunning-btn {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: var(--text-light);
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .stunning-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(255, 107, 0, 0.4);
      animation: pulse 0.5s infinite;
    }

    .back-btn {
      background: linear-gradient(45deg, #4b5563, #6b7280);
      color: var(--text-light);
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .dropdown-menu {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border-radius: 12px;
      box-shadow: var(--shadow);
      position: absolute;
      top: 60px;
      right: 20px;
      width: 220px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .dropdown-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      animation: dropdown 0.3s ease-out;
    }

    .dropdown-menu button {
      width: 100%;
      text-align: left;
      padding: 12px 16px;
      color: var(--text-dark);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.3s ease;
    }

    .dropdown-menu button:hover {
      background: var(--primary);
      color: var(--text-light);
    }

    .table-container {
      overflow-x: auto;
      max-height: 500px;
      background: #ffffff;
      border-radius: 16px;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) #e5e7eb;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    th, td {
      padding: 14px;
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: var(--text-light);
      position: sticky;
      top: 0;
      z-index: 10;
      font-weight: 600;
    }

    tbody tr:hover {
      background: #fff7ed;
      transform: scale(1.01);
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 14px 28px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      z-index: 2000;
      display: none;
      transition: opacity 0.3s ease;
    }

    .toast.success {
      background: #34d399;
      color: var(--text-light);
    }

    .toast.error {
      background: #ef4444;
      color: var(--text-light);
    }

    .toast.show {
      display: block;
      opacity: 1;
    }

    .modal-content {
      max-height: 90vh;
      overflow-y: auto;
      border-radius: 16px;
      padding: 20px;
      width: 90%;
      max-width: 450px;
      background: var(--glass-bg);
    }

    .chat-container {
      background: #ffffff;
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow);
      height: 450px;
      display: flex;
      flex-direction: column;
    }

    .chat-window {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
      background: #f9fafb;
      border-radius: 12px;
      margin-bottom: 14px;
    }

    .chat-message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
      max-width: 80%;
    }

    .chat-message.admin {
      background: var(--primary);
      color: var(--text-light);
      margin-left: auto;
    }

    .chat-message.user {
      background: #e5e7eb;
      color: var(--text-dark);
      margin-right: auto;
    }

    .profile-image {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary);
      transition: all 0.3s ease;
      position: relative;
      z-index: 1;
    }

    .profile-image:hover {
      transform: scale(1.1);
    }

    .menu-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid var(--primary);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .close-modal {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-dark);
    }

    @media (max-width: 1023px) {
      .main-content {
        margin-bottom: 70px;
      }
      .table-container td:before {
        content: attr(data-label);
        font-weight: 600;
        width: 40%;
        min-width: 100px;
      }
      .bottom-nav {
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        box-shadow: var(--shadow);
        z-index: 2000;
        padding: 10px 0;
        border-top: 1px solid rgba(255, 255, 255, 0.4);
      }
      .bottom-nav .nav-item {
        flex: 1;
        text-align: center;
        color: var(--text-dark);
        font-size: 0.8rem;
        padding: 10px 0;
        transition: all 0.3s ease;
      }
      .bottom-nav .nav-item.active {
        color: var(--primary);
        background: rgba(255, 107, 0, 0.1);
        border-bottom: 3px solid var(--primary);
        animation: pulse 0.5s infinite;
      }
      .bottom-nav .nav-item i {
        font-size: 1.2rem;
        margin-bottom: 4px;
      }
    }

    @media (min-width: 1024px) {
      .bottom-nav {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="preloader" class="fixed inset-0 bg-gradient-to-r from-orange-600 to-orange-700 flex items-center justify-center z-[3000] transition-opacity duration-500">
    <div class="border-6 border-white border-t-orange-600 rounded-full w-12 h-12 animate-spin"></div>
    <div class="ml-4 text-white text-2xl font-bold animate-pulse">DELICUTE Admin</div>
  </div>

  <div id="adminDashboard" class="hidden">
    <header class="bg-gradient-to-r from-orange-600 to-orange-700 text-white p-4 sticky top-0 z-30 shadow-lg">
      <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center gap-4">
          <img src="https://imgur.com/ZbhzFqT.png" alt="DELICUTE Logo" class="h-10" loading="lazy" onerror="this.src='https://via.placeholder.com/100.png?text=Logo+Not+Found'">
          <div class="text-2xl font-bold">DELICUTE</div>
        </div>
        <div class="relative flex items-center gap-2">
          <span id="welcomeNameHeader" class="text-lg font-semibold hidden md:block"></span>
          <button id="profileToggle" class="text-white hover:text-orange-200 transition-colors" aria-label="Toggle profile menu">
            <img id="profileImage" src="/assets/fallback-profile.png" alt="Admin Profile" class="profile-image" onerror="this.src='https://via.placeholder.com/100.png?text=Profile+Not+Found'">
          </button>
          <div id="dropdownMenu" class="dropdown-menu">
            <button data-section="dashboard" class="admin-nav"><i class="fas fa-home"></i> Dashboard</button>
            <button data-section="profile" class="admin-nav"><i class="fas fa-user"></i> Profile</button>
            <button data-section="orders" class="admin-nav"><i class="fas fa-shopping-cart"></i> Orders</button>
            <button data-section="customers" class="admin-nav"><i class="fas fa-users"></i> Customers</button>
            <button data-section="menu" class="admin-nav"><i class="fas fa-utensils"></i> Menu</button>
            <button data-section="support" class="admin-nav"><i class="fas fa-headset"></i> Support</button>
            <button data-section="promotions" class="admin-nav"><i class="fas fa-tag"></i> Promotions</button>
            <button data-section="feedback" class="admin-nav"><i class="fas fa-comment-alt"></i> Feedback</button>
            <button data-section="settings" class="admin-nav"><i class="fas fa-cog"></i> Settings</button>
            <button data-section="reports" class="admin-nav"><i class="fas fa-chart-bar"></i> Reports</button>
            <button id="logout" class="admin-nav text-red-600 hover:text-white"><i class="fas fa-sign-out-alt"></i> Logout</button>
          </div>
        </div>
      </div>
    </header>

    <div class="main-content p-6">
      <section id="admin-dashboard" class="admin-section animate-slideUp">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-3xl font-bold text-orange-600">Welcome, <span id="welcomeName">Admin</span>!</h2>
          <div id="countdownTimer" class="text-lg font-semibold text-gray-700"></div>
        </div>
        <div class="glass p-8 mb-8">
          <h2 class="text-3xl font-bold mb-4">Manage Seamlessly!</h2>
          <p class="text-lg mb-6">Run your restaurant with our powerful admin tools.</p>
          <div class="flex gap-4">
            <button data-section="orders" class="admin-nav stunning-btn"><i class="fas fa-shopping-cart"></i> Orders</button>
            <button data-section="menu" class="admin-nav stunning-btn bg-white text-orange-600 hover:bg-gray-100"><i class="fas fa-utensils"></i> Menu</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="glass p-6" data-tilt data-tilt-max="8">
            <h3 class="text-lg font-semibold flex items-center gap-3"><i class="fas fa-shopping-cart text-orange-600"></i> Total Orders</h3>
            <p class="text-3xl text-orange-600 font-bold" id="totalOrders">0</p>
          </div>
          <div class="glass p-6" data-tilt data-tilt-max="8">
            <h3 class="text-lg font-semibold flex items-center gap-3"><i class="fas fa-rupee-sign text-orange-600"></i> Total Sales</h3>
            <p class="text-3xl text-orange-600 font-bold" id="totalSales">₹0</p>
          </div>
          <div class="glass p-6" data-tilt data-tilt-max="8">
            <h3 class="text-lg font-semibold flex items-center gap-3"><i class="fas fa-users text-orange-600"></i> Active Customers</h3>
            <p class="text-3xl text-orange-600 font-bold" id="activeCustomers">0</p>
          </div>
          <div class="glass p-6" data-tilt data-tilt-max="8">
            <h3 class="text-lg font-semibold flex items-center gap-3"><i class="fas fa-undo text-orange-600"></i> Pending Refunds</h3>
            <p class="text-3xl text-orange-600 font-bold" id="pendingRefunds">0</p>
          </div>
        </div>
        <h3 class="text-3xl font-bold mb-6">Recent Orders</h3>
        <div class="table-container glass">
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Items</th>
                <th>Total</th>
                <th>Status</th>
                <th>Payment Method</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="recentOrders"></tbody>
          </table>
          <div class="pagination" id="recentOrdersPagination"></div>
        </div>
        <div class="mt-8 glass p-8">
          <h3 class="text-3xl font-bold mb-6">Sales Overview</h3>
          <canvas id="salesChart"></canvas>
        </div>
      </section>

      <section id="admin-profile" class="admin-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-6">
          <button class="back-btn" onclick="switchSection('dashboard')"><i class="fas fa-arrow-left"></i> Back</button>
          <h2 class="text-3xl font-bold text-orange-600">Profile</h2>
          <div></div>
        </div>
        <div class="glass p-8">
          <h3 class="text-2xl font-bold mb-6">Update Profile</h3>
          <div class="space-y-6">
            <div class="flex justify-center mb-6">
              <img id="profileImageEdit" src="/assets/fallback-profile.png" alt="Profile Image" class="w-32 h-32 rounded-full border-4 border-orange-600" onerror="this.src='https://via.placeholder.com/100.png?text=Profile+Not+Found'">
            </div>
            <div>
              <label for="profileImageInput" class="block font-medium mb-2">Profile Image</label>
              <input type="file" id="profileImageInput" accept="image/*" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
            </div>
            <div>
              <label for="profileName" class="block font-medium mb-2">Name</label>
              <input type="text" id="profileName" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
            </div>
            <div>
              <label for="profileEmail" class="block font-medium mb-2">Email</label>
              <input type="email" id="profileEmail" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
            </div>
            <button id="saveProfile" class="stunning-btn"><i class="fas fa-save"></i> Save Profile</button>
          </div>
        </div>
      </section>

      <section id="admin-orders" class="admin-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-6">
          <button class="back-btn" onclick="switchSection('dashboard')"><i class="fas fa-arrow-left"></i> Back</button>
          <h2 class="text-3xl font-bold text-orange-600">Orders</h2>
          <div></div>
        </div>
        <div class="table-container glass">
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Items</th>
                <th>Total</th>
                <th>Status</th>
                <th>Payment Method</th>
                <th>Order Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersList"></tbody>
          </table>
          <div class="pagination" id="ordersPagination"></div>
        </div>
      </section>

      <section id="admin-customers" class="admin-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-6">
          <button class="back-btn" onclick="switchSection('dashboard')"><i class="fas fa-arrow-left"></i> Back</button>
          <h2 class="text-3xl font-bold text-orange-600">Customers</h2>
          <div></div>
        </div>
        <div class="table-container glass">
          <table>
            <thead>
              <tr>
                <th>Customer ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Orders</th>
                <th>Loyalty Points</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customersList"></tbody>
          </table>
          <div class="pagination" id="customersPagination"></div>
        </div>
      </section>

      <section id="admin-menu" class="admin-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-6">
          <button class="back-btn" onclick="switchSection('dashboard')"><i class="fas fa-arrow-left"></i> Back</button>
          <h2 class="text-3xl font-bold text-orange-600">Menu</h2>
          <button id="addMenuItem" class="stunning-btn"><i class="fas fa-plus"></i> Add Item</button>
        </div>
        <div class="table-container glass">
          <table>
            <thead>
              <tr>
                <th>Image</th>
                <th>Name</th>
                <th>Category</th>
                <th>Price</th>
                <th>Description</th>
                <th>Availability</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="menuList"></tbody>
          </table>
          <div class="pagination" id="menuPagination"></div>
        </div>
      </section>

      <section id="admin-support" class="admin-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-6">
          <button class="back-btn" onclick="switchSection('dashboard')"><i class="fas fa-arrow-left"></i> Back</button>
          <h2 class="text-3xl font-bold text-orange-600">Support</h2>
          <div></div>
        </div>
        <div class="glass p-8 mb-8">
          <h3 class="text-2xl font-bold mb-6">Chat with Customers</h3>
          <div class="mb-4">
            <label for="chatUser" class="block font-medium mb-2">Select Customer</label>
            <select id="chatUser" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600"></select>
          </div>
          <div class="chat-container">
            <div class="chat-window" id="chatWindow"></div>
            <div class="flex gap-3">
              <input type="text" id="chatInput" class="flex-1 px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600" placeholder="Type a message...">
              <button id="sendMessage" class="stunning-btn"><i class="fas fa-paper-plane"></i> Send</button>
            </div>
          </div>
        </div>
      </section>

      <section id="admin-promotions" class="admin-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-6">
          <button class="back-btn" onclick="switchSection('dashboard')"><i class="fas fa-arrow-left"></i> Back</button>
          <h2 class="text-3xl font-bold text-orange-600">Promotions</h2>
          <button id="addPromotion" class="stunning-btn"><i class="fas fa-plus"></i> Add Promotion</button>
        </div>
        <div class="table-container glass">
          <table>
            <thead>
              <tr>
                <th>Image</th>
                <th>Title</th>
                <th>Code</th>
                <th>Discount</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="promotionsList"></tbody>
          </table>
          <div class="pagination" id="promotionsPagination"></div>
        </div>
      </section>

      <section id="admin-feedback" class="admin-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-6">
          <button class="back-btn" onclick="switchSection('dashboard')"><i class="fas fa-arrow-left"></i> Back</button>
          <h2 class="text-3xl font-bold text-orange-600">Feedback</h2>
          <div></div>
        </div>
        <div class="table-container glass">
          <table>
            <thead>
              <tr>
                <th>Feedback ID</th>
                <th>Customer</th>
                <th>Rating</th>
                <th>Comment</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="feedbackList"></tbody>
          </table>
          <div class="pagination" id="feedbackPagination"></div>
        </div>
      </section>

      <section id="admin-settings" class="admin-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-6">
          <button class="back-btn" onclick="switchSection('dashboard')"><i class="fas fa-arrow-left"></i> Back</button>
          <h2 class="text-3xl font-bold text-orange-600">Settings</h2>
          <div></div>
        </div>
        <div class="glass p-8 mb-8">
          <h3 class="text-3xl font-bold mb-6">Restaurant Status</h3>
          <div class="space-y-6">
            <div>
              <label for="restaurantStatus" class="block font-medium mb-2">Status</label>
              <select id="restaurantStatus" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
                <option value="open">Open</option>
                <option value="closed">Closed</option>
              </select>
            </div>
            <div>
              <label for="openTime" class="block font-medium mb-2">Open Time</label>
              <input type="time" id="openTime" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
            </div>
            <div>
              <label for="closeTime" class="block font-medium mb-2">Close Time</label>
              <input type="time" id="closeTime" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
            </div>
            <button id="saveRestaurantStatus" class="stunning-btn"><i class="fas fa-save"></i> Save</button>
          </div>
        </div>
        <div class="glass p-8">
          <h3 class="text-3xl font-bold mb-6">Loyalty Points</h3>
          <div class="space-y-6">
            <div>
              <label for="loyaltyUser" class="block font-medium mb-2">Select User</label>
              <select id="loyaltyUser" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600"></select>
            </div>
            <div>
              <label for="loyalUtPoints" class="block font-medium mb-2">Points</label>
              <input type="number" id="loyaltyPoints" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
            </div>
            <button id="assignLoyaltyPoints" class="stunning-btn"><i class="fas fa-gift"></i> Assign Points</button>
          </div>
        </div>
      </section>

      <section id="admin-reports" class="admin-section hidden animate-slideUp">
        <div class="flex justify-between items-center mb-6">
          <button class="back-btn" onclick="switchSection('dashboard')"><i class="fas fa-arrow-left"></i> Back</button>
          <h2 class="text-3xl font-bold text-orange-600">Reports</h2>
          <div></div>
        </div>
        <div class="glass p-8">
          <h3 class="text-3xl font-bold mb-6">Sales Report</h3>
          <canvas id="reportsChart"></canvas>
        </div>
      </section>
    </div>

    <div class="bottom-nav">
      <div class="nav-item admin-nav active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i><div>Dashboard</div></div>
      <div class="nav-item admin-nav" data-section="orders"><i class="fas fa-shopping-cart"></i><div>Orders</div></div>
      <div class="nav-item admin-nav" data-section="menu"><i class="fas fa-utensils"></i><div>Menu</div></div>
      <div class="nav-item admin-nav" data-section="support"><i class="fas fa-headset"></i><div>Support</div></div>
      <div class="nav-item admin-nav" data-section="settings"><i class="fas fa-cog"></i><div>Settings</div></div>
    </div>

    <div id="toast" class="toast" role="alert" aria-live="assertive"></div>

    <div id="addPromotionModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal('addPromotionModal')">&times;</span>
        <h3 class="text-2xl font-bold mb-6">Add Promotion</h3>
        <div class="space-y-6">
          <div>
            <label for="promoTitle" class="block font-medium mb-2">Title</label>
            <input type="text" id="promoTitle" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="promoCode" class="block font-medium mb-2">Promo Code</label>
            <input type="text" id="promoCode" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="promoDiscount" class="block font-medium mb-2">Discount (%)</label>
            <input type="number" id="promoDiscount" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="promoStartDate" class="block font-medium mb-2">Valid From</label>
            <input type="date" id="promoStartDate" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="promoEndDate" class="block font-medium mb-2">Valid Until</label>
            <input type="date" id="promoEndDate" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="promoImage" class="block font-medium mb-2">Image</label>
            <input type="file" id="promoImage" accept="image/*" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <button id="savePromotion" class="stunning-btn"><i class="fas fa-save"></i> Save Promotion</button>
        </div>
      </div>
    </div>

    <div id="editPromotionModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal('editPromotionModal')">&times;</span>
        <h3 class="text-2xl font-bold mb-6">Edit Promotion</h3>
        <div class="space-y-6">
          <div>
            <label for="editPromoTitle" class="block font-medium mb-2">Title</label>
            <input type="text" id="editPromoTitle" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="editPromoCode" class="block font-medium mb-2">Promo Code</label>
            <input type="text" id="editPromoCode" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="editPromoDiscount" class="block font-medium mb-2">Discount (%)</label>
            <input type="number" id="editPromoDiscount" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="editPromoStartDate" class="block font-medium mb-2">Valid From</label>
            <input type="date" id="editPromoStartDate" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="editPromoEndDate" class="block font-medium mb-2">Valid Until</label>
            <input type="date" id="editPromoEndDate" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="editPromoImage" class="block font-medium mb-2">Image</label>
            <input type="file" id="editPromoImage" accept="image/*" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <button id="updatePromotion" class="stunning-btn"><i class="fas fa-save"></i> Update Promotion</button>
        </div>
      </div>
    </div>

    <div id="addMenuItemModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal('addMenuItemModal')">&times;</span>
        <h3 class="text-2xl font-bold mb-6">Add Menu Item</h3>
        <div class="space-y-6">
          <div>
            <label for="menuImage" class="block font-medium mb-2">Image</label>
            <input type="file" id="menuImage" accept="image/*" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="menuName" class="block font-medium mb-2">Name</label>
            <input type="text" id="menuName" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="menuCategory" class="block font-medium mb-2">Category</label>
            <input type="text" id="menuCategory" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="menuPrice" class="block font-medium mb-2">Price (₹)</label>
            <input type="number" id="menuPrice" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="menuDescription" class="block font-medium mb-2">Description</label>
            <textarea id="menuDescription" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600" rows="3"></textarea>
          </div>
          <div>
            <label for="menuAvailable" class="block font-medium mb-2">Availability</label>
            <select id="menuAvailable" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          <button id="saveMenuItem" class="stunning-btn"><i class="fas fa-save"></i> Save Item</button>
        </div>
      </div>
    </div>

    <div id="editMenuItemModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal('editMenuItemModal')">&times;</span>
        <h3 class="text-2xl font-bold mb-6">Edit Menu Item</h3>
        <div class="space-y-6">
          <div>
            <label for="editMenuImage" class="block font-medium mb-2">Image</label>
            <input type="file" id="editMenuImage" accept="image/*" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="editMenuName" class="block font-medium mb-2">Name</label>
            <input type="text" id="editMenuName" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="editMenuCategory" class="block font-medium mb-2">Category</label>
            <input type="text" id="editMenuCategory" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="editMenuPrice" class="block font-medium mb-2">Price (₹)</label>
            <input type="number" id="editMenuPrice" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
          </div>
          <div>
            <label for="editMenuDescription" class="block font-medium mb-2">Description</label>
            <textarea id="editMenuDescription" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600" rows="3"></textarea>
          </div>
          <div>
            <label for="editMenuAvailable" class="block font-medium mb-2">Availability</label>
            <select id="editMenuAvailable" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          <button id="updateMenuItem" class="stunning-btn"><i class="fas fa-save"></i> Update Item</button>
        </div>
      </div>
    </div>

    <div id="refundModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal('refundModal')">&times;</span>
        <h3 class="text-2xl font-bold mb-6">Process Refund</h3>
        <div class="space-y-6">
          <div>
            <label for="refundAmount" class="block font-medium mb-2">Refund Amount (₹)</label>
            <input type="number" id="refundAmount" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600" readonly>
          </div>
          <div>
            <label for="refundReason" class="block font-medium mb-2">Reason for Refund</label>
            <textarea id="refundReason" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-orange-600" rows="3"></textarea>
          </div>
          <button id="processRefund" class="stunning-btn"><i class="fas fa-undo"></i> Process Refund</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CONFIG = {
      API_URL: 'http://localhost:3000/api',
      ITEMS_PER_PAGE: 8,
      SOCKET_URL: 'http://localhost:3000',
      FALLBACK_IMAGE: 'https://via.placeholder.com/100.png?text=Image+Not+Found'
    };

    const state = {
      currentPage: {
        orders: 1,
        customers: 1,
        menu: 1,
        promotions: 1,
        feedback: 1,
      },
      charts: {},
      isDropdownOpen: false,
      socket: io(CONFIG.SOCKET_URL, { transports: ['websocket'] }),
      currentChatUser: null,
      currentEditPromotion: null,
      currentEditMenuItem: null,
      currentRefundOrder: null,
    };

    // Utility Functions
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function triggerConfetti() {
      confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#ff6b00', '#ff8f33', '#34d399'] });
    }

    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input || '';
      return div.innerHTML;
    }

    function paginate(data, page, itemsPerPage) {
      const start = (page - 1) * itemsPerPage;
      return data.slice(start, start + itemsPerPage);
    }

    function renderPagination(containerId, totalItems, currentPage, onPageChange) {
      const totalPages = Math.ceil(totalItems / CONFIG.ITEMS_PER_PAGE);
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      const prevButton = document.createElement('button');
      prevButton.innerHTML = '<i class="fas fa-chevron-left"></i> Prev';
      prevButton.className = 'stunning-btn text-sm px-3 py-1';
      prevButton.disabled = currentPage === 1;
      prevButton.addEventListener('click', () => onPageChange(currentPage - 1));
      container.appendChild(prevButton);
      for (let i = 1; i <= totalPages; i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i;
        pageButton.className = 'stunning-btn text-sm px-3 py-1';
        pageButton.disabled = i === currentPage;
        pageButton.addEventListener('click', () => onPageChange(i));
        container.appendChild(pageButton);
      }
      const nextButton = document.createElement('button');
      nextButton.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
      nextButton.className = 'stunning-btn text-sm px-3 py-1';
      nextButton.disabled = currentPage === totalPages;
      nextButton.addEventListener('click', () => onPageChange(currentPage + 1));
      container.appendChild(nextButton);
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('show');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // API Client
    const api = {
      async fetchData(endpoint, method = 'GET', data = null, retries = 2) {
        for (let attempt = 1; attempt <= retries; attempt++) {
          try {
            const headers = {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`,
            };
            const options = { method, headers };
            if (data) options.body = JSON.stringify(data);
            const response = await fetch(`${CONFIG.API_URL}${endpoint}`, options);
            if (!response.ok) {
              if (response.status === 401) {
                showToast('Session expired. Please log in again.', 'error');
                localStorage.removeItem('jwtToken');
                window.location.href = '/index.html';
                return null;
              }
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return await response.json();
          } catch (err) {
            if (attempt === retries) {
              showToast(`Error: ${err.message}`, 'error');
              return null;
            }
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }
      },
      async uploadImage(endpoint, formData, retries = 2) {
        for (let attempt = 1; attempt <= retries; attempt++) {
          try {
            const response = await fetch(`${CONFIG.API_URL}${endpoint}`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${localStorage.getItem('jwtToken')}` },
              body: formData,
            });
            if (!response.ok) {
              if (response.status === 401) {
                showToast('Session expired. Please log in again.', 'error');
                localStorage.removeItem('jwtToken');
                window.location.href = '/index.html';
                return null;
              }
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const result = await response.json();
            if (!result.url) throw new Error('No image URL returned');
            return result;
          } catch (err) {
            if (attempt === retries) {
              showToast(`Image upload failed: ${err.message}`, 'error');
              return null;
            }
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }
      },
    };

    // Section Loaders
    async function loadDashboard() {
      const [profile, orders, customers] = await Promise.all([
        api.fetchData('/admin/profile'),
        api.fetchData('/orders'),
        api.fetchData('/users'),
      ]);

      if (!profile || !orders || !customers) return;

      document.getElementById('welcomeName').textContent = profile?.name || 'Admin';
      document.getElementById('welcomeNameHeader').textContent = profile?.name || 'Admin';
      document.getElementById('profileImage').src = profile?.image || CONFIG.FALLBACK_IMAGE;
      document.getElementById('totalOrders').textContent = orders?.length || 0;
      document.getElementById('totalSales').textContent = `₹${orders?.reduce((sum, o) => sum + (o.total || 0), 0).toLocaleString('en-IN') || 0}`;
      document.getElementById('activeCustomers').textContent = customers?.length || 0;
      document.getElementById('pendingRefunds').textContent = orders?.filter(o => o.status === 'cancelled' || o.status === 'refunded').length || 0;

      const paginatedOrders = paginate(orders || [], state.currentPage.orders, CONFIG.ITEMS_PER_PAGE);
      document.getElementById('recentOrders').innerHTML = paginatedOrders.map(order => {
        const customer = customers?.find(c => c.id === order.user_id) || { name: 'Unknown' };
        return `
          <tr>
            <td data-label="Order ID">#${order.id}</td>
            <td data-label="Customer">${sanitizeInput(customer.name)}</td>
            <td data-label="Items">${order.items?.length || 0}</td>
            <td data-label="Total">₹${order.total?.toLocaleString('en-IN') || 0}</td>
            <td data-label="Status">${sanitizeInput(order.status)}</td>
            <td data-label="Payment Method">${sanitizeInput(order.payment_method || 'N/A')}</td>
            <td data-label="Actions">
              <button class="stunning-btn text-sm px-3 py-1" data-action="view" data-id="${order.id}" aria-label="View order ${order.id}">
                <i class="fas fa-eye"></i> View
              </button>
              ${order.status === 'completed' && order.payment_method !== 'cash' ? `
                <button class="stunning-btn text-sm px-3 py-1 bg-yellow-600" data-action="refund" data-id="${order.id}" aria-label="Refund order ${order.id}">
                  <i class="fas fa-undo"></i> Refund
                </button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');

      renderPagination('recentOrdersPagination', orders?.length || 0, state.currentPage.orders, (page) => {
        state.currentPage.orders = page;
        loadDashboard();
      });

      const dates = [...new Set(orders?.map(o => new Date(o.created_at).toISOString().split('T')[0]) || [])].sort();
      const salesData = dates.map(date => orders?.filter(o => new Date(o.created_at).toISOString().split('T')[0] === date).reduce((sum, o) => sum + (o.total || 0), 0) || 0);
      const ctx = document.getElementById('salesChart').getContext('2d');
      if (state.charts.salesChart) state.charts.salesChart.destroy();
      state.charts.salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates.length ? dates : ['No Data'],
          datasets: [{
            label: 'Sales (₹)',
            data: salesData.length ? salesData : [0],
            borderColor: '#ff6b00',
            backgroundColor: 'rgba(255, 107, 0, 0.2)',
            fill: true,
            tension: 0.4,
          }],
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } },
      });
    }

    async function loadProfile() {
      const profile = await api.fetchData('/admin/profile');
      if (!profile) return;
      document.getElementById('profileImage').src = profile?.image || CONFIG.FALLBACK_IMAGE;
      document.getElementById('profileImageEdit').src = profile?.image || CONFIG.FALLBACK_IMAGE;
      document.getElementById('profileName').value = profile?.name || '';
      document.getElementById('profileEmail').value = profile?.email || '';
    }

    async function loadOrders() {
      const [orders, customers] = await Promise.all([
        api.fetchData('/orders'),
        api.fetchData('/users'),
      ]);

      if (!orders || !customers) return;

      const paginatedOrders = paginate(orders || [], state.currentPage.orders, CONFIG.ITEMS_PER_PAGE);
      document.getElementById('ordersList').innerHTML = paginatedOrders.map(order => {
        const customer = customers?.find(c => c.id === order.user_id) || { name: 'Unknown' };
        return `
          <tr>
            <td data-label="Order ID">#${order.id}</td>
            <td data-label="Customer">${sanitizeInput(customer.name)}</td>
            <td data-label="Items">${order.items?.length || 0}</td>
            <td data-label="Total">₹${order.total?.toLocaleString('en-IN') || 0}</td>
            <td data-label="Status">${sanitizeInput(order.status)}</td>
            <td data-label="Payment Method">${sanitizeInput(order.payment_method || 'N/A')}</td>
            <td data-label="Order Date">${new Date(order.created_at).toLocaleDateString()}</td>
            <td data-label="Actions">
              <button class="stunning-btn text-sm px-3 py-1" data-action="view" data-id="${order.id}" aria-label="View order ${order.id}">
                <i class="fas fa-eye"></i> View
              </button>
              ${order.status === 'completed' && order.payment_method !== 'cash' ? `
                <button class="stunning-btn text-sm px-3 py-1 bg-yellow-600" data-action="refund" data-id="${order.id}" aria-label="Refund order ${order.id}">
                  <i class="fas fa-undo"></i> Refund
                </button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');

      renderPagination('ordersPagination', orders?.length || 0, state.currentPage.orders, (page) => {
        state.currentPage.orders = page;
        loadOrders();
      });
    }

    async function loadCustomers() {
      const [customers, orders] = await Promise.all([
        api.fetchData('/users'),
        api.fetchData('/orders'),
      ]);

      if (!customers || !orders) return;

      const paginatedCustomers = paginate(customers || [], state.currentPage.customers, CONFIG.ITEMS_PER_PAGE);
      document.getElementById('customersList').innerHTML = paginatedCustomers.map(customer => {
        const customerOrders = orders?.filter(o => o.user_id === customer.id) || [];
        return `
          <tr>
            <td data-label="Customer ID">#${customer.id}</td>
            <td data-label="Name">${sanitizeInput(customer.name)}</td>
            <td data-label="Email">${sanitizeInput(customer.email)}</td>
            <td data-label="Phone">${sanitizeInput(customer.phone || 'N/A')}</td>
            <td data-label="Orders">${customerOrders.length}</td>
            <td data-label="Loyalty Points">${customer.loyalty_points || 0}</td>
            <td data-label="Actions">
              <button class="stunning-btn text-sm px-3 py-1" data-action="view" data-id="${customer.id}" aria-label="View customer ${customer.id}">
                <i class="fas fa-eye"></i> View
              </button>
            </td>
          </tr>
        `;
      }).join('');

      renderPagination('customersPagination', customers?.length || 0, state.currentPage.customers, (page) => {
        state.currentPage.customers = page;
        loadCustomers();
      });
    }

    async function loadMenu() {
      const menuItems = await api.fetchData('/menu');
      if (!menuItems) return;
      const paginatedMenu = paginate(menuItems || [], state.currentPage.menu, CONFIG.ITEMS_PER_PAGE);
      document.getElementById('menuList').innerHTML = paginatedMenu.map(item => `
        <tr>
          <td data-label="Image"><img src="${item.image || CONFIG.FALLBACK_IMAGE}" alt="${sanitizeInput(item.name)}" class="menu-image" onerror="this.src='${CONFIG.FALLBACK_IMAGE}'"></td>
          <td data-label="Name">${sanitizeInput(item.name)}</td>
          <td data-label="Category">${sanitizeInput(item.category)}</td>
          <td data-label="Price">₹${item.price?.toLocaleString('en-IN') || 0}</td>
          <td data-label="Description">${sanitizeInput(item.description)}</td>
          <td data-label="Availability">${item.available ? 'Yes' : 'No'}</td>
          <td data-label="Actions">
            <button class="stunning-btn text-sm px-3 py-1" data-action="edit" data-id="${item.id}" aria-label="Edit item ${item.id}">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="stunning-btn text-sm px-3 py-1 bg-red-600" data-action="delete" data-id="${item.id}" aria-label="Delete item ${item.id}">
              <i class="fas fa-trash"></i> Delete
            </button>
          </td>
        </tr>
      `).join('');

      renderPagination('menuPagination', menuItems?.length || 0, state.currentPage.menu, (page) => {
        state.currentPage.menu = page;
        loadMenu();
      });
    }

    async function loadSupport() {
      const users = await api.fetchData('/users');
      if (!users) return;
      const chatUserSelect = document.getElementById('chatUser');
      chatUserSelect.innerHTML = '<option value="">Select a customer</option>' + (users?.map(u => `<option value="${u.id}">${sanitizeInput(u.name)}</option>`) || []).join('');
    }

    async function loadChatMessages(userId) {
      const messages = await api.fetchData(`/chat/${userId}`);
      if (!messages) return;
      const chatWindow = document.getElementById('chatWindow');
      chatWindow.innerHTML = (messages || []).map(msg => `
        <div class="chat-message ${msg.sender === 'admin' ? 'admin' : 'user'}">
          <p>${sanitizeInput(msg.content)}</p>
          <small>${new Date(msg.created_at).toLocaleTimeString()}</small>
        </div>
      `).join('');
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function loadPromotions() {
      const promotions = await api.fetchData('/promotions');
      if (!promotions) return;
      const paginatedPromotions = paginate(promotions || [], state.currentPage.promotions, CONFIG.ITEMS_PER_PAGE);
      document.getElementById('promotionsList').innerHTML = paginatedPromotions.map(promo => `
        <tr>
          <td data-label="Image"><img src="${promo.image || CONFIG.FALLBACK_IMAGE}" alt="${sanitizeInput(promo.title)}" class="menu-image" onerror="this.src='${CONFIG.FALLBACK_IMAGE}'"></td>
          <td data-label="Title">${sanitizeInput(promo.title)}</td>
          <td data-label="Code">${sanitizeInput(promo.code)}</td>
          <td data-label="Discount">${promo.discount}%</td>
          <td data-label="Start Date">${new Date(promo.start_date).toLocaleDateString()}</td>
          <td data-label="End Date">${new Date(promo.end_date).toLocaleDateString()}</td>
          <td data-label="Actions">
            <button class="stunning-btn text-sm px-3 py-1" data-action="edit" data-id="${promo.id}" aria-label="Edit promotion ${promo.id}">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="stunning-btn text-sm px-3 py-1 bg-red-600" data-action="delete" data-id="${promo.id}" aria-label="Delete promotion ${promo.id}">
              <i class="fas fa-trash"></i> Delete
            </button>
          </td>
        </tr>
      `).join('');

      renderPagination('promotionsPagination', promotions?.length || 0, state.currentPage.promotions, (page) => {
        state.currentPage.promotions = page;
        loadPromotions();
      });
    }

    async function loadFeedback() {
      const [feedback, users] = await Promise.all([
        api.fetchData('/feedback'),
        api.fetchData('/users'),
      ]);

      if (!feedback || !users) return;

      const paginatedFeedback = paginate(feedback || [], state.currentPage.feedback, CONFIG.ITEMS_PER_PAGE);
      document.getElementById('feedbackList').innerHTML = paginatedFeedback.map(f => {
        const user = users?.find(u => u.id === f.user_id) || { name: 'Unknown' };
        return `
          <tr>
            <td data-label="Feedback ID">#${f.id}</td>
            <td data-label="Customer">${sanitizeInput(user.name)}</td>
            <td data-label="Rating">${f.rating}/5</td>
            <td data-label="Comment">${sanitizeInput(f.comment)}</td>
            <td data-label="Date">${new Date(f.created_at).toLocaleDateString()}</td>
            <td data-label="Actions">
              <button class="stunning-btn text-sm px-3 py-1" data-action="view" data-id="${f.id}" aria-label="View feedback ${f.id}">
                <i class="fas fa-eye"></i> View
              </button>
            </td>
          </tr>
        `;
      }).join('');

      renderPagination('feedbackPagination', feedback?.length || 0, state.currentPage.feedback, (page) => {
        state.currentPage.feedback = page;
        loadFeedback();
      });
    }

    async function loadSettings() {
      const [restaurantStatus, users] = await Promise.all([
        api.fetchData('/restaurant/status'),
        api.fetchData('/users'),
      ]);

      if (!restaurantStatus || !users) return;

      document.getElementById('restaurantStatus').value = restaurantStatus?.status || 'open';
      document.getElementById('openTime').value = restaurantStatus?.open_time || '';
      document.getElementById('closeTime').value = restaurantStatus?.close_time || '';

      const loyaltyUserSelect = document.getElementById('loyaltyUser');
      loyaltyUserSelect.innerHTML = '<option value="">Select a user</option>' + (users?.map(u => `<option value="${u.id}">${sanitizeInput(u.name)}</option>`) || []).join('');
    }

    async function loadReports() {
      const orders = await api.fetchData('/orders');
      if (!orders) return;
      const dates = [...new Set(orders?.map(o => new Date(o.created_at).toISOString().split('T')[0]) || [])].sort();
      const salesData = dates.map(date => orders?.filter(o => new Date(o.created_at).toISOString().split('T')[0] === date).reduce((sum, o) => sum + (o.total || 0), 0) || 0);
      const ctx = document.getElementById('reportsChart').getContext('2d');
      if (state.charts.reportsChart) state.charts.reportsChart.destroy();
      state.charts.reportsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dates.length ? dates : ['No Data'],
          datasets: [{
            label: 'Sales (₹)',
            data: salesData.length ? salesData : [0],
            backgroundColor: 'rgba(255, 107, 0, 0.6)',
            borderColor: '#ff6b00',
            borderWidth: 1,
          }],
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } },
      });
    }

    // Navigation
    function switchSection(sectionId) {
      document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
      document.getElementById(`admin-${sectionId}`).classList.remove('hidden');
      document.querySelectorAll('.admin-nav').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll(`.admin-nav[data-section="${sectionId}"]`).forEach(btn => btn.classList.add('active'));
      state.currentPage[sectionId] = 1;
      state.isDropdownOpen = false;
      document.getElementById('dropdownMenu').classList.remove('show');

      if (sectionId === 'dashboard') loadDashboard();
      if (sectionId === 'profile') loadProfile();
      if (sectionId === 'orders') loadOrders();
      if (sectionId === 'customers') loadCustomers();
      if (sectionId === 'menu') loadMenu();
      if (sectionId === 'support') loadSupport();
      if (sectionId === 'promotions') loadPromotions();
      if (sectionId === 'feedback') loadFeedback();
      if (sectionId === 'settings') loadSettings();
      if (sectionId === 'reports') loadReports();
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        document.getElementById('preloader').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('preloader').style.display = 'none';
          document.getElementById('adminDashboard').classList.remove('hidden');
          triggerConfetti();
        }, 500);
      }, 2000);

      state.socket.on('connect', () => {
        console.log('Socket.IO connected');
      });

      state.socket.on('connect_error', (err) => {
        showToast('Failed to connect to chat server', 'error');
        console.error('Socket.IO connection error:', err);
      });

      document.getElementById('profileToggle').addEventListener('click', () => {
        state.isDropdownOpen = !state.isDropdownOpen;
        document.getElementById('dropdownMenu').classList.toggle('show', state.isDropdownOpen);
      });

      document.querySelectorAll('.admin-nav').forEach(button => {
        button.addEventListener('click', () => {
          const section = button.getAttribute('data-section');
          if (section) switchSection(section);
        });
      });

      document.getElementById('logout').addEventListener('click', () => {
        localStorage.removeItem('jwtToken');
        showToast('Logged out successfully', 'success');
        setTimeout(() => {
          window.location.href = '/index.html';
        }, 1000);
      });

      document.getElementById('saveProfile').addEventListener('click', async () => {
        const name = document.getElementById('profileName').value.trim();
        const email = document.getElementById('profileEmail').value.trim();
        const imageInput = document.getElementById('profileImageInput').files[0];

        if (!name || !email) {
          showToast('Please fill in all fields', 'error');
          return;
        }

        const data = { name, email };
        if (imageInput) {
          const formData = new FormData();
          formData.append('image', imageInput);
          const uploadResult = await api.uploadImage('/upload/profile', formData);
          if (uploadResult) {
            data.image = uploadResult.url;
          } else {
            showToast('Failed to upload profile image', 'error');
            return;
          }
        }

        const result = await api.fetchData('/admin/profile', 'PUT', data);
        if (result) {
          document.getElementById('profileImage').src = data.image || CONFIG.FALLBACK_IMAGE;
          document.getElementById('profileImageEdit').src = data.image || CONFIG.FALLBACK_IMAGE;
          document.getElementById('welcomeName').textContent = name;
          document.getElementById('welcomeNameHeader').textContent = name;
          showToast('Profile updated successfully', 'success');
          triggerConfetti();
        }
      });

      document.getElementById('recentOrders').addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        const action = button.getAttribute('data-action');
        const id = button.getAttribute('data-id');
        if (action === 'view') {
          const order = await api.fetchData(`/orders/${id}`);
          if (order) {
            showToast(`Order #${id}: ₹${order.total}, Status: ${order.status}`, 'success');
          }
        } else if (action === 'refund') {
          state.currentRefundOrder = id;
          const order = await api.fetchData(`/orders/${id}`);
          if (order) {
            document.getElementById('refundAmount').value = order.total || 0;
            openModal('refundModal');
          }
        }
      });

      document.getElementById('ordersList').addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        const action = button.getAttribute('data-action');
        const id = button.getAttribute('data-id');
        if (action === 'view') {
          const order = await api.fetchData(`/orders/${id}`);
          if (order) {
            showToast(`Order #${id}: ₹${order.total}, Status: ${order.status}`, 'success');
          }
        } else if (action === 'refund') {
          state.currentRefundOrder = id;
          const order = await api.fetchData(`/orders/${id}`);
          if (order) {
            document.getElementById('refundAmount').value = order.total || 0;
            openModal('refundModal');
          }
        }
      });

      document.getElementById('processRefund').addEventListener('click', async () => {
        const reason = document.getElementById('refundReason').value.trim();
        if (!reason) {
          showToast('Please provide a reason for the refund', 'error');
          return;
        }
        const result = await api.fetchData(`/orders/${state.currentRefundOrder}/refund`, 'POST', { reason });
        if (result) {
          showToast('Refund processed successfully', 'success');
          closeModal('refundModal');
          loadOrders();
          loadDashboard();
          triggerConfetti();
        }
      });

      document.getElementById('customersList').addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        const id = button.getAttribute('data-id');
        const customer = await api.fetchData(`/users/${id}`);
        if (customer) {
          showToast(`Customer: ${customer.name}, Email: ${customer.email}`, 'success');
        }
      });

      document.getElementById('menuList').addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        const action = button.getAttribute('data-action');
        const id = button.getAttribute('data-id');
        if (action === 'edit') {
          try {
            const item = await api.fetchData(`/menu/${id}`);
            if (item) {
              state.currentEditMenuItem = id;
              document.getElementById('editMenuName').value = item.name || '';
              document.getElementById('editMenuCategory').value = item.category || '';
              document.getElementById('editMenuPrice').value = item.price || 0;
              document.getElementById('editMenuDescription').value = item.description || '';
              document.getElementById('editMenuAvailable').value = item.available ? 'true' : 'false';
              document.getElementById('editMenuImage').value = ''; // Reset file input
              openModal('editMenuItemModal');
            } else {
              showToast('Failed to load menu item', 'error');
            }
          } catch (err) {
            showToast(`Error loading menu item: ${err.message}`, 'error');
          }
        } else if (action === 'delete') {
          if (confirm('Are you sure you want to delete this menu item?')) {
            try {
              const result = await api.fetchData(`/menu/${id}`, 'DELETE');
              if (result) {
                showToast('Menu item deleted successfully', 'success');
                loadMenu();
              } else {
                showToast('Failed to delete menu item', 'error');
              }
            } catch (err) {
              showToast(`Error deleting menu item: ${err.message}`, 'error');
            }
          }
        }
      });

      
      document.getElementById('addMenuItem').addEventListener('click', () => {
        document.getElementById('menuImage').value = '';
        document.getElementById('menuName').value = '';
        document.getElementById('menuCategory').value = '';
        document.getElementById('menuPrice').value = '';
        document.getElementById('menuDescription').value = '';
        document.getElementById('menuAvailable').value = 'true';
        openModal('addMenuItemModal');
      });

      document.getElementById('saveMenuItem').addEventListener('click', async () => {
        const imageInput = document.getElementById('menuImage').files[0];
        const name = document.getElementById('menuName').value.trim();
        const category = document.getElementById('menuCategory').value.trim();
        const price = parseFloat(document.getElementById('menuPrice').value);
        const description = document.getElementById('menuDescription').value.trim();
        const available = document.getElementById('menuAvailable').value === 'true';

        if (!name || !category || isNaN(price) || price <= 0) {
          showToast('Please fill in all required fields with valid values', 'error');
          return;
        }

        const data = { name, category, price, description, available };
        if (imageInput) {
          const formData = new FormData();
          formData.append('image', imageInput);
          const uploadResult = await api.uploadImage('/upload/menu', formData);
          if (uploadResult) {
            data.image = uploadResult.url;
          } else {
            showToast('Failed to upload menu image', 'error');
            return;
          }
        }

        const result = await api.fetchData('/menu', 'POST', data);
        if (result) {
          showToast('Menu item added successfully', 'success');
          closeModal('addMenuItemModal');
          loadMenu();
          triggerConfetti();
        }
      });

      document.getElementById('updateMenuItem').addEventListener('click', async () => {
        const imageInput = document.getElementById('editMenuImage').files[0];
        const name = document.getElementById('editMenuName').value.trim();
        const category = document.getElementById('editMenuCategory').value.trim();
        const price = parseFloat(document.getElementById('editMenuPrice').value);
        const description = document.getElementById('editMenuDescription').value.trim();
        const available = document.getElementById('editMenuAvailable').value === 'true';

        if (!name || !category || isNaN(price) || price <= 0) {
          showToast('Please fill in all required fields with valid values', 'error');
          return;
        }

        const data = { name, category, price, description, available };
        if (imageInput) {
          const formData = new FormData();
          formData.append('image', imageInput);
          const uploadResult = await api.uploadImage('/upload/menu', formData);
          if (uploadResult) {
            data.image = uploadResult.url;
          } else {
            showToast('Failed to upload menu image', 'error');
            return;
          }
        }

        const result = await api.fetchData(`/menu/${state.currentEditMenuItem}`, 'PUT', data);
        if (result) {
          showToast('Menu item updated successfully', 'success');
          closeModal('editMenuItemModal');
          state.currentEditMenuItem = null;
          loadMenu();
          triggerConfetti();
        }
      });

      document.getElementById('chatUser').addEventListener('change', async (e) => {
        const userId = e.target.value;
        state.currentChatUser = userId || null;
        document.getElementById('chatInput').disabled = !userId;
        document.getElementById('sendMessage').disabled = !userId;
        document.getElementById('chatWindow').innerHTML = '';
        if (userId) {
          await loadChatMessages(userId);
          state.socket.emit('joinChat', userId);
        }
      });

      document.getElementById('sendMessage').addEventListener('click', async () => {
        const message = document.getElementById('chatInput').value.trim();
        if (!message || !state.currentChatUser) {
          showToast('Please select a user and enter a message', 'error');
          return;
        }

        const data = { content: message, userId: state.currentChatUser };
        const result = await api.fetchData(`/chat/${state.currentChatUser}`, 'POST', data);
        if (result) {
          state.socket.emit('chatMessage', {
            userId: state.currentChatUser,
            content: message,
            sender: 'admin',
            created_at: new Date().toISOString(),
          });
          document.getElementById('chatInput').value = '';
          const chatWindow = document.getElementById('chatWindow');
          chatWindow.innerHTML += `
            <div class="chat-message admin">
              <p>${sanitizeInput(message)}</p>
              <small>${new Date().toLocaleTimeString()}</small>
            </div>
          `;
          chatWindow.scrollTop = chatWindow.scrollHeight;
        }
      });

      state.socket.on('chatMessage', (msg) => {
        if (msg.userId === state.currentChatUser) {
          const chatWindow = document.getElementById('chatWindow');
          chatWindow.innerHTML += `
            <div class="chat-message ${msg.sender === 'admin' ? 'admin' : 'user'}">
              <p>${sanitizeInput(msg.content)}</p>
              <small>${new Date(msg.created_at).toLocaleTimeString()}</small>
            </div>
          `;
          chatWindow.scrollTop = chatWindow.scrollHeight;
        }
      });

      document.getElementById('addPromotion').addEventListener('click', () => {
        document.getElementById('promoTitle').value = '';
        document.getElementById('promoCode').value = '';
        document.getElementById('promoDiscount').value = '';
        document.getElementById('promoStartDate').value = '';
        document.getElementById('promoEndDate').value = '';
        document.getElementById('promoImage').value = '';
        openModal('addPromotionModal');
      });

      document.getElementById('savePromotion').addEventListener('click', async () => {
        const title = document.getElementById('promoTitle').value.trim();
        const code = document.getElementById('promoCode').value.trim();
        const discount = parseInt(document.getElementById('promoDiscount').value);
        const startDate = document.getElementById('promoStartDate').value;
        const endDate = document.getElementById('promoEndDate').value;
        const imageInput = document.getElementById('promoImage').files[0];

        if (!title || !code || isNaN(discount) || discount <= 0 || !startDate || !endDate) {
          showToast('Please fill in all required fields with valid values', 'error');
          return;
        }

        const data = { title, code, discount, start_date: startDate, end_date: endDate };
        if (imageInput) {
          const formData = new FormData();
          formData.append('image', imageInput);
          const uploadResult = await api.uploadImage('/upload/promotion', formData);
          if (uploadResult) {
            data.image = uploadResult.url;
          } else {
            showToast('Failed to upload promotion image', 'error');
            return;
          }
        }

        const result = await api.fetchData('/promotions', 'POST', data);
        if (result) {
          showToast('Promotion added successfully', 'success');
          closeModal('addPromotionModal');
          loadPromotions();
          triggerConfetti();
        }
      });

      document.getElementById('promotionsList').addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        const action = button.getAttribute('data-action');
        const id = button.getAttribute('data-id');
        if (action === 'edit') {
          const promo = await api.fetchData(`/promotions/${id}`);
          if (promo) {
            state.currentEditPromotion = id;
            document.getElementById('editPromoTitle').value = promo.title || '';
            document.getElementById('editPromoCode').value = promo.code || '';
            document.getElementById('editPromoDiscount').value = promo.discount || 0;
            document.getElementById('editPromoStartDate').value = promo.start_date ? new Date(promo.start_date).toISOString().split('T')[0] : '';
            document.getElementById('editPromoEndDate').value = promo.end_date ? new Date(promo.end_date).toISOString().split('T')[0] : '';
            document.getElementById('editPromoImage').value = '';
            openModal('editPromotionModal');
          }
        } else if (action === 'delete') {
          if (confirm('Are you sure you want to delete this promotion?')) {
            const result = await api.fetchData(`/promotions/${id}`, 'DELETE');
            if (result) {
              showToast('Promotion deleted successfully', 'success');
              loadPromotions();
            }
          }
        }
      });

      document.getElementById('updatePromotion').addEventListener('click', async () => {
        const title = document.getElementById('editPromoTitle').value.trim();
        const code = document.getElementById('editPromoCode').value.trim();
        const discount = parseInt(document.getElementById('editPromoDiscount').value);
        const startDate = document.getElementById('editPromoStartDate').value;
        const endDate = document.getElementById('editPromoEndDate').value;
        const imageInput = document.getElementById('editPromoImage').files[0];

        if (!title || !code || isNaN(discount) || discount <= 0 || !startDate || !endDate) {
          showToast('Please fill in all required fields with valid values', 'error');
          return;
        }

        const data = { title, code, discount, start_date: startDate, end_date: endDate };
        if (imageInput) {
          const formData = new FormData();
          formData.append('image', imageInput);
          const uploadResult = await api.uploadImage('/upload/promotion', formData);
          if (uploadResult) {
            data.image = uploadResult.url;
          } else {
            showToast('Failed to upload promotion image', 'error');
            return;
          }
        }

        const result = await api.fetchData(`/promotions/${state.currentEditPromotion}`, 'PUT', data);
        if (result) {
          showToast('Promotion updated successfully', 'success');
          closeModal('editPromotionModal');
          state.currentEditPromotion = null;
          loadPromotions();
          triggerConfetti();
        }
      });

      document.getElementById('feedbackList').addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        const id = button.getAttribute('data-id');
        const feedback = await api.fetchData(`/feedback/${id}`);
        if (feedback) {
          showToast(`Feedback: ${feedback.comment}, Rating: ${feedback.rating}/5`, 'success');
        }
      });

      document.getElementById('saveRestaurantStatus').addEventListener('click', async () => {
        const status = document.getElementById('restaurantStatus').value;
        const openTime = document.getElementById('openTime').value;
        const closeTime = document.getElementById('closeTime').value;

        if (!status || !openTime || !closeTime) {
          showToast('Please fill in all fields', 'error');
          return;
        }

        const data = { status, open_time: openTime, close_time: closeTime };
        const result = await api.fetchData('/restaurant/status', 'PUT', data);
        if (result) {
          showToast('Restaurant status updated successfully', 'success');
          triggerConfetti();
        }
      });

      document.getElementById('assignLoyaltyPoints').addEventListener('click', async () => {
        const userId = document.getElementById('loyaltyUser').value;
        const points = parseInt(document.getElementById('loyaltyPoints').value);

        if (!userId || isNaN(points) || points <= 0) {
          showToast('Please select a user and enter valid points', 'error');
          return;
        }

        const result = await api.fetchData(`/users/${userId}/loyalty`, 'PUT', { points });
        if (result) {
          showToast('Loyalty points assigned successfully', 'success');
          document.getElementById('loyaltyPoints').value = '';
          document.getElementById('loyaltyUser').value = '';
          triggerConfetti();
        }
      });

      // Initialize
      if (!localStorage.getItem('jwtToken')) {
        window.location.href = '/index.html';
      } else {
        switchSection('dashboard');
      }
    });
  </script>
</body>
</html>